/*
Navicat MySQL Data Transfer

Source Server         : localhost_3306
Source Server Version : 50718
Source Host           : localhost:3306
Source Database       : article_spider

Target Server Type    : MYSQL
Target Server Version : 50718
File Encoding         : 65001

Date: 2017-07-08 20:28:55
*/

SET FOREIGN_KEY_CHECKS=0;

-- ----------------------------
-- Table structure for jobbole_article
-- ----------------------------
DROP TABLE IF EXISTS `jobbole_article`;
CREATE TABLE `jobbole_article` (
  `title` varchar(200) NOT NULL,
  `create_date` date DEFAULT NULL,
  `url` varchar(300) NOT NULL,
  `url_object_id` varchar(50) NOT NULL,
  `front_image_url` varchar(300) DEFAULT NULL,
  `front_image_path` varchar(200) DEFAULT NULL,
  `comments_num` int(11) NOT NULL DEFAULT '0',
  `fav_num` int(11) NOT NULL DEFAULT '0',
  `praise_num` int(11) NOT NULL DEFAULT '0',
  `tags` varchar(200) DEFAULT NULL,
  `content` longtext NOT NULL,
  PRIMARY KEY (`url_object_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of jobbole_article
-- ----------------------------
INSERT INTO `jobbole_article` VALUES ('数据结构中各种树', '2017-07-08', 'http://blog.jobbole.com/111680/', '02798e0da54694b76c5f84ea9e994105', 'http://jbcdn2.b0.upaiyun.com/2017/07/bc42d6b7087d92bf57edac612206395f.jpg', 'full/6032d7dc1233f95d17343e58eeaff17e6a49cb23.jpg', '2', '3', '1', 'IT技术,,数据结构,树', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/maybe2030/p/4732377.html\">Poll的笔记</a>   </div><p>数据结构中有很多树的结构，其中包括二叉树、二叉搜索树、2-3树、红黑树等等。本文中对数据结构中常见的几种树的概念和用途进行了汇总，不求严格精准，但求简单易懂。</p>\n<h1 class=\"First\"><strong>1. 二叉树</strong></h1>\n<p>二叉树是数据结构中一种重要的数据结构，也是树表家族最为基础的结构。</p>\n<p><strong>二叉树的定义：</strong>二叉树的每个结点至多只有二棵子树(不存在度大于2的结点)，二叉树的子树有左右之分，次序不能颠倒。二叉树的第i层至多有2<sup>i-1</sup>个结点；深度为k的二叉树至多有2<sup>k-1</sup>个结点；对任何一棵二叉树T，如果其终端结点数为n<sub>0</sub>，度为2的结点数为n<sub>2</sub>，则n<sub>0</sub>=n<sub>2</sub>+1。</p>\n<p><strong>二叉树的示例</strong>：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/bc42d6b7087d92bf57edac612206395f.jpg\"><img class=\"aligncenter wp-image-111682 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/bc42d6b7087d92bf57edac612206395f.jpg\" alt=\"2009050402\" width=\"390\" height=\"312\"></a></p>\n<p><strong>满二叉树和完全二叉树：</strong></p>\n<p>满二叉树：除最后一层无任何子节点外，每一层上的所有结点都有两个子结点。也可以这样理解，除叶子结点外的所有结点均有两个子结点。节点数达到最大值，所有叶子结点必须在同一层上。</p>\n<p>满二叉树的性质：</p>\n<p>1) 一颗树深度为h，最大层数为k，深度与最大层数相同，k=h;</p>\n<p>2) 叶子数为2<sup>h</sup>;</p>\n<p>3) 第k层的结点数是：2<sup>k-1</sup>;</p>\n<p>4) 总结点数是：2<sup>k-1</sup>，且总节点数一定是奇数。</p>\n<p>完全二叉树：若设二叉树的深度为h，除第 h 层外，其它各层 (1～(h-1)层) 的结点数都达到最大个数，第h层所有的结点都连续集中在最左边，这就是完全二叉树。</p>\n<p><strong>注：</strong>完全二叉树是效率很高的数据结构，堆是一种完全二叉树或者近似完全二叉树，所以效率极高，像十分常用的排序算法、Dijkstra算法、Prim算法等都要用堆才能优化，二叉排序树的效率也要借助平衡性来提高，而平衡性基于完全二叉树。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/a5952ec741b60202c7b377bfb8e8f368.png\"><img class=\"aligncenter wp-image-111683 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/a5952ec741b60202c7b377bfb8e8f368.png\" alt=\"141749056837546\" width=\"534\" height=\"180\"></a></p>\n<p><strong>二叉树的性质</strong>：</p>\n<p>1) 在非空二叉树中，第i层的结点总数不超过2<sup>i-1</sup>, i&gt;=1;</p>\n<p>2) 深度为h的二叉树最多有2<sup>h</sup>-1个结点(h&gt;=1)，最少有h个结点;</p>\n<p>3) 对于任意一棵二叉树，如果其叶结点数为N<sub>0</sub>，而度数为2的结点总数为N<sub>2</sub>，则N<sub>0</sub>=N<sub>2</sub>+1;</p>\n<p>4) 具有n个结点的完全二叉树的深度为log<sub>2</sub>(n+1);</p>\n<p>5)有N个结点的完全二叉树各结点如果用顺序方式存储，则结点之间有如下关系：</p>\n<p>若I为结点编号则 如果I&gt;1，则其父结点的编号为I/2；</p>\n<p>如果2I&lt;=N，则其左儿子（即左子树的根结点）的编号为2I；若2I&gt;N，则无左儿子；</p>\n<p>如果2I+1&lt;=N，则其右儿子的结点编号为2I+1；若2I+1&gt;N，则无右儿子。</p>\n<p>6)给定N个节点，能构成h(N)种不同的二叉树，其中h(N)为卡特兰数的第N项，h(n)=C(2*n, n)/(n+1)。</p>\n<p>7)设有i个枝点，I为所有枝点的道路长度总和，J为叶的道路长度总和J=I+2<sup>i</sup>。</p>\n<h1 class=\"First\">2. 二叉查找树</h1>\n<p><strong>二叉查找树定义</strong>：又称为是二叉排序树（Binary Sort Tree）或二叉搜索树。二叉排序树或者是一棵空树，或者是具有下列性质的二叉树：</p>\n<p>1) 若左子树不空，则左子树上所有结点的值均小于它的根结点的值；</p>\n<p>2) 若右子树不空，则右子树上所有结点的值均大于或等于它的根结点的值；</p>\n<p>3) 左、右子树也分别为二叉排序树；</p>\n<p>4) 没有键值相等的节点。</p>\n<p><strong>二叉查找树的性质：</strong><strong>对二叉查找树进行中序遍历，即可得到有序的数列。</strong></p>\n<p><strong>二叉查找树的时间复杂度：<strong>它和二分查找一样，插入和查找的时间复杂度均为O(logn)，<span style=\"color: #ff0000\">但是在最坏的情况下仍然会有O(n)的时间复杂度。</span>原因在于插入和删除元素的时候，树没有保持平衡（比如，我们查找上图（b）中的“93”，我们需要进行n次查找操作）。我们追求的是在最坏的情况下仍然有较好的时间复杂度，这就是平衡查找树设计的初衷。</strong></strong></p>\n<p><span style=\"color: #ff0000\"><strong><strong>二叉查找树的高度决定了二叉查找树的查找效率。</strong></strong></span></p>\n<p><strong>二叉查找树的插入过程如下：</strong></p>\n<p>1) 若当前的二叉查找树为空，则插入的元素为根节点;</p>\n<p>2) 若插入的元素值小于根节点值，则将元素插入到左子树中;</p>\n<p>3) 若插入的元素值不小于根节点值，则将元素插入到右子树中。</p>\n<p><strong>二叉查找树的删除，分三种情况进行处理：</strong></p>\n<p>1) p为叶子节点，直接删除该节点，再修改其父节点的指针（注意分是根节点和不是根节点），如图a;</p>\n<p>2) p为单支节点（即只有左子树或右子树）。让p的子树与p的父亲节点相连，删除p即可（注意分是根节点和不是根节点），如图b;</p>\n<p>3) p的左子树和右子树均不空。找到p的后继y，因为y一定没有左子树，所以可以删除y，并让y的父亲节点成为y的右子树的父亲节点，并用y的值代替p的值；或者方法二是找到p的前驱x，x一定没有右子树，所以可以删除x，并让x的父亲节点成为y的左子树的父亲节点。如图c。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/2361a6d889a036b92d6fa44c8984d27e.png\"><img class=\"aligncenter wp-image-111684 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/2361a6d889a036b92d6fa44c8984d27e.png\" alt=\"2012032717571645\" width=\"572\" height=\"205\"></a></p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/05b0ae29caf51cf3aeb26e30ee6996ec.png\"><img class=\"aligncenter wp-image-111685 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/05b0ae29caf51cf3aeb26e30ee6996ec.png\" alt=\"2012032717583358\" width=\"611\" height=\"210\"></a><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/2c51f44d9bfb87f38f9bf040552b6b31.png\"><img class=\"aligncenter wp-image-111686 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/2c51f44d9bfb87f38f9bf040552b6b31.png\" alt=\"2012032717584562\" width=\"553\" height=\"148\"></a></p>\n<p>二叉树相关实现源码：</p>\n<p>插入操作：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-5960b3b51cb5d561975047\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstruct node\r\n{\r\n    int val;\r\n    pnode lchild;\r\n    pnode rchild;\r\n};\r\n\r\npnode BT = NULL;\r\n\r\n\r\n//递归方法插入节点 \r\npnode insert(pnode root, int x)\r\n{\r\n    pnode p = (pnode)malloc(LEN);\r\n    p-&gt;val = x;\r\n    p-&gt;lchild = NULL;\r\n    p-&gt;rchild = NULL;\r\n    if(root == NULL){\r\n        root = p;    \r\n    }    \r\n    else if(x &lt; root-&gt;val){\r\n        root-&gt;lchild = insert(root-&gt;lchild, x);    \r\n    }\r\n    else{\r\n        root-&gt;rchild = insert(root-&gt;rchild, x);    \r\n    }\r\n    return root;\r\n}\r\n\r\n//非递归方法插入节点 \r\nvoid insert_BST(pnode q, int x)\r\n{\r\n    pnode p = (pnode)malloc(LEN);\r\n    p-&gt;val = x;\r\n    p-&gt;lchild = NULL;\r\n    p-&gt;rchild = NULL;\r\n    if(q == NULL){\r\n        BT = p;\r\n        return ;    \r\n    }        \r\n    while(q-&gt;lchild != p &amp;&amp; q-&gt;rchild != p){\r\n        if(x &lt; q-&gt;val){\r\n            if(q-&gt;lchild){\r\n                q = q-&gt;lchild;    \r\n            }    \r\n            else{\r\n                q-&gt;lchild = p;\r\n            }        \r\n        }    \r\n        else{\r\n            if(q-&gt;rchild){\r\n                q = q-&gt;rchild;    \r\n            }    \r\n            else{\r\n                q-&gt;rchild = p;    \r\n            }\r\n        }\r\n    }\r\n    return;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb5d561975047-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb5d561975047-60\">60</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-1\"><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">node</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">pnode </span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">pnode </span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-6\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-8\"><span class=\"crayon-e\">pnode </span><span class=\"crayon-v\">BT</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-10\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-11\"><span class=\"crayon-c\">//递归方法插入节点 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-12\"><span class=\"crayon-e\">pnode </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">pnode </span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-13\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">pnode</span><span class=\"crayon-sy\">)</span><span class=\"crayon-e\">malloc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">LEN</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-28\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-29\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-30\"><span class=\"crayon-c\">//非递归方法插入节点 </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-31\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert_BST</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">q</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-32\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-33\"><span class=\"crayon-h\">    </span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">pnode</span><span class=\"crayon-sy\">)</span><span class=\"crayon-e\">malloc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">LEN</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-34\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-35\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-36\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-37\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-38\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">BT</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-39\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-40\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">        </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-41\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-42\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-43\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-44\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-45\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-46\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-47\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-48\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">        </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-49\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-50\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-51\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-52\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-53\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-54\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-55\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-56\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-57\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-58\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb5d561975047-59\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb5d561975047-60\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0072 seconds] -->\r\n<p>删除操作：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-5960b3b51cb67866081679\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nbool delete_BST(pnode p, int x) //返回一个标志，表示是否找到被删元素 \r\n{\r\n    bool find = false;\r\n    pnode q;\r\n    p = BT;\r\n    while(p &amp;&amp; !find){  //寻找被删元素 \r\n        if(x == p-&gt;val){  //找到被删元素 \r\n            find = true;    \r\n        }    \r\n        else if(x &lt; p-&gt;val){ //沿左子树找 \r\n            q = p;\r\n            p = p-&gt;lchild;    \r\n        }\r\n        else{   //沿右子树找 \r\n            q = p;\r\n            p = p-&gt;rchild;    \r\n        }\r\n    }\r\n    if(p == NULL){   //没找到 \r\n        cout &lt;&lt; \"没有找到\" &lt;&lt; x &lt;&lt; endl;    \r\n    }\r\n    \r\n    if(p-&gt;lchild == NULL &amp;&amp; p-&gt;rchild == NULL){  //p为叶子节点 \r\n        if(p == BT){  //p为根节点 \r\n            BT = NULL;    \r\n        }\r\n        else if(q-&gt;lchild == p){   \r\n            q-&gt;lchild = NULL;\r\n        }        \r\n        else{\r\n            q-&gt;rchild = NULL;    \r\n        }\r\n        free(p);  //释放节点p \r\n    }\r\n    else if(p-&gt;lchild == NULL || p-&gt;rchild == NULL){ //p为单支子树 \r\n        if(p == BT){  //p为根节点 \r\n            if(p-&gt;lchild == NULL){\r\n                BT = p-&gt;rchild;    \r\n            }    \r\n            else{\r\n                BT = p-&gt;lchild;    \r\n            }\r\n        }    \r\n        else{\r\n            if(q-&gt;lchild == p &amp;&amp; p-&gt;lchild){ //p是q的左子树且p有左子树 \r\n                q-&gt;lchild = p-&gt;lchild;    //将p的左子树链接到q的左指针上 \r\n            }    \r\n            else if(q-&gt;lchild == p &amp;&amp; p-&gt;rchild){\r\n                q-&gt;lchild = p-&gt;rchild;    \r\n            }\r\n            else if(q-&gt;rchild == p &amp;&amp; p-&gt;lchild){\r\n                q-&gt;rchild = p-&gt;lchild;    \r\n            }\r\n            else{\r\n                q-&gt;rchild = p-&gt;rchild;\r\n            }\r\n        }\r\n        free(p);\r\n    }\r\n    else{ //p的左右子树均不为空 \r\n        pnode t = p;\r\n        pnode s = p-&gt;lchild;  //从p的左子节点开始 \r\n        while(s-&gt;rchild){  //找到p的前驱，即p左子树中值最大的节点 \r\n            t = s;   \r\n            s = s-&gt;rchild;    \r\n        }\r\n        p-&gt;val = s-&gt;val;   //把节点s的值赋给p \r\n        if(t == p){\r\n            p-&gt;lchild = s-&gt;lchild;    \r\n        }    \r\n        else{\r\n            t-&gt;rchild = s-&gt;lchild;    \r\n        }\r\n        free(s); \r\n    }\r\n    return find;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-71\">71</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-72\">72</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-73\">73</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-74\">74</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-75\">75</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb67866081679-76\">76</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb67866081679-77\">77</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-1\"><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_BST</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//返回一个标志，表示是否找到被删元素 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">find</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">q</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BT</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">find</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//寻找被删元素 </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//找到被删元素 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-8\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">find</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//沿左子树找 </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-11\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">q</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-12\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">   </span><span class=\"crayon-c\">//沿右子树找 </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-15\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">q</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-16\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">   </span><span class=\"crayon-c\">//没找到 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">cout</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"没有找到\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">endl</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-22\"><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//p为叶子节点 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BT</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//p为根节点 </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-25\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">BT</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-27\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">   </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-28\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-29\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">        </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-30\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-31\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-32\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-33\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">free</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//释放节点p </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-34\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-35\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//p为单支子树 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-36\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BT</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//p为根节点 </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-37\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-38\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">BT</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-39\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-40\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-41\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">BT</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-42\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-43\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-44\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-45\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//p是q的左子树且p有左子树 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-46\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span><span class=\"crayon-c\">//将p的左子树链接到q的左指针上 </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-47\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-48\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-49\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-50\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-51\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-52\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-53\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-54\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-55\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-56\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-57\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-58\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">free</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-59\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-60\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//p的左右子树均不为空 </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-61\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-62\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//从p的左子节点开始 </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-63\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">s</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//找到p的前驱，即p左子树中值最大的节点 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-64\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">   </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-65\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">s</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-66\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-67\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">   </span><span class=\"crayon-c\">//把节点s的值赋给p </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-68\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-69\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-70\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-71\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-72\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">t</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-73\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-74\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">free</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">s</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-75\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb67866081679-76\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">find</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb67866081679-77\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0122 seconds] -->\r\n<p>查找操作：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-5960b3b51cb6d788770572\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npnode search_BST(pnode p, int x)\r\n{\r\n    bool solve = false;\r\n    while(p &amp;&amp; !solve){\r\n        if(x == p-&gt;val){\r\n            solve = true;    \r\n        }    \r\n        else if(x &lt; p-&gt;val){\r\n            p = p-&gt;lchild;    \r\n        }\r\n        else{\r\n            p = p-&gt;rchild;    \r\n        }\r\n    }\r\n    if(p == NULL){\r\n        cout &lt;&lt; \"没有找到\" &lt;&lt; x &lt;&lt; endl;    \r\n    } \r\n    return p;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb6d788770572-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb6d788770572-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb6d788770572-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb6d788770572-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb6d788770572-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb6d788770572-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb6d788770572-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb6d788770572-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb6d788770572-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb6d788770572-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb6d788770572-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb6d788770572-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb6d788770572-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb6d788770572-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb6d788770572-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb6d788770572-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb6d788770572-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb6d788770572-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb6d788770572-19\">19</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5960b3b51cb6d788770572-1\"><span class=\"crayon-e\">pnode </span><span class=\"crayon-e\">search_BST</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb6d788770572-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb6d788770572-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">solve</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb6d788770572-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">solve</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb6d788770572-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb6d788770572-6\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">solve</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb6d788770572-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb6d788770572-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb6d788770572-9\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb6d788770572-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb6d788770572-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb6d788770572-12\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb6d788770572-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb6d788770572-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb6d788770572-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb6d788770572-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">cout</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"没有找到\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">endl</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb6d788770572-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb6d788770572-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb6d788770572-19\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0028 seconds] -->\r\n<p></p>\n<h1 class=\"First\">3. 平衡二叉树</h1>\n<p>我们知道，对于一般的二叉搜索树（Binary Search Tree），其期望高度（即为一棵平衡树时）为log<sub>2</sub>n，其各操作的时间复杂度O(log<sub>2</sub>n)同时也由此而决定。但是，在某些极端的情况下（如在插入的序列是有序的时），二叉搜索树将退化成近似链或链，此时，其操作的时间复杂度将退化成线性的，即O(n)。我们可以通过随机化建立二叉搜索树来尽量的避免这种情况，但是在进行了多次的操作之后，由于在删除时，我们总是选择将待删除节点的后继代替它本身，这样就会造成总是右边的节点数目减少，以至于树向左偏沉。这同时也会造成树的平衡性受到破坏，提高它的操作的时间复杂度。于是就有了我们下边介绍的平衡二叉树。</p>\n<p><strong>平衡二叉树定义：</strong>平衡二叉树（Balanced Binary Tree）又被称为AVL树（有别于AVL算法），且具有以下性质：它是一 棵空树或它的左右两个子树的高度差的绝对值不超过1，并且左右两个子树都是一棵平衡二叉树。平衡二叉树的常用算法有红黑树、AVL树等。在平衡二叉搜索树中，我们可以看到，其高度一般都良好地维持在O(log<sub>2</sub>n)，大大降低了操作的时间复杂度。</p>\n<p>最小二叉平衡树的节点的公式如下：</p>\n<p>F(n)=F(n-1)+F(n-2)+1</p>\n<p>这个类似于一个递归的数列，可以参考Fibonacci数列，1是根节点，F(n-1)是左子树的节点数量，F(n-2)是右子树的节点数量。</p>\n<h2 class=\"First\">3.1 平衡查找树之AVL树</h2>\n<p>有关AVL树的具体实现，可以参考<a href=\"http://www.cppblog.com/cxiaojia/archive/2012/08/20/187776.html\" target=\"_blank\">C小加的博客《一步一步写平衡二叉树（AVL）》</a>。</p>\n<p><strong>AVL树定义：</strong>AVL树是最先发明的自平衡二叉查找树。AVL树得名于它的发明者 G.M. Adelson-Velsky 和 E.M. Landis，他们在 1962 年的论文 “An algorithm for the organization of information” 中发表了它。在AVL中任何节点的两个儿子子树的高度最大差别为1，所以它也被称为高度平衡树，n个结点的AVL树最大深度约1.44log<sub>2</sub>n。查找、插入和删除在平均和最坏情况下都是O(logn)。增加和删除可能需要通过一次或多次树旋转来重新平衡这个树。<strong>这个方案很好的解决了二叉查找树退化成链表的问题，把插入，查找，删除的时间复杂度最好情况和最坏情况都维持在O(logN)。但是频繁旋转会使插入和删除牺牲掉O(logN)左右的时间，不过相对二叉查找树来说，时间上稳定了很多。</strong></p>\n<p><strong>AVL树的自平衡操作——旋转：</strong></p>\n<p>AVL树最关键的也是最难的一步操作就是<strong>旋转</strong>。旋转主要是为了实现AVL树在实施了插入和删除操作以后，树重新回到平衡的方法。下面我们重点研究一下AVL树的旋转。</p>\n<p>对于一个平衡的节点，由于任意节点最多有两个儿子，因此高度不平衡时，此节点的两颗子树的高度差2.容易看出，这种不平衡出现在下面四种情况：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/bbc1d195a4adf1a9cc10bb85b0f1c2c6.jpg\"><img class=\"aligncenter wp-image-111687 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/bbc1d195a4adf1a9cc10bb85b0f1c2c6.jpg\" alt=\"2012082016021366\" width=\"785\" height=\"306\"></a></p>\n<p>1) 6节点的左子树3节点高度比右子树7节点大2，左子树3节点的左子树1节点高度大于右子树4节点，这种情况成为左左。</p>\n<p>2) 6节点的左子树2节点高度比右子树7节点大2，左子树2节点的左子树1节点高度小于右子树4节点，这种情况成为左右。</p>\n<p>3) 2节点的左子树1节点高度比右子树5节点小2，右子树5节点的左子树3节点高度大于右子树6节点，这种情况成为右左。</p>\n<p>4) 2节点的左子树1节点高度比右子树4节点小2，右子树4节点的左子树3节点高度小于右子树6节点，这种情况成为右右。</p>\n<p>从图2中可以可以看出，1和4两种情况是对称的，这两种情况的旋转算法是一致的，只需要经过一次旋转就可以达到目标，我们称之为单旋转。2和3两种情况也是对称的，这两种情况的旋转算法也是一致的，需要进行两次旋转，我们称之为双旋转。</p>\n<p><strong>单旋转</strong></p>\n<p>单旋转是针对于左左和右右这两种情况的解决方案，这两种情况是对称的，只要解决了左左这种情况，右右就很好办了。图3是左左情况的解决方案，节点k2不满足平衡特性，因为它的左子树k1比右子树Z深2层，而且k1子树中，更深的一层的是k1的左子树X子树，所以属于左左情况。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/61ee0c83b3783cb05eac2ed3528eae3b.jpg\"><img class=\"aligncenter wp-image-111688 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/61ee0c83b3783cb05eac2ed3528eae3b.jpg\" alt=\"avltree35\" width=\"530\" height=\"229\"></a></p>\n<p>为使树恢复平衡，我们把k2变成这棵树的根节点，因为k2大于k1，把k2置于k1的右子树上，而原本在k1右子树的Y大于k1，小于k2，就把Y置于k2的左子树上，这样既满足了二叉查找树的性质，又满足了平衡二叉树的性质。</p>\n<p>这样的操作只需要一部分指针改变，结果我们得到另外一颗二叉查找树，它是一棵AVL树，因为X向上一移动了一层，Y还停留在原来的层面上，Z向下移动了一层。整棵树的新高度和之前没有在左子树上插入的高度相同，插入操作使得X高度长高了。因此，由于这颗子树高度没有变化，所以通往根节点的路径就不需要继续旋转了。</p>\n<p><strong>双旋转</strong></p>\n<p>对于左右和右左这两种情况，单旋转不能使它达到一个平衡状态，要经过两次旋转。双旋转是针对于这两种情况的解决方案，同样的，这样两种情况也是对称的，只要解决了左右这种情况，右左就很好办了。图4是左右情况的解决方案，节点k3不满足平衡特性，因为它的左子树k1比右子树Z深2层，而且k1子树中，更深的一层的是k1的右子树k2子树，所以属于左右情况。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/2ad609dadbff982036a8e32c792436d7.jpg\"><img class=\"aligncenter wp-image-111690 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/2ad609dadbff982036a8e32c792436d7.jpg\" alt=\"2012082016534455\" width=\"785\" height=\"247\"></a></p>\n<p>为使树恢复平衡，我们需要进行两步，第一步，把k1作为根，进行一次右右旋转，旋转之后就变成了左左情况，所以第二步再进行一次左左旋转，最后得到了一棵以k2为根的平衡二叉树。</p>\n<p><strong>AVL树实现源码：</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-5960b3b51cb74300629668\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n//AVL树节点信息\r\ntemplate&lt;class T&gt;\r\nclass TreeNode\r\n{\r\n    public:\r\n        TreeNode():lson(NULL),rson(NULL),freq(1),hgt(0){}\r\n        T data;//值\r\n        int hgt;//高度\r\n        unsigned int freq;//频率\r\n        TreeNode* lson;//指向左儿子的地址\r\n        TreeNode* rson;//指向右儿子的地址\r\n};\r\n//AVL树类的属性和方法声明\r\ntemplate&lt;class T&gt;\r\nclass AVLTree\r\n{\r\n    private:\r\n        TreeNode&lt;T&gt;* root;//根节点\r\n        void insertpri(TreeNode&lt;T&gt;* &amp;node,T x);//插入\r\n        TreeNode&lt;T&gt;* findpri(TreeNode&lt;T&gt;* node,T x);//查找\r\n        void insubtree(TreeNode&lt;T&gt;* node);//中序遍历\r\n        void Deletepri(TreeNode&lt;T&gt;* &amp;node,T x);//删除\r\n        int height(TreeNode&lt;T&gt;* node);//求树的高度\r\n        void SingRotateLeft(TreeNode&lt;T&gt;* &amp;k2);//左左情况下的旋转\r\n        void SingRotateRight(TreeNode&lt;T&gt;* &amp;k2);//右右情况下的旋转\r\n        void DoubleRotateLR(TreeNode&lt;T&gt;* &amp;k3);//左右情况下的旋转\r\n        void DoubleRotateRL(TreeNode&lt;T&gt;* &amp;k3);//右左情况下的旋转\r\n        int Max(int cmpa,int cmpb);//求最大值\r\n\r\n    public:\r\n        AVLTree():root(NULL){}\r\n        void insert(T x);//插入接口\r\n        TreeNode&lt;T&gt;* find(T x);//查找接口\r\n        void Delete(T x);//删除接口\r\n        void traversal();//遍历接口\r\n\r\n};\r\n//计算节点的高度\r\ntemplate&lt;class T&gt;\r\nint AVLTree&lt;T&gt;::height(TreeNode&lt;T&gt;* node)\r\n{\r\n    if(node!=NULL)\r\n        return node-&gt;hgt;\r\n    return -1;\r\n}\r\n//求最大值\r\ntemplate&lt;class T&gt;\r\nint AVLTree&lt;T&gt;::Max(int cmpa,int cmpb)\r\n{\r\n    return cmpa&gt;cmpb?cmpa:cmpb;\r\n}\r\n//左左情况下的旋转\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::SingRotateLeft(TreeNode&lt;T&gt;* &amp;k2)\r\n{\r\n    TreeNode&lt;T&gt;* k1;\r\n    k1=k2-&gt;lson;\r\n    k2-&gt;lson=k1-&gt;rson;\r\n    k1-&gt;rson=k2;\r\n\r\n    k2-&gt;hgt=Max(height(k2-&gt;lson),height(k2-&gt;rson))+1;\r\n    k1-&gt;hgt=Max(height(k1-&gt;lson),k2-&gt;hgt)+1;\r\n}\r\n//右右情况下的旋转\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::SingRotateRight(TreeNode&lt;T&gt;* &amp;k2)\r\n{\r\n    TreeNode&lt;T&gt;* k1;\r\n    k1=k2-&gt;rson;\r\n    k2-&gt;rson=k1-&gt;lson;\r\n    k1-&gt;lson=k2;\r\n\r\n    k2-&gt;hgt=Max(height(k2-&gt;lson),height(k2-&gt;rson))+1;\r\n    k1-&gt;hgt=Max(height(k1-&gt;rson),k2-&gt;hgt)+1;\r\n}\r\n//左右情况的旋转\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::DoubleRotateLR(TreeNode&lt;T&gt;* &amp;k3)\r\n{\r\n    SingRotateRight(k3-&gt;lson);\r\n    SingRotateLeft(k3);\r\n}\r\n//右左情况的旋转\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::DoubleRotateRL(TreeNode&lt;T&gt;* &amp;k3)\r\n{\r\n    SingRotateLeft(k3-&gt;rson);\r\n    SingRotateRight(k3);\r\n}\r\n//插入\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::insertpri(TreeNode&lt;T&gt;* &amp;node,T x)\r\n{\r\n    if(node==NULL)//如果节点为空,就在此节点处加入x信息\r\n    {\r\n        node=new TreeNode&lt;T&gt;();\r\n        node-&gt;data=x;\r\n        return;\r\n    }\r\n    if(node-&gt;data&gt;x)//如果x小于节点的值,就继续在节点的左子树中插入x\r\n    {\r\n        insertpri(node-&gt;lson,x);\r\n        if(2==height(node-&gt;lson)-height(node-&gt;rson))\r\n            if(x&lt;node-&gt;lson-&gt;data)\r\n                SingRotateLeft(node);\r\n            else\r\n                DoubleRotateLR(node);\r\n    }\r\n    else if(node-&gt;data&lt;x)//如果x大于节点的值,就继续在节点的右子树中插入x\r\n    {\r\n        insertpri(node-&gt;rson,x);\r\n        if(2==height(node-&gt;rson)-height(node-&gt;lson))//如果高度之差为2的话就失去了平衡,需要旋转\r\n            if(x&gt;node-&gt;rson-&gt;data)\r\n                SingRotateRight(node);\r\n            else\r\n                DoubleRotateRL(node);\r\n    }\r\n    else ++(node-&gt;freq);//如果相等,就把频率加1\r\n    node-&gt;hgt=Max(height(node-&gt;lson),height(node-&gt;rson));\r\n}\r\n//插入接口\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::insert(T x)\r\n{\r\n    insertpri(root,x);\r\n}\r\n//查找\r\ntemplate&lt;class T&gt;\r\nTreeNode&lt;T&gt;* AVLTree&lt;T&gt;::findpri(TreeNode&lt;T&gt;* node,T x)\r\n{\r\n    if(node==NULL)//如果节点为空说明没找到,返回NULL\r\n    {\r\n        return NULL;\r\n    }\r\n    if(node-&gt;data&gt;x)//如果x小于节点的值,就继续在节点的左子树中查找x\r\n    {\r\n        return findpri(node-&gt;lson,x);\r\n    }\r\n    else if(node-&gt;data&lt;x)//如果x大于节点的值,就继续在节点的左子树中查找x\r\n    {\r\n        return findpri(node-&gt;rson,x);\r\n    }\r\n    else return node;//如果相等,就找到了此节点\r\n}\r\n//查找接口\r\ntemplate&lt;class T&gt;\r\nTreeNode&lt;T&gt;* AVLTree&lt;T&gt;::find(T x)\r\n{\r\n    return findpri(root,x);\r\n}\r\n//删除\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::Deletepri(TreeNode&lt;T&gt;* &amp;node,T x)\r\n{\r\n    if(node==NULL) return ;//没有找到值是x的节点\r\n    if(x &lt; node-&gt;data)\r\n    {\r\n         Deletepri(node-&gt;lson,x);//如果x小于节点的值,就继续在节点的左子树中删除x\r\n         if(2==height(node-&gt;rson)-height(node-&gt;lson))\r\n            if(node-&gt;rson-&gt;lson!=NULL&amp;&amp;(height(node-&gt;rson-&gt;lson)&gt;height(node-&gt;rson-&gt;rson)) )\r\n                DoubleRotateRL(node);\r\n            else\r\n                SingRotateRight(node);\r\n    }\r\n\r\n    else if(x &gt; node-&gt;data)\r\n    {\r\n         Deletepri(node-&gt;rson,x);//如果x大于节点的值,就继续在节点的右子树中删除x\r\n         if(2==height(node-&gt;lson)-height(node-&gt;rson))\r\n            if(node-&gt;lson-&gt;rson!=NULL&amp;&amp; (height(node-&gt;lson-&gt;rson)&gt;height(node-&gt;lson-&gt;lson) ))\r\n                DoubleRotateLR(node);\r\n            else\r\n                SingRotateLeft(node);\r\n    }\r\n\r\n    else//如果相等,此节点就是要删除的节点\r\n    {\r\n        if(node-&gt;lson&amp;&amp;node-&gt;rson)//此节点有两个儿子\r\n        {\r\n            TreeNode&lt;T&gt;* temp=node-&gt;rson;//temp指向节点的右儿子\r\n            while(temp-&gt;lson!=NULL) temp=temp-&gt;lson;//找到右子树中值最小的节点\r\n            //把右子树中最小节点的值赋值给本节点\r\n            node-&gt;data=temp-&gt;data;\r\n            node-&gt;freq=temp-&gt;freq;\r\n            Deletepri(node-&gt;rson,temp-&gt;data);//删除右子树中最小值的节点\r\n            if(2==height(node-&gt;lson)-height(node-&gt;rson))\r\n            {\r\n                if(node-&gt;lson-&gt;rson!=NULL&amp;&amp; (height(node-&gt;lson-&gt;rson)&gt;height(node-&gt;lson-&gt;lson) ))\r\n                    DoubleRotateLR(node);\r\n                else\r\n                    SingRotateLeft(node);\r\n            }\r\n        }\r\n        else//此节点有1个或0个儿子\r\n        {\r\n            TreeNode&lt;T&gt;* temp=node;\r\n            if(node-&gt;lson==NULL)//有右儿子或者没有儿子\r\n            node=node-&gt;rson;\r\n            else if(node-&gt;rson==NULL)//有左儿子\r\n            node=node-&gt;lson;\r\n            delete(temp);\r\n            temp=NULL;\r\n        }\r\n    }\r\n    if(node==NULL) return;\r\n    node-&gt;hgt=Max(height(node-&gt;lson),height(node-&gt;rson))+1;\r\n    return;\r\n}\r\n//删除接口\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::Delete(T x)\r\n{\r\n    Deletepri(root,x);\r\n}\r\n//中序遍历函数\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::insubtree(TreeNode&lt;T&gt;* node)\r\n{\r\n    if(node==NULL) return;\r\n    insubtree(node-&gt;lson);//先遍历左子树\r\n    cout&lt;&lt;node-&gt;data&lt;&lt;\" \";//输出根节点\r\n    insubtree(node-&gt;rson);//再遍历右子树\r\n}\r\n//中序遍历接口\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::traversal()\r\n{\r\n    insubtree(root);\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-71\">71</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-72\">72</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-73\">73</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-74\">74</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-75\">75</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-76\">76</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-77\">77</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-78\">78</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-79\">79</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-80\">80</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-81\">81</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-82\">82</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-83\">83</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-84\">84</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-85\">85</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-86\">86</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-87\">87</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-88\">88</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-89\">89</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-90\">90</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-91\">91</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-92\">92</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-93\">93</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-94\">94</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-95\">95</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-96\">96</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-97\">97</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-98\">98</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-99\">99</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-100\">100</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-101\">101</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-102\">102</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-103\">103</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-104\">104</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-105\">105</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-106\">106</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-107\">107</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-108\">108</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-109\">109</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-110\">110</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-111\">111</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-112\">112</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-113\">113</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-114\">114</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-115\">115</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-116\">116</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-117\">117</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-118\">118</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-119\">119</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-120\">120</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-121\">121</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-122\">122</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-123\">123</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-124\">124</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-125\">125</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-126\">126</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-127\">127</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-128\">128</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-129\">129</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-130\">130</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-131\">131</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-132\">132</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-133\">133</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-134\">134</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-135\">135</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-136\">136</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-137\">137</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-138\">138</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-139\">139</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-140\">140</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-141\">141</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-142\">142</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-143\">143</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-144\">144</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-145\">145</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-146\">146</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-147\">147</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-148\">148</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-149\">149</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-150\">150</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-151\">151</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-152\">152</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-153\">153</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-154\">154</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-155\">155</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-156\">156</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-157\">157</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-158\">158</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-159\">159</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-160\">160</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-161\">161</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-162\">162</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-163\">163</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-164\">164</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-165\">165</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-166\">166</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-167\">167</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-168\">168</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-169\">169</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-170\">170</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-171\">171</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-172\">172</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-173\">173</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-174\">174</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-175\">175</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-176\">176</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-177\">177</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-178\">178</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-179\">179</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-180\">180</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-181\">181</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-182\">182</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-183\">183</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-184\">184</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-185\">185</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-186\">186</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-187\">187</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-188\">188</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-189\">189</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-190\">190</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-191\">191</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-192\">192</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-193\">193</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-194\">194</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-195\">195</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-196\">196</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-197\">197</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-198\">198</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-199\">199</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-200\">200</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-201\">201</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-202\">202</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-203\">203</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-204\">204</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-205\">205</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-206\">206</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-207\">207</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-208\">208</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-209\">209</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-210\">210</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-211\">211</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-212\">212</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-213\">213</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-214\">214</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-215\">215</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-216\">216</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-217\">217</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-218\">218</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-219\">219</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-220\">220</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-221\">221</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-222\">222</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-223\">223</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-224\">224</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-225\">225</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-226\">226</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-227\">227</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb74300629668-228\">228</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb74300629668-229\">229</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-1\"><span class=\"crayon-c\">//AVL树节点信息</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-2\"><span class=\"crayon-e\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-3\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TreeNode</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-4\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">TreeNode</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">lson</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">rson</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">freq</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">hgt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//值</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">hgt</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//高度</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">freq</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//频率</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">TreeNode*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//指向左儿子的地址</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">TreeNode*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//指向右儿子的地址</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-12\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-13\"><span class=\"crayon-c\">//AVL树类的属性和方法声明</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-14\"><span class=\"crayon-e\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-15\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AVLTree</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-16\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//根节点</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insertpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//插入</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">findpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//查找</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insubtree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//中序遍历</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Deletepri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//删除</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-23\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//求树的高度</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//左左情况下的旋转</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SingRotateRight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//右右情况下的旋转</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DoubleRotateLR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k3</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//左右情况下的旋转</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-27\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DoubleRotateRL</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k3</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//右左情况下的旋转</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cmpa</span><span class=\"crayon-sy\">,</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cmpb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//求最大值</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-29\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-30\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-31\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">AVLTree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">root</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-32\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//插入接口</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-33\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">find</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//查找接口</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-34\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Delete</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//删除接口</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-35\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">traversal</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//遍历接口</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-36\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-37\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-38\"><span class=\"crayon-c\">//计算节点的高度</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-39\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-40\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-41\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-42\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">!=</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-43\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-44\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-45\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-46\"><span class=\"crayon-c\">//求最大值</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-47\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-48\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cmpa</span><span class=\"crayon-sy\">,</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cmpb</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-49\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-50\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cmpa</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">cmpb</span><span class=\"crayon-sy\">?</span><span class=\"crayon-v\">cmpa</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">cmpb</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-51\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-52\"><span class=\"crayon-c\">//左左情况下的旋转</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-53\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-54\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k2</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-55\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-56\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">k1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-57\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-58\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-59\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">k2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-60\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-61\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-62\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-63\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-64\"><span class=\"crayon-c\">//右右情况下的旋转</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-65\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-66\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">SingRotateRight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k2</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-67\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-68\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">k1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-69\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-70\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-71\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">k2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-72\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-73\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-74\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-75\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-76\"><span class=\"crayon-c\">//左右情况的旋转</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-77\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-78\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">DoubleRotateLR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k3</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-79\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-80\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">SingRotateRight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k3</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-81\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k3</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-82\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-83\"><span class=\"crayon-c\">//右左情况的旋转</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-84\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-85\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">DoubleRotateRL</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k3</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-86\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-87\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k3</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-88\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">SingRotateRight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k3</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-89\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-90\"><span class=\"crayon-c\">//插入</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-91\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-92\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">insertpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-93\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-94\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果节点为空,就在此节点处加入x信息</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-95\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-96\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">=</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-97\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-98\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-99\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-100\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果x小于节点的值,就继续在节点的左子树中插入x</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-101\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-102\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">insertpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-103\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">==</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-104\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-105\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-106\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-107\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">DoubleRotateLR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-108\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-109\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果x大于节点的值,就继续在节点的右子树中插入x</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-110\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-111\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">insertpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-112\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">==</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果高度之差为2的话就失去了平衡,需要旋转</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-113\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-114\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">SingRotateRight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-115\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-116\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">DoubleRotateRL</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-117\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-118\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">freq</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//如果相等,就把频率加1</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-119\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-120\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-121\"><span class=\"crayon-c\">//插入接口</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-122\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-123\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-124\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-125\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">insertpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-126\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-127\"><span class=\"crayon-c\">//查找</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-128\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-129\"><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">findpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-130\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-131\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果节点为空说明没找到,返回NULL</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-132\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-133\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-134\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-135\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果x小于节点的值,就继续在节点的左子树中查找x</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-136\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-137\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">findpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-138\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-139\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果x大于节点的值,就继续在节点的左子树中查找x</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-140\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-141\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">findpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-142\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-143\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//如果相等,就找到了此节点</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-144\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-145\"><span class=\"crayon-c\">//查找接口</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-146\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-147\"><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">find</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-148\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-149\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">findpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-150\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-151\"><span class=\"crayon-c\">//删除</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-152\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-153\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">Deletepri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-154\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-155\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//没有找到值是x的节点</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-156\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-157\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-158\"><span class=\"crayon-h\">         </span><span class=\"crayon-e\">Deletepri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//如果x小于节点的值,就继续在节点的左子树中删除x</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-159\"><span class=\"crayon-h\">         </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">==</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-160\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">!=</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-161\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">DoubleRotateRL</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-162\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-163\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">SingRotateRight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-164\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-165\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-166\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-167\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-168\"><span class=\"crayon-h\">         </span><span class=\"crayon-e\">Deletepri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//如果x大于节点的值,就继续在节点的右子树中删除x</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-169\"><span class=\"crayon-h\">         </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">==</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-170\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">!=</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-171\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">DoubleRotateLR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-172\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-173\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-174\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-175\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-176\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-c\">//如果相等,此节点就是要删除的节点</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-177\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-178\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//此节点有两个儿子</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-179\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-180\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//temp指向节点的右儿子</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-181\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">!=</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//找到右子树中值最小的节点</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-182\"><span class=\"crayon-h\">            </span><span class=\"crayon-c\">//把右子树中最小节点的值赋值给本节点</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-183\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-184\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">freq</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">freq</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-185\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">Deletepri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//删除右子树中最小值的节点</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-186\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">==</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-187\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-188\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">!=</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-189\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">DoubleRotateLR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-190\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-191\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-192\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-193\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-194\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-c\">//此节点有1个或0个儿子</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-195\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-196\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-197\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//有右儿子或者没有儿子</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-198\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-199\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//有左儿子</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-200\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-201\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">delete</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-202\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">=</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-203\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-204\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-205\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-206\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-207\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-208\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-209\"><span class=\"crayon-c\">//删除接口</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-210\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-211\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">Delete</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-212\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-213\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">Deletepri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-214\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-215\"><span class=\"crayon-c\">//中序遍历函数</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-216\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-217\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">insubtree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-218\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-219\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-220\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">insubtree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//先遍历左子树</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-221\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">cout</span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-s\">\" \"</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//输出根节点</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-222\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">insubtree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//再遍历右子树</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-223\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-224\"><span class=\"crayon-c\">//中序遍历接口</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-225\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-226\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">traversal</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-227\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb74300629668-228\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">insubtree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb74300629668-229\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0334 seconds] -->\r\n<p></p>\n<h2 class=\"First\">3.2 平衡二叉树之红黑树</h2>\n<p><strong>红黑树的定义：</strong>红黑树是一种自平衡二叉查找树，是在计算机科学中用到的一种数据结构，典型的用途是实现关联数组。它是在1972年由鲁道夫·贝尔发明的，称之为”对称二叉B树”，它现代的名字是在 Leo J. Guibas 和 Robert Sedgewick 于1978年写的一篇论文中获得的。<strong>它是复杂的，但它的操作有着良好的最坏情况运行时间，并且在实践中是高效的: 它可以在O(logn)时间内做查找，插入和删除，这里的n是树中元素的数目。</strong></p>\n<p>红黑树和AVL树一样都对插入时间、删除时间和查找时间提供了最好可能的最坏情况担保。这不只是使它们在时间敏感的应用如实时应用（real time application）中有价值，而且使它们有在提供最坏情况担保的其他数据结构中作为建造板块的价值；例如，在计算几何中使用的很多数据结构都可以基于红黑树。此外，红黑树还是2-3-4树的一种等同，它们的思想是一样的，只不过红黑树是2-3-4树用二叉树的形式表示的。</p>\n<p><strong>红黑树的性质：</strong></p>\n<p>红黑树是每个节点都带有颜色属性的二叉查找树，颜色为红色或黑色。在二叉查找树强制的一般要求以外，对于任何有效的红黑树我们增加了如下的额外要求:</p>\n<p>性质1. 节点是红色或黑色。</p>\n<p>性质2. 根是黑色。</p>\n<p>性质3. 所有叶子都是黑色（叶子是NIL节点）。</p>\n<p>性质4. 每个红色节点必须有两个黑色的子节点。(从每个叶子到根的所有路径上不能有两个连续的红色节点。)</p>\n<p>性质5. 从任一节点到其每个叶子的所有简单路径都包含相同数目的黑色节点。</p>\n<p>下面是一个具体的红黑树的图例：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/9fd5e683147961431e0ecfcffbe5805b.png\"><img class=\"aligncenter wp-image-111691 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9fd5e683147961431e0ecfcffbe5805b.png\" alt=\"450px-Red-black_tree_example.svg\" width=\"450\" height=\"217\"></a></p>\n<p>这些约束确保了红黑树的关键特性: 从根到叶子的最长的可能路径不多于最短的可能路径的两倍长。结果是这个树大致上是平衡的。因为操作比如插入、删除和查找某个值的最坏情况时间都要求与树的高度成比例，这个在高度上的理论上限允许红黑树在最坏情况下都是高效的，而不同于普通的二叉查找树。</p>\n<p>要知道为什么这些性质确保了这个结果，注意到性质4导致了路径不能有两个毗连的红色节点就足够了。最短的可能路径都是黑色节点，最长的可能路径有交替的红色和黑色节点。因为根据性质5所有最长的路径都有相同数目的黑色节点，这就表明了没有路径能多于任何其他路径的两倍长。</p>\n<p>以下内容整理自<a href=\"https://zh.wikipedia.org/wiki/%E7%BA%A2%E9%BB%91%E6%A0%91\" target=\"_blank\">wiki百科之红黑树</a>。</p>\n<p><strong>红黑树的自平衡操作：</strong></p>\n<p>因为每一个红黑树也是一个特化的二叉查找树，因此红黑树上的只读操作与普通二叉查找树上的只读操作相同。然而，在红黑树上进行插入操作和删除操作会导致不再符合红黑树的性质。恢复红黑树的性质需要少量(O(logn))的颜色变更(实际是非常快速的)和不超过三次树旋转(对于插入操作是两次)。虽然插入和删除很复杂，但操作时间仍可以保持为O(logn) 次。</p>\n<p><strong>我们首先以二叉查找树的方法增加节点并标记它为红色。如果设为黑色，就会导致根到叶子的路径上有一条路上，多一个额外的黑节点，这个是很难调整的（违背性质5）。</strong>但是设为红色节点后，可能会导致出现两个连续红色节点的冲突，那么可以通过颜色调换（color flips）和树旋转来调整。下面要进行什么操作取决于其他临近节点的颜色。同人类的家族树中一样，我们将使用术语叔父节点来指一个节点的父节点的兄弟节点。注意:</p>\n<ul>\n<li>性质1和性质3总是保持着。</li>\n<li>性质4只在增加红色节点、重绘黑色节点为红色，或做旋转时受到威胁。</li>\n<li>性质5只在增加黑色节点、重绘红色节点为黑色，或做旋转时受到威胁。</li>\n</ul>\n<p><strong>插入操作：</strong></p>\n<p>假设，将要插入的节点标为<strong>N</strong>，N的父节点标为<strong>P</strong>，N的祖父节点标为<strong>G</strong>，N的叔父节点标为<strong>U</strong>。在图中展示的任何颜色要么是由它所处情形这些所作的假定，要么是假定所暗含的。</p>\n<p><strong>情形1: </strong>该树为空树，直接插入根结点的位置，违反性质1，把节点颜色有红改为黑即可。</p>\n<p><strong>情形2:</strong> 插入节点N的父节点P为黑色，不违反任何性质，无需做任何修改。在这种情形下，树仍是有效的。性质5也未受到威胁，尽管新节点N有两个黑色叶子子节点；但由于新节点N是红色，通过它的每个子节点的路径就都有同通过它所取代的黑色的叶子的路径同样数目的黑色节点，所以依然满足这个性质。</p>\n<p>注： 情形1很简单，情形2中P为黑色，一切安然无事，但P为红就不一样了，下边是P为红的各种情况，也是真正难懂的地方。</p>\n<p><strong>情形3: </strong>如果父节点P和叔父节点U二者都是红色，(此时新插入节点N做为P的左子节点或右子节点都属于情形3,这里右图仅显示N做为P左子的情形)则我们可以将它们两个重绘为黑色并重绘祖父节点G为红色(用来保持性质4)。现在我们的新节点N有了一个黑色的父节点P。因为通过父节点P或叔父节点U的任何路径都必定通过祖父节点G，在这些路径上的黑节点数目没有改变。但是，红色的祖父节点G的父节点也有可能是红色的，这就违反了性质4。为了解决这个问题，我们在祖父节点G上递归地进行上述情形的整个过程（把G当成是新加入的节点进行各种情形的检查）。比如，G为根节点，那我们就直接将G变为黑色（情形1）；如果G不是根节点，而它的父节点为黑色，那符合所有的性质，直接插入即可（情形2）；如果G不是根节点，而它的父节点为红色，则递归上述过程（情形3）。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/dc3747336812e9055f958c56ade89eb8.png\"><img class=\"aligncenter wp-image-111692 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/dc3747336812e9055f958c56ade89eb8.png\" alt=\"2011120116425251\" width=\"300\" height=\"139\"></a></p>\n<p><strong>情形4:</strong> 父节点P是红色而叔父节点U是黑色或缺少，新节点N是其父节点的左子节点，而父节点P又是其父节点G的左子节点。在这种情形下，我们进行针对祖父节点G的一次右旋转; 在旋转产生的树中，以前的父节点P现在是新节点N和以前的祖父节点G的父节点。我们知道以前的祖父节点G是黑色，否则父节点P就不可能是红色(如果P和G都是红色就违反了性质4，所以G必须是黑色)。我们切换以前的父节点P和祖父节点G的颜色，结果的树满足性质4。性质5也仍然保持满足，因为通过这三个节点中任何一个的所有路径以前都通过祖父节点G，现在它们都通过以前的父节点P。在各自的情形下，这都是三个节点中唯一的黑色节点。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/4986c959603100e41cba2669d9e3ce0c.png\"><img class=\"aligncenter wp-image-111693 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/4986c959603100e41cba2669d9e3ce0c.png\" alt=\"Red-black_tree_insert_case_5\" width=\"310\" height=\"138\"></a></p>\n<p><strong>情形5:</strong> 父节点P是红色而叔父节点U是黑色或缺少，并且新节点N是其父节点P的右子节点而父节点P又是其父节点的左子节点。在这种情形下，我们进行一次左旋转调换新节点和其父节点的角色; 接着，我们按<strong>情形4</strong>处理以前的父节点P以解决仍然失效的性质4。注意这个改变会导致某些路径通过它们以前不通过的新节点N（比如图中1号叶子节点）或不通过节点P（比如图中3号叶子节点），但由于这两个节点都是红色的，所以性质5仍有效。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/9cfbf62dfdefe5891347de95a976758f.png\"><img class=\"aligncenter wp-image-111694 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9cfbf62dfdefe5891347de95a976758f.png\" alt=\"Red-black_tree_insert_case_5\" width=\"283\" height=\"138\"></a></p>\n<p><strong>注: 插入实际上是原地算法，因为上述所有调用都使用了尾部递归。</strong></p>\n<p><strong>删除操作：</strong></p>\n<p><strong>如果需要删除的节点有两个儿子，那么问题可以被转化成删除另一个只有一个儿子的节点的问题</strong>。对于二叉查找树，在删除带有两个非叶子儿子的节点的时候，我们找到要么在它的左子树中的最大元素、要么在它的右子树中的最小元素，并把它的值转移到要删除的节点中。我们接着删除我们从中复制出值的那个节点，它必定有少于两个非叶子的儿子。因为只是复制了一个值，不违反任何性质，这就把问题简化为如何删除最多有一个儿子的节点的问题。它不关心这个节点是最初要删除的节点还是我们从中复制出值的那个节点。</p>\n<p><strong>我们只需要讨论删除只有一个儿子的节点</strong>(如果它两个儿子都为空，即均为叶子，我们任意将其中一个看作它的儿子)。如果我们删除一个红色节点（此时该节点的儿子将都为叶子节点），它的父亲和儿子一定是黑色的。所以我们可以简单的用它的黑色儿子替换它，并不会破坏性质3和性质4。通过被删除节点的所有路径只是少了一个红色节点，这样可以继续保证性质5。另一种简单情况是在被删除节点是黑色而它的儿子是红色的时候。如果只是去除这个黑色节点，用它的红色儿子顶替上来的话，会破坏性质5，但是如果我们重绘它的儿子为黑色，则曾经通过它的所有路径将通过它的黑色儿子，这样可以继续保持性质5。</p>\n<p><strong>需要进一步讨论的是在要删除的节点和它的儿子二者都是黑色的时候</strong>，这是一种复杂的情况。我们首先把要删除的节点替换为它的儿子。出于方便，称呼这个儿子为<strong>N</strong>(在新的位置上)，称呼它的兄弟(它父亲的另一个儿子)为<strong>S</strong>。在下面的示意图中，我们还是使用<strong>P</strong>称呼N的父亲，<strong>S<sub>L</sub></strong>称呼S的左儿子，<strong>S<sub>R</sub></strong>称呼S的右儿子。</p>\n<p>如果N和它初始的父亲是黑色，则删除它的父亲导致通过N的路径都比不通过它的路径少了一个黑色节点。因为这违反了性质5，树需要被重新平衡。有几种情形需要考虑:</p>\n<p><strong>情形1:</strong> N是新的根。在这种情形下，我们就做完了。我们从所有路径去除了一个黑色节点，而新根是黑色的，所以性质都保持着。</p>\n<p><strong>注意</strong>: 在情形2、5和6下，我们假定N是它父亲的左儿子。如果它是右儿子，则在这些情形下的左和右应当对调。</p>\n<p><strong>情形2:</strong> S是红色。在这种情形下我们在N的父亲上做左旋转，把红色兄弟转换成N的祖父，我们接着对调N的父亲和祖父的颜色。完成这两个操作后，尽管所有路径上黑色节点的数目没有改变，但现在N有了一个黑色的兄弟和一个红色的父亲（它的新兄弟是黑色因为它是红色S的一个儿子），所以我们可以接下去按<strong>情形4</strong>、<strong>情形5</strong>或<strong>情形6</strong>来处理。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/ce86b0e24e64c35067f5d087dc4c90ae.png\"><img class=\"aligncenter wp-image-111695 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/ce86b0e24e64c35067f5d087dc4c90ae.png\" alt=\"Red-black_tree_insert_case_5\" width=\"298\" height=\"136\"></a></p>\n<p><strong>情形3:</strong> N的父亲、S和S的儿子都是黑色的。在这种情形下，我们简单的重绘S为红色。结果是通过S的所有路径，它们就是以前<em>不</em>通过N的那些路径，都少了一个黑色节点。因为删除N的初始的父亲使通过N的所有路径少了一个黑色节点，这使事情都平衡了起来。但是，通过P的所有路径现在比不通过P的路径少了一个黑色节点，所以仍然违反性质5。要修正这个问题，我们要从<strong>情形1</strong>开始，在P上做重新平衡处理。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/30759b4136b3cd56ba31eb8d06a434d2.png\"><img class=\"aligncenter wp-image-111696 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/30759b4136b3cd56ba31eb8d06a434d2.png\" alt=\"Red-black_tree_insert_case_5\" width=\"313\" height=\"132\"></a></p>\n<p><strong>情形4:</strong> S和S的儿子都是黑色，但是N的父亲是红色。在这种情形下，我们简单的交换N的兄弟和父亲的颜色。这不影响不通过N的路径的黑色节点的数目，但是它在通过N的路径上对黑色节点数目增加了一，添补了在这些路径上删除的黑色节点。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/61bda9c9a89a3f9ea5f01ed990070a39.png\"><img class=\"aligncenter wp-image-111697 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/61bda9c9a89a3f9ea5f01ed990070a39.png\" alt=\"Red-black_tree_insert_case_5\" width=\"313\" height=\"132\"></a></p>\n<p><strong>情形5:</strong> S是黑色，S的左儿子是红色，S的右儿子是黑色，而N是它父亲的左儿子。在这种情形下我们在S上做右旋转，这样S的左儿子成为S的父亲和N的新兄弟。我们接着交换S和它的新父亲的颜色。所有路径仍有同样数目的黑色节点，但是现在N有了一个黑色兄弟，他的右儿子是红色的，所以我们进入了<strong>情形6</strong>。N和它的父亲都不受这个变换的影响。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/9f411d70951995007ad2a59fb747d160.png\"><img class=\"aligncenter wp-image-111698 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9f411d70951995007ad2a59fb747d160.png\" alt=\"Red-black_tree_insert_case_5\" width=\"247\" height=\"133\"></a></p>\n<p> </p>\n<p><strong>情形6:</strong> S是黑色，S的右儿子是红色，而N是它父亲的左儿子。在这种情形下我们在N的父亲上做左旋转，这样S成为N的父亲（P）和S的右儿子的父亲。我们接着交换N的父亲和S的颜色，并使S的右儿子为黑色。子树在它的根上的仍是同样的颜色，所以性质3没有被违反。但是，N现在增加了一个黑色祖先: 要么N的父亲变成黑色，要么它是黑色而S被增加为一个黑色祖父。所以，通过N的路径都增加了一个黑色节点。</p>\n<p>此时，如果一个路径不通过N，则有两种可能性:</p>\n<ul>\n<li>它通过N的新兄弟。那么它以前和现在都必定通过S和N的父亲，而它们只是交换了颜色。所以路径保持了同样数目的黑色节点。</li>\n<li>它通过N的新叔父，S的右儿子。那么它以前通过S、S的父亲和S的右儿子，但是现在只通过S，它被假定为它以前的父亲的颜色，和S的右儿子，它被从红色改变为黑色。合成效果是这个路径通过了同样数目的黑色节点。</li>\n</ul>\n<p>在任何情况下，在这些路径上的黑色节点数目都没有改变。所以我们恢复了性质4。在示意图中的白色节点可以是红色或黑色，但是在变换前后都必须指定相同的颜色。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/c0ea423eef5e175e0ba92e43ad17270d.png\"><img class=\"aligncenter wp-image-111699 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/c0ea423eef5e175e0ba92e43ad17270d.png\" alt=\"Red-black_tree_insert_case_5\" width=\"299\" height=\"143\"></a></p>\n<p><strong>红黑树实现源码：</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-5960b3b51cb86365262181\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#define BLACK 1\r\n#define RED 0\r\n\r\nusing namespace std;\r\n\r\nclass bst {\r\nprivate:\r\n\r\n    struct Node {\r\n        int value;\r\n        bool color;\r\n        Node *leftTree, *rightTree, *parent;\r\n\r\n        Node() {\r\n            color = RED;\r\n            leftTree = NULL;\r\n            rightTree = NULL;\r\n            parent = NULL;\r\n            value = 0;\r\n        }\r\n\r\n        Node* grandparent() {\r\n            if (parent == NULL) {\r\n                return NULL;\r\n            }\r\n            return parent-&gt;parent;\r\n        }\r\n\r\n        Node* uncle() {\r\n            if (grandparent() == NULL) {\r\n                return NULL;\r\n            }\r\n            if (parent == grandparent()-&gt;rightTree)\r\n                return grandparent()-&gt;leftTree;\r\n            else\r\n                return grandparent()-&gt;rightTree;\r\n        }\r\n\r\n        Node* sibling() {\r\n            if (parent-&gt;leftTree == this)\r\n                return parent-&gt;rightTree;\r\n            else\r\n                return parent-&gt;leftTree;\r\n        }\r\n    };\r\n\r\n    void rotate_right(Node *p) {\r\n        Node *gp = p-&gt;grandparent();\r\n        Node *fa = p-&gt;parent;\r\n        Node *y = p-&gt;rightTree;\r\n\r\n        fa-&gt;leftTree = y;\r\n\r\n        if (y != NIL)\r\n            y-&gt;parent = fa;\r\n        p-&gt;rightTree = fa;\r\n        fa-&gt;parent = p;\r\n\r\n        if (root == fa)\r\n            root = p;\r\n        p-&gt;parent = gp;\r\n\r\n        if (gp != NULL) {\r\n            if (gp-&gt;leftTree == fa)\r\n                gp-&gt;leftTree = p;\r\n            else\r\n                gp-&gt;rightTree = p;\r\n        }\r\n\r\n    }\r\n\r\n    void rotate_left(Node *p) {\r\n        if (p-&gt;parent == NULL) {\r\n            root = p;\r\n            return;\r\n        }\r\n        Node *gp = p-&gt;grandparent();\r\n        Node *fa = p-&gt;parent;\r\n        Node *y = p-&gt;leftTree;\r\n\r\n        fa-&gt;rightTree = y;\r\n\r\n        if (y != NIL)\r\n            y-&gt;parent = fa;\r\n        p-&gt;leftTree = fa;\r\n        fa-&gt;parent = p;\r\n\r\n        if (root == fa)\r\n            root = p;\r\n        p-&gt;parent = gp;\r\n\r\n        if (gp != NULL) {\r\n            if (gp-&gt;leftTree == fa)\r\n                gp-&gt;leftTree = p;\r\n            else\r\n                gp-&gt;rightTree = p;\r\n        }\r\n    }\r\n\r\n    void inorder(Node *p) {\r\n        if (p == NIL)\r\n            return;\r\n\r\n        if (p-&gt;leftTree)\r\n            inorder(p-&gt;leftTree);\r\n\r\n        cout &lt;&lt; p-&gt;value &lt;&lt; \" \";\r\n                \r\n        if (p-&gt;rightTree)\r\n            inorder(p-&gt;rightTree);\r\n    }\r\n\r\n    string outputColor(bool color) {\r\n        return color ? \"BLACK\" : \"RED\";\r\n    }\r\n\r\n    Node* getSmallestChild(Node *p) {\r\n        if (p-&gt;leftTree == NIL)\r\n            return p;\r\n        return getSmallestChild(p-&gt;leftTree);\r\n    }\r\n\r\n    bool delete_child(Node *p, int data) {\r\n        if (p-&gt;value &gt; data) {\r\n            if (p-&gt;leftTree == NIL) {\r\n                return false;\r\n            }\r\n            return delete_child(p-&gt;leftTree, data);\r\n        } else if (p-&gt;value &lt; data) {\r\n            if (p-&gt;rightTree == NIL) {\r\n                return false;\r\n            }\r\n            return delete_child(p-&gt;rightTree, data);\r\n        } else if (p-&gt;value == data) {\r\n            if (p-&gt;rightTree == NIL) {\r\n                delete_one_child(p);\r\n                return true;\r\n            }\r\n            Node *smallest = getSmallestChild(p-&gt;rightTree);\r\n            swap(p-&gt;value, smallest-&gt;value);\r\n            delete_one_child(smallest);\r\n\r\n            return true;\r\n        }\r\n    }\r\n\r\n    void delete_one_child(Node *p) {\r\n        Node *child = p-&gt;leftTree == NIL ? p-&gt;rightTree : p-&gt;leftTree;\r\n        if (p-&gt;parent == NULL &amp;&amp; p-&gt;leftTree == NIL &amp;&amp; p-&gt;rightTree == NIL) {\r\n            p = NULL;\r\n            root = p;\r\n            return;\r\n        }\r\n        \r\n        if (p-&gt;parent == NULL) {\r\n            delete  p;\r\n            child-&gt;parent = NULL;\r\n            root = child;\r\n            root-&gt;color = BLACK;\r\n            return;\r\n        }\r\n        \r\n        if (p-&gt;parent-&gt;leftTree == p) {\r\n            p-&gt;parent-&gt;leftTree = child;\r\n        } else {\r\n            p-&gt;parent-&gt;rightTree = child;\r\n        }\r\n        child-&gt;parent = p-&gt;parent;\r\n\r\n        if (p-&gt;color == BLACK) {\r\n            if (child-&gt;color == RED) {\r\n                child-&gt;color = BLACK;\r\n            } else\r\n                delete_case(child);\r\n        }\r\n\r\n        delete p;\r\n    }\r\n\r\n    void delete_case(Node *p) {\r\n        if (p-&gt;parent == NULL) {\r\n            p-&gt;color = BLACK;\r\n            return;\r\n        }\r\n        if (p-&gt;sibling()-&gt;color == RED) {\r\n            p-&gt;parent-&gt;color = RED;\r\n            p-&gt;sibling()-&gt;color = BLACK;\r\n            if (p == p-&gt;parent-&gt;leftTree)\r\n                rotate_left(p-&gt;sibling());\r\n            else\r\n                rotate_right(p-&gt;sibling());\r\n        }\r\n        if (p-&gt;parent-&gt;color == BLACK &amp;&amp; p-&gt;sibling()-&gt;color == BLACK\r\n                &amp;&amp; p-&gt;sibling()-&gt;leftTree-&gt;color == BLACK &amp;&amp; p-&gt;sibling()-&gt;rightTree-&gt;color == BLACK) {\r\n            p-&gt;sibling()-&gt;color = RED;\r\n            delete_case(p-&gt;parent);\r\n        } else if (p-&gt;parent-&gt;color == RED &amp;&amp; p-&gt;sibling()-&gt;color == BLACK\r\n                &amp;&amp; p-&gt;sibling()-&gt;leftTree-&gt;color == BLACK &amp;&amp; p-&gt;sibling()-&gt;rightTree-&gt;color == BLACK) {\r\n            p-&gt;sibling()-&gt;color = RED;\r\n            p-&gt;parent-&gt;color = BLACK;\r\n        } else {\r\n            if (p-&gt;sibling()-&gt;color == BLACK) {\r\n                if (p == p-&gt;parent-&gt;leftTree &amp;&amp; p-&gt;sibling()-&gt;leftTree-&gt;color == RED\r\n                        &amp;&amp; p-&gt;sibling()-&gt;rightTree-&gt;color == BLACK) {\r\n                    p-&gt;sibling()-&gt;color = RED;\r\n                    p-&gt;sibling()-&gt;leftTree-&gt;color = BLACK;\r\n                    rotate_right(p-&gt;sibling()-&gt;leftTree);\r\n                } else if (p == p-&gt;parent-&gt;rightTree &amp;&amp; p-&gt;sibling()-&gt;leftTree-&gt;color == BLACK\r\n                        &amp;&amp; p-&gt;sibling()-&gt;rightTree-&gt;color == RED) {\r\n                    p-&gt;sibling()-&gt;color = RED;\r\n                    p-&gt;sibling()-&gt;rightTree-&gt;color = BLACK;\r\n                    rotate_left(p-&gt;sibling()-&gt;rightTree);\r\n                }\r\n            }\r\n            p-&gt;sibling()-&gt;color = p-&gt;parent-&gt;color;\r\n            p-&gt;parent-&gt;color = BLACK;\r\n            if (p == p-&gt;parent-&gt;leftTree) {\r\n                p-&gt;sibling()-&gt;rightTree-&gt;color = BLACK;\r\n                rotate_left(p-&gt;sibling());\r\n            } else {\r\n                p-&gt;sibling()-&gt;leftTree-&gt;color = BLACK;\r\n                rotate_right(p-&gt;sibling());\r\n            }\r\n        }\r\n    }\r\n\r\n    void insert(Node *p, int data) {\r\n        if (p-&gt;value &gt;= data) {\r\n            if (p-&gt;leftTree != NIL)\r\n                insert(p-&gt;leftTree, data);\r\n            else {\r\n                Node *tmp = new Node();\r\n                tmp-&gt;value = data;\r\n                tmp-&gt;leftTree = tmp-&gt;rightTree = NIL;\r\n                tmp-&gt;parent = p;\r\n                p-&gt;leftTree = tmp;\r\n                insert_case(tmp);\r\n            }\r\n        } else {\r\n            if (p-&gt;rightTree != NIL)\r\n                insert(p-&gt;rightTree, data);\r\n            else {\r\n                Node *tmp = new Node();\r\n                tmp-&gt;value = data;\r\n                tmp-&gt;leftTree = tmp-&gt;rightTree = NIL;\r\n                tmp-&gt;parent = p;\r\n                p-&gt;rightTree = tmp;\r\n                insert_case(tmp);\r\n            }\r\n        }\r\n    }\r\n\r\n    void insert_case(Node *p) {\r\n        if (p-&gt;parent == NULL) {\r\n            root = p;\r\n            p-&gt;color = BLACK;\r\n            return;\r\n        }\r\n        if (p-&gt;parent-&gt;color == RED) {\r\n            if (p-&gt;uncle()-&gt;color == RED) {\r\n                p-&gt;parent-&gt;color = p-&gt;uncle()-&gt;color = BLACK;\r\n                p-&gt;grandparent()-&gt;color = RED;\r\n                insert_case(p-&gt;grandparent());\r\n            } else {\r\n                if (p-&gt;parent-&gt;rightTree == p &amp;&amp; p-&gt;grandparent()-&gt;leftTree == p-&gt;parent) {\r\n                    rotate_left(p);\r\n                    rotate_right(p);\r\n                    p-&gt;color = BLACK;\r\n                    p-&gt;leftTree-&gt;color = p-&gt;rightTree-&gt;color = RED;\r\n                } else if (p-&gt;parent-&gt;leftTree == p &amp;&amp; p-&gt;grandparent()-&gt;rightTree == p-&gt;parent) {\r\n                    rotate_right(p);\r\n                    rotate_left(p);\r\n                    p-&gt;color = BLACK;\r\n                    p-&gt;leftTree-&gt;color = p-&gt;rightTree-&gt;color = RED;\r\n                } else if (p-&gt;parent-&gt;leftTree == p &amp;&amp; p-&gt;grandparent()-&gt;leftTree == p-&gt;parent) {\r\n                    p-&gt;parent-&gt;color = BLACK;\r\n                    p-&gt;grandparent()-&gt;color = RED;\r\n                    rotate_right(p-&gt;parent);\r\n                } else if (p-&gt;parent-&gt;rightTree == p &amp;&amp; p-&gt;grandparent()-&gt;rightTree == p-&gt;parent) {\r\n                    p-&gt;parent-&gt;color = BLACK;\r\n                    p-&gt;grandparent()-&gt;color = RED;\r\n                    rotate_left(p-&gt;parent);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    void DeleteTree(Node *p) {\r\n        if (!p || p == NIL) {\r\n            return;\r\n        }\r\n        DeleteTree(p-&gt;leftTree);\r\n        DeleteTree(p-&gt;rightTree);\r\n        delete p;\r\n    }\r\npublic:\r\n\r\n    bst() {\r\n        NIL = new Node();\r\n        NIL-&gt;color = BLACK;\r\n        root = NULL;\r\n    }\r\n\r\n    ~bst() {\r\n        if (root)\r\n            DeleteTree(root);\r\n        delete NIL;\r\n    }\r\n\r\n    void inorder() {\r\n        if (root == NULL)\r\n            return;\r\n        inorder(root);\r\n        cout &lt;&lt; endl;\r\n    }\r\n\r\n    void insert(int x) {\r\n        if (root == NULL) {\r\n            root = new Node();\r\n            root-&gt;color = BLACK;\r\n            root-&gt;leftTree = root-&gt;rightTree = NIL;\r\n            root-&gt;value = x;\r\n        } else {\r\n            insert(root, x);\r\n        }\r\n    }\r\n\r\n    bool delete_value(int data) {\r\n        return delete_child(root, data);\r\n    }\r\nprivate:\r\n    Node *root, *NIL;\r\n};</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-71\">71</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-72\">72</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-73\">73</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-74\">74</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-75\">75</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-76\">76</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-77\">77</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-78\">78</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-79\">79</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-80\">80</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-81\">81</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-82\">82</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-83\">83</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-84\">84</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-85\">85</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-86\">86</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-87\">87</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-88\">88</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-89\">89</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-90\">90</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-91\">91</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-92\">92</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-93\">93</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-94\">94</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-95\">95</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-96\">96</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-97\">97</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-98\">98</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-99\">99</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-100\">100</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-101\">101</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-102\">102</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-103\">103</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-104\">104</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-105\">105</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-106\">106</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-107\">107</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-108\">108</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-109\">109</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-110\">110</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-111\">111</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-112\">112</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-113\">113</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-114\">114</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-115\">115</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-116\">116</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-117\">117</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-118\">118</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-119\">119</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-120\">120</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-121\">121</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-122\">122</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-123\">123</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-124\">124</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-125\">125</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-126\">126</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-127\">127</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-128\">128</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-129\">129</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-130\">130</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-131\">131</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-132\">132</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-133\">133</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-134\">134</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-135\">135</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-136\">136</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-137\">137</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-138\">138</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-139\">139</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-140\">140</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-141\">141</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-142\">142</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-143\">143</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-144\">144</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-145\">145</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-146\">146</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-147\">147</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-148\">148</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-149\">149</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-150\">150</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-151\">151</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-152\">152</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-153\">153</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-154\">154</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-155\">155</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-156\">156</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-157\">157</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-158\">158</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-159\">159</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-160\">160</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-161\">161</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-162\">162</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-163\">163</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-164\">164</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-165\">165</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-166\">166</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-167\">167</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-168\">168</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-169\">169</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-170\">170</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-171\">171</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-172\">172</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-173\">173</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-174\">174</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-175\">175</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-176\">176</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-177\">177</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-178\">178</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-179\">179</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-180\">180</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-181\">181</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-182\">182</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-183\">183</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-184\">184</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-185\">185</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-186\">186</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-187\">187</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-188\">188</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-189\">189</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-190\">190</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-191\">191</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-192\">192</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-193\">193</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-194\">194</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-195\">195</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-196\">196</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-197\">197</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-198\">198</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-199\">199</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-200\">200</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-201\">201</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-202\">202</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-203\">203</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-204\">204</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-205\">205</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-206\">206</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-207\">207</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-208\">208</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-209\">209</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-210\">210</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-211\">211</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-212\">212</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-213\">213</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-214\">214</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-215\">215</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-216\">216</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-217\">217</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-218\">218</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-219\">219</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-220\">220</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-221\">221</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-222\">222</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-223\">223</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-224\">224</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-225\">225</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-226\">226</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-227\">227</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-228\">228</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-229\">229</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-230\">230</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-231\">231</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-232\">232</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-233\">233</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-234\">234</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-235\">235</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-236\">236</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-237\">237</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-238\">238</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-239\">239</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-240\">240</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-241\">241</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-242\">242</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-243\">243</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-244\">244</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-245\">245</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-246\">246</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-247\">247</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-248\">248</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-249\">249</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-250\">250</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-251\">251</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-252\">252</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-253\">253</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-254\">254</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-255\">255</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-256\">256</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-257\">257</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-258\">258</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-259\">259</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-260\">260</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-261\">261</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-262\">262</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-263\">263</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-264\">264</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-265\">265</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-266\">266</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-267\">267</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-268\">268</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-269\">269</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-270\">270</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-271\">271</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-272\">272</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-273\">273</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-274\">274</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-275\">275</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-276\">276</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-277\">277</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-278\">278</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-279\">279</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-280\">280</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-281\">281</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-282\">282</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-283\">283</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-284\">284</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-285\">285</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-286\">286</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-287\">287</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-288\">288</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-289\">289</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-290\">290</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-291\">291</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-292\">292</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-293\">293</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-294\">294</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-295\">295</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-296\">296</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-297\">297</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-298\">298</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-299\">299</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-300\">300</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-301\">301</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-302\">302</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-303\">303</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-304\">304</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-305\">305</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-306\">306</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-307\">307</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-308\">308</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-309\">309</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-310\">310</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-311\">311</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-312\">312</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-313\">313</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-314\">314</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-315\">315</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-316\">316</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-317\">317</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-318\">318</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-319\">319</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-320\">320</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-321\">321</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-322\">322</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-323\">323</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-324\">324</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-325\">325</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-326\">326</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-327\">327</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-328\">328</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-329\">329</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-330\">330</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-331\">331</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960b3b51cb86365262181-332\">332</div><div class=\"crayon-num\" data-line=\"crayon-5960b3b51cb86365262181-333\">333</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-1\"><span class=\"crayon-p\">#define BLACK 1</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-2\"><span class=\"crayon-p\">#define RED 0</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-4\"><span class=\"crayon-e\">using </span><span class=\"crayon-t\">namespace</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">std</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-6\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">bst</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-7\"><span class=\"crayon-m\">private</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-8\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Node</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">color</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">Node</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-15\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-16\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-17\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-18\"><span class=\"crayon-h\">            </span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-19\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-21\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-23\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-24\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-25\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-26\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-27\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-28\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-29\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">uncle</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-30\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-31\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-32\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-33\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-34\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-35\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-36\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-37\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-38\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-39\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-40\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-41\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-42\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-43\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-44\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-45\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-46\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-47\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-48\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">gp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-49\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">fa</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-50\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">y</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-51\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-52\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">fa</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">y</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-53\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-54\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">y</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-55\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">y</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-56\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-57\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">fa</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-58\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-59\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-60\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-61\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-62\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-63\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">gp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-64\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">gp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-65\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">gp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-66\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-67\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">gp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-68\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-69\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-70\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-71\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-72\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-73\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-74\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-75\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-76\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-77\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">gp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-78\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">fa</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-79\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">y</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-80\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-81\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">fa</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">y</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-82\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-83\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">y</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-84\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">y</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-85\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-86\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">fa</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-87\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-88\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-89\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-90\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-91\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-92\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">gp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-93\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">gp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-94\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">gp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-95\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-96\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">gp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-97\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-98\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-99\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-100\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">inorder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-101\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-102\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-103\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-104\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-105\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">inorder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-106\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-107\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">cout</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\" \"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-108\"><span class=\"crayon-h\">                </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-109\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-110\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">inorder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-111\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-112\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-113\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">outputColor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">color</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-114\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"BLACK\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"RED\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-115\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-116\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-117\"><span class=\"crayon-h\">    </span><span class=\"crayon-e \">Node*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getSmallestChild</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-118\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-119\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-120\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getSmallestChild</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-121\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-122\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-123\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-124\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-125\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-126\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-127\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-128\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-129\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-130\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-131\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-132\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-133\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-134\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-135\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-136\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">delete_one_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-137\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-138\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-139\"><span class=\"crayon-h\">            </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">smallest</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getSmallestChild</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-140\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">swap</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">smallest</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-141\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">delete_one_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">smallest</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-142\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-143\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-144\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-145\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-146\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-147\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_one_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-148\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-r\">child</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">NIL</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-149\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-150\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-151\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-152\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-153\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-154\"><span class=\"crayon-h\">        </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-155\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-156\"><span class=\"crayon-h\">            </span><span class=\"crayon-i\">delete</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-157\"><span class=\"crayon-h\">            </span><span class=\"crayon-r\">child</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-158\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">child</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-159\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-160\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-161\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-162\"><span class=\"crayon-h\">        </span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-163\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-164\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">child</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-165\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-166\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">child</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-167\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-168\"><span class=\"crayon-h\">        </span><span class=\"crayon-r\">child</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-169\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-170\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-171\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">child</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-172\"><span class=\"crayon-h\">                </span><span class=\"crayon-r\">child</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-173\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-174\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">delete_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">child</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-175\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-176\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-177\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">delete</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-178\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-179\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-180\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-181\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-182\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-183\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-184\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-185\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-186\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-187\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-188\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-189\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-190\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-191\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-192\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-193\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-194\"><span class=\"crayon-h\">                </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-195\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-196\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">delete_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-197\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-198\"><span class=\"crayon-h\">                </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-199\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-200\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-201\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-202\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-203\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-204\"><span class=\"crayon-h\">                        </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-205\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-206\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-207\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-208\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-209\"><span class=\"crayon-h\">                        </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-210\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-211\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-212\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-213\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-214\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-215\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-216\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-217\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-218\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-219\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-220\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-221\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-222\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-223\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-224\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-225\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-226\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-227\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-228\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-229\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-230\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-231\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-232\"><span class=\"crayon-h\">                </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">tmp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Node</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-233\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-234\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-235\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-236\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-237\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">insert_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tmp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-238\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-239\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-240\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-241\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-242\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-243\"><span class=\"crayon-h\">                </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">tmp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Node</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-244\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-245\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-246\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-247\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-248\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">insert_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tmp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-249\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-250\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-251\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-252\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-253\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-254\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-255\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-256\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-257\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-258\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-259\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-260\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">uncle</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-261\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">uncle</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-262\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-263\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">insert_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-264\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-265\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-266\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-267\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-268\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-269\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-270\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-271\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-272\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-273\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-274\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-275\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-276\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-277\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-278\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-279\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-280\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-281\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-282\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-283\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-284\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-285\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-286\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-287\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-288\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DeleteTree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-289\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-290\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-291\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-292\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">DeleteTree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-293\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">DeleteTree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-294\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">delete</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-295\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-296\"><span class=\"crayon-m\">public</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-297\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-298\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">bst</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-299\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Node</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-300\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-301\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-302\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-303\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-304\"><span class=\"crayon-h\">    </span><span class=\"crayon-o\">~</span><span class=\"crayon-e\">bst</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-305\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-306\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">DeleteTree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-307\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">delete </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-308\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-309\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-310\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">inorder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-311\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-312\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-313\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">inorder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-314\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">cout</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">endl</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-315\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-316\"> </div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-317\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-318\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-319\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Node</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-320\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-321\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-322\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-323\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-324\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-325\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-326\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-327\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-328\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_value</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-329\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-330\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-331\"><span class=\"crayon-m\">private</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960b3b51cb86365262181-332\"><span class=\"crayon-h\">    </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960b3b51cb86365262181-333\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0547 seconds] -->\r\n<p></p>\n<h1 class=\"First\">4. B树</h1>\n<p>B树也是一种用于查找的平衡树，但是它不是二叉树。</p>\n<p><strong>B树的定义：</strong>B树（<span class=\"LangWithName\"><span lang=\"en\" xml:lang=\"en\">B-tree）是一种树状数据结构，能够用来存储排序后的数据。这种数据结构能够让查找数据、循序存取、插入数据及删除的动作，都在对数时间内完成。B树，概括来说是一个一般化的二叉查找树，可以拥有多于2个子节点。与自平衡二叉查找树不同，B-树为系统最优化大块数据的读和写操作。B-tree算法减少定位记录时所经历的中间过程，从而加快存取速度。这种数据结构常被应用在数据库和文件系统的实作上。</span></span></p>\n<p>在B树中查找给定关键字的方法是，首先把根结点取来，在根结点所包含的关键字K1,…,Kn查找给定的关键字（可用顺序查找或二分查找法），若找到等于给定值的关键字，则查找成功；否则，一定可以确定要查找的关键字在Ki与Ki+1之间，Pi为指向子树根节点的指针，此时取指针Pi所指的结点继续查找，直至找到，或指针Pi为空时查找失败。</p>\n<p>B树作为一种多路搜索树（并不是二叉的）：</p>\n<p>1) 定义任意非叶子结点最多只有M个儿子；且M&gt;2；</p>\n<p>2) 根结点的儿子数为[2, M]；</p>\n<p>3) 除根结点以外的非叶子结点的儿子数为[M/2, M]；</p>\n<p>4) 每个结点存放至少M/2-1（取上整）和至多M-1个关键字；（至少2个关键字）</p>\n<p>5) 非叶子结点的关键字个数=指向儿子的指针个数-1；</p>\n<p>6) 非叶子结点的关键字：K[1], K[2], …, K[M-1]；且K[i] &lt; K[i+1]；</p>\n<p>7) 非叶子结点的指针：P[1], P[2], …, P[M]；其中P[1]指向关键字小于K[1]的子树，P[M]指向关键字大于K[M-1]的子树，其它P[i]指向关键字属于(K[i-1], K[i])的子树；</p>\n<p>8) 所有叶子结点位于同一层；</p>\n<p>如下图为一个M=3的B树示例：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/0178191b698ab75a98fa1d0bb03cc51f.jpg\"><img class=\"aligncenter wp-image-111700 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0178191b698ab75a98fa1d0bb03cc51f.jpg\" alt=\"4\" width=\"624\" height=\"268\"></a></p>\n<p>B树创建的示意图：</p>\n<p><img class=\"aligncenter\" src=\"http://wx3.sinaimg.cn/large/7cc829d3gy1fh5p12mz57g20qm06d4qq.gif\" width=\"958\" height=\"229\"></p>\n<h1 class=\"First\">5. B+树</h1>\n<p>B+树是B树的变体，也是一种多路搜索树：</p>\n<p>1) 其定义基本与B-树相同，除了：</p>\n<p>2) 非叶子结点的子树指针与关键字个数相同；</p>\n<p>3) 非叶子结点的子树指针P[i]，指向关键字值属于[K[i], K[i+1])的子树（B-树是开区间）；</p>\n<p>4) 为所有叶子结点增加一个链指针；</p>\n<p>5) 所有关键字都在叶子结点出现；</p>\n<p>下图为M=3的B+树的示意图：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/0972ef809f286cc29cd2d94687b2ef2d.jpg\"><img class=\"aligncenter wp-image-111701 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0972ef809f286cc29cd2d94687b2ef2d.jpg\" alt=\"4\" width=\"569\" height=\"345\"></a></p>\n<p>B+树的搜索与B树也基本相同，区别是B+树只有达到叶子结点才命中（B树可以在非叶子结点命中），其性能也等价于在关键字全集做一次二分查找；</p>\n<p><strong>B+的性质：</strong></p>\n<p>1.所有关键字都出现在叶子结点的链表中（稠密索引），且链表中的关键字恰好是有序的；</p>\n<p>2.不可能在非叶子结点命中；</p>\n<p>3.非叶子结点相当于是叶子结点的索引（稀疏索引），叶子结点相当于是存储（关键字）数据的数据层；</p>\n<p>4.更适合文件索引系统。</p>\n<p>下面为一个B+树创建的示意图：</p>\n<p><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/large/7cc829d3gy1fh5p2ef94jg20rz05i7wi.gif\" width=\"1007\" height=\"198\"></p>\n<h1 class=\"First\">6. B*树</h1>\n<p>B*树是B+树的变体，在B+树的非根和非叶子结点再增加指向兄弟的指针，将结点的最低利用率从1/2提高到2/3。</p>\n<p>B*树如下图所示：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/eb5835f421e029240105ccb8e80279ee.jpg\"><img class=\"aligncenter wp-image-111702 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/eb5835f421e029240105ccb8e80279ee.jpg\" alt=\"4\" width=\"569\" height=\"345\"></a></p>\n<p>B*树定义了非叶子结点关键字个数至少为(2/3)*M，即块的最低使用率为2/3（代替B+树的1/2）；</p>\n<p>B+树的分裂：当一个结点满时，分配一个新的结点，并将原结点中1/2的数据复制到新结点，最后在父结点中增加新结点的指针；B+树的分裂只影响原结点和父结点，而不会影响兄弟结点，所以它不需要指向兄弟的指针；</p>\n<p>B*树的分裂：当一个结点满时，如果它的下一个兄弟结点未满，那么将一部分数据移到兄弟结点中，再在原结点插入关键字，最后修改父结点中兄弟结点的关键字（因为兄弟结点的关键字范围改变了）；如果兄弟也满了，则在原结点与兄弟结点之间增加新结点，并各复制1/3的数据到新结点，最后在父结点增加新结点的指针；</p>\n<p>所以，B*树分配新结点的概率比B+树要低，空间使用率更高。</p>\n<h1 class=\"First\">7. Trie树</h1>\n<p>Tire树称为字典树，又称单词查找树，Trie树，是一种树形结构，是一种哈希树的变种。典型应用是用于统计，排序和保存大量的字符串（但不仅限于字符串），所以经常被搜索引擎系统用于文本词频统计。<strong>它的优点是：利用字符串的公共前缀来减少查询时间，最大限度地减少无谓的字符串比较，查询效率比哈希树高。</strong></p>\n<div class=\"para\"><strong>Tire树的三个基本性质：</strong></div>\n<div class=\"para\">1) 根节点不包含字符，除根节点外每一个节点都只包含一个字符；</div>\n<div class=\"para\">2) 从根节点到某一节点，路径上经过的字符连接起来，为该节点对应的字符串；</div>\n<div class=\"para\">3) 每个节点的所有子节点包含的字符都不相同。</div>\n<p><strong>Tire树的应用：</strong></p>\n<p>1) <span class=\"headline-content\">串的快速检索</span></p>\n<p class=\"para\">给出N个单词组成的熟词表，以及一篇全用小写英文书写的文章，请你按最早出现的顺序写出所有不在熟词表中的生词。在这道题中，我们可以用数组枚举，用哈希，用字典树，先把熟词建一棵树，然后读入文章进行比较，这种方法效率是比较高的。</p>\n<p class=\"para\"><span class=\"headline-content\">2) “串”排序</span></p>\n<p class=\"para\">给定N个互不相同的仅由一个单词构成的英文名，让你将他们按字典序从小到大输出。用字典树进行排序，采用数组的方式创建字典树，这棵树的每个结点的所有儿子很显然地按照其字母大小排序。对这棵树进行先序遍历即可。</p>\n<p class=\"para\"><span class=\"headline-content\">3) 最长公共前缀</span></p>\n<p class=\"para\">对所有串建立字典树，对于两个串的最长公共前缀的长度即他们所在的结点的公共祖先个数，于是，问题就转化为求公共祖先的问题。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111680\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111680votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111680\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 3 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 2 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>');
INSERT INTO `jobbole_article` VALUES ('Linux TCP GSO 和 TSO 实现', '2017-07-08', 'http://blog.jobbole.com/111668/', '3c4107179d9db7fa5cdd457d1cd8fd80', 'http://jbcdn2.b0.upaiyun.com/2015/10/23426c26d6b88a782a1d894de8e89bca.jpg', 'full/a6e095311cee5dbfc6a3b7e5127f63181f1ad769.jpg', '0', '0', '1', 'IT技术,Linux', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://blog.chinaunix.net/uid-28541347-id-5763844.html\">lvyilong316</a>   </div><div>（注：kernel版本：linux 2.6.32）\n<h2>概念</h2>\n<p>TSO(TCP Segmentation Offload): 是一种利用网卡来对大数据包进行自动分段，降低CPU负载的技术。 其主要是延迟分段。</p>\n<p>GSO(Generic Segmentation Offload): GSO是协议栈是否推迟分段，在发送到网卡之前判断网卡是否支持TSO，如果网卡支持TSO则让网卡分段，否则协议栈分完段再交给驱动。 <b>如果TSO</b><b>开启，GSO</b><b>会自动开启。</b></p>\n<p>以下是TSO和GSO的组合关系：</p>\n<ul>\n<li>GSO开启， TSO开启: 协议栈推迟分段，并直接传递大数据包到网卡，让网卡自动分段</li>\n<li>GSO开启， TSO关闭: 协议栈推迟分段，在最后发送到网卡前才执行分段</li>\n<li>GSO关闭， TSO开启: 同GSO开启， TSO开启</li>\n<li>GSO关闭， TSO关闭: 不推迟分段，在tcp_sendmsg中直接发送MSS大小的数据包</li>\n</ul>\n<h2>开启GSO/TSO</h2>\n<p>驱动程序在注册网卡设备的时候默认开启GSO: NETIF_F_GSO</p>\n<p>驱动程序会根据网卡硬件是否支持来设置TSO: NETIF_F_TSO</p>\n<p>可以通过ethtool -K来开关GSO/TSO</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78c5652781148\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#define NETIF_F_SOFT_FEATURES (NETIF_F_GSO | NETIF_F_GRO)\r\nint register_netdevice(struct net_device *dev)\r\n{\r\n              ...\r\n              /* Transfer changeable features to wanted_features and enable\r\n               * software offloads (GSO and GRO).\r\n               */\r\n              dev-&gt;hw_features |= NETIF_F_SOFT_FEATURES;\r\n              dev-&gt;features |= NETIF_F_SOFT_FEATURES; //默认开启GRO/GSO\r\n              dev-&gt;wanted_features = dev-&gt;features &amp; dev-&gt;hw_features;\r\n              ...\r\n}\r\nstatic int ixgbe_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\n              ...\r\n              netdev-&gt;features = NETIF_F_SG |\r\n                                              NETIF_F_TSO |\r\n                                              NETIF_F_TSO6 |\r\n                                              NETIF_F_RXHASH |\r\n                                              NETIF_F_RXCSUM |\r\n                                              NETIF_F_HW_CSUM;\r\n              register_netdev(netdev);\r\n              ...\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-24\">24</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-1\"><span class=\"crayon-p\">#define NETIF_F_SOFT_FEATURES (NETIF_F_GSO | NETIF_F_GRO)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-2\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">register_netdevice</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">net_device *</span><span class=\"crayon-v\">dev</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-4\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-5\"><span class=\"crayon-h\">              </span><span class=\"crayon-c\">/* Transfer changeable features to wanted_features and enable</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-6\"><span class=\"crayon-c\">               * software offloads (GSO and GRO).</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-7\"><span class=\"crayon-c\">               */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-8\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hw_features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_SOFT_FEATURES</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-9\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_SOFT_FEATURES</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//默认开启GRO/GSO</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-10\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">wanted_features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hw_features</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-11\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-12\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-13\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ixgbe_probe</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">pci_dev *</span><span class=\"crayon-v\">pdev</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">pci_device_id *</span><span class=\"crayon-v\">ent</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-14\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-15\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-16\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">netdev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_SG</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-17\"><span class=\"crayon-h\">                                              </span><span class=\"crayon-v\">NETIF_F_TSO</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-18\"><span class=\"crayon-h\">                                              </span><span class=\"crayon-v\">NETIF_F_TSO6</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-19\"><span class=\"crayon-h\">                                              </span><span class=\"crayon-v\">NETIF_F_RXHASH</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-20\"><span class=\"crayon-h\">                                              </span><span class=\"crayon-v\">NETIF_F_RXCSUM</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-21\"><span class=\"crayon-h\">                                              </span><span class=\"crayon-v\">NETIF_F_HW_CSUM</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-22\"><span class=\"crayon-h\">              </span><span class=\"crayon-e\">register_netdev</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">netdev</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-23\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-24\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0029 seconds] -->\r\n<p></p>\n<h2>是否推迟分段</h2>\n<p>从上面我们知道GSO/TSO是否开启是保存在dev-&gt;features中，而设备和路由关联，当我们查询到路由后就可以把配置保存在sock中。</p>\n<p>比如在tcp_v4_connect和tcp_v4_syn_recv_sock都会调用sk_setup_caps来设置GSO/TSO配置。</p>\n<p>需要注意的是，只要开启了GSO，即使硬件不支持TSO，也会设置NETIF_F_TSO，使得sk_can_gso(sk)在GSO开启或者TSO开启的时候都返回true</p>\n<p>l  <b>sk_setup_caps</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78d1805728484\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#define NETIF_F_GSO_SOFTWARE (NETIF_F_TSO | NETIF_F_TSO_ECN | NETIF_F_TSO6)\r\n#define NETIF_F_TSO (SKB_GSO_TCPV4 &lt;&lt; NETIF_F_GSO_SHIFT)\r\n\r\nvoid sk_setup_caps(struct sock *sk, struct dst_entry *dst)\r\n{\r\n              __sk_dst_set(sk, dst);\r\n              sk-&gt;sk_route_caps = dst-&gt;dev-&gt;features;\r\n              if (sk-&gt;sk_route_caps &amp; NETIF_F_GSO) /*GSO默认都会开启*/\r\n                             sk-&gt;sk_route_caps |= NETIF_F_GSO_SOFTWARE; /*打开TSO*/\r\n              if (sk_can_gso(sk)) { /*对于tcp这里会成立*/\r\n                             if (dst-&gt;header_len) {\r\n                                           sk-&gt;sk_route_caps &amp;= ~NETIF_F_GSO_MASK;\r\n                             } else {\r\n                                           sk-&gt;sk_route_caps |= NETIF_F_SG | NETIF_F_HW_CSUM;\r\n                                           sk-&gt;sk_gso_max_size = dst-&gt;dev-&gt;gso_max_size; /*GSO_MAX_SIZE=65536*/\r\n                             }\r\n              }\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78d1805728484-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d1805728484-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d1805728484-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d1805728484-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d1805728484-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d1805728484-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d1805728484-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d1805728484-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d1805728484-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d1805728484-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d1805728484-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d1805728484-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d1805728484-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d1805728484-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d1805728484-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d1805728484-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d1805728484-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d1805728484-18\">18</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78d1805728484-1\"><span class=\"crayon-p\">#define NETIF_F_GSO_SOFTWARE (NETIF_F_TSO | NETIF_F_TSO_ECN | NETIF_F_TSO6)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d1805728484-2\"><span class=\"crayon-p\">#define NETIF_F_TSO (SKB_GSO_TCPV4 &lt;&lt; NETIF_F_GSO_SHIFT)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d1805728484-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d1805728484-4\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_setup_caps</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">dst_entry *</span><span class=\"crayon-v\">dst</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d1805728484-5\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d1805728484-6\"><span class=\"crayon-h\">              </span><span class=\"crayon-e\">__sk_dst_set</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dst</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d1805728484-7\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dst</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">features</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d1805728484-8\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_GSO</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*GSO默认都会开启*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d1805728484-9\"><span class=\"crayon-h\">                             </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_GSO_SOFTWARE</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*打开TSO*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d1805728484-10\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">sk_can_gso</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*对于tcp这里会成立*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d1805728484-11\"><span class=\"crayon-h\">                             </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">dst</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">header_len</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d1805728484-12\"><span class=\"crayon-h\">                                           </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">~</span><span class=\"crayon-v\">NETIF_F_GSO_MASK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d1805728484-13\"><span class=\"crayon-h\">                             </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d1805728484-14\"><span class=\"crayon-h\">                                           </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_SG</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_HW_CSUM</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d1805728484-15\"><span class=\"crayon-h\">                                           </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_gso_max_size</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dst</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_max_size</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*GSO_MAX_SIZE=65536*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d1805728484-16\"><span class=\"crayon-h\">                             </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d1805728484-17\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d1805728484-18\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0030 seconds] -->\r\n<p>从上面可以看出，如果设备开启了GSO，sock都会将TSO标志打开，但是注意这和硬件是否开启TSO无关，硬件的TSO取决于硬件自身特性的支持。下面看下sk_can_gso的逻辑。</p>\n<p>l  <b>sk_can_gso</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78d5304457226\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic inline int sk_can_gso(const struct sock *sk)\r\n{\r\n    /*对于tcp，在tcp_v4_connect中被设置：sk-&gt;sk_gso_type = SKB_GSO_TCPV4*/\r\n              return net_gso_ok(sk-&gt;sk_route_caps, sk-&gt;sk_gso_type);\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78d5304457226-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d5304457226-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d5304457226-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d5304457226-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d5304457226-5\">5</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78d5304457226-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">inline </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_can_gso</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d5304457226-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d5304457226-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/*对于tcp，在tcp_v4_connect中被设置：sk-&gt;sk_gso_type = SKB_GSO_TCPV4*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d5304457226-4\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">net_gso_ok</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_gso_type</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d5304457226-5\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p>l  <b>net_gso_ok</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78d9972186182\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic inline int net_gso_ok(int features, int gso_type)\r\n{\r\n              int feature = gso_type &lt;&lt; NETIF_F_GSO_SHIFT;\r\n              return (features &amp; feature) == feature;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78d9972186182-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d9972186182-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d9972186182-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d9972186182-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d9972186182-5\">5</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78d9972186182-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">inline </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">net_gso_ok</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">features</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gso_type</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d9972186182-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d9972186182-3\"><span class=\"crayon-h\">              </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">feature</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gso_type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_GSO_SHIFT</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d9972186182-4\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d9972186182-5\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0011 seconds] -->\r\n<p>由于对于tcp 在sk_setup_caps中sk-&gt;sk_route_caps也被设置有SKB_GSO_TCPV4，所以整个sk_can_gso成立。</p>\n<h2>GSO的数据包长度</h2>\n<p>对紧急数据包或GSO/TSO都不开启的情况，才不会推迟发送， 默认使用当前MSS。开启GSO后，tcp_send_mss返回mss和单个skb的GSO大小，为mss的整数倍。</p>\n<p>l  <b>tcp_send_mss</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78dc857827901\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic int tcp_send_mss(struct sock *sk, int *size_goal, int flags)\r\n{\r\n              int mss_now;\r\n \r\n              mss_now = tcp_current_mss(sk);/*通过ip option，SACKs及pmtu确定当前的mss*/\r\n              *size_goal = tcp_xmit_size_goal(sk, mss_now, !(flags &amp; MSG_OOB));\r\n \r\n              return mss_now;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78dc857827901-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78dc857827901-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78dc857827901-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78dc857827901-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78dc857827901-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78dc857827901-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78dc857827901-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78dc857827901-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78dc857827901-9\">9</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78dc857827901-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_send_mss</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78dc857827901-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78dc857827901-3\"><span class=\"crayon-h\">              </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78dc857827901-4\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78dc857827901-5\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_current_mss</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">/*通过ip option，SACKs及pmtu确定当前的mss*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78dc857827901-6\"><span class=\"crayon-h\">              </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_xmit_size_goal</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MSG_OOB</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78dc857827901-7\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78dc857827901-8\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78dc857827901-9\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0016 seconds] -->\r\n<p>l  <b>tcp_xmit_size_goal</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78e0903404434\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic unsigned int tcp_xmit_size_goal(struct sock *sk, u32 mss_now,\r\n                                                                int large_allowed)\r\n{\r\n              struct tcp_sock *tp = tcp_sk(sk);\r\n              u32 xmit_size_goal, old_size_goal;\r\n \r\n              xmit_size_goal = mss_now;\r\n    /*这里large_allowed表示是否是紧急数据*/\r\n              if (large_allowed &amp;&amp; sk_can_gso(sk)) { /*如果不是紧急数据且支持GSO*/\r\n                             xmit_size_goal = ((sk-&gt;sk_gso_max_size - 1) -\r\n                                                           inet_csk(sk)-&gt;icsk_af_ops-&gt;net_header_len -\r\n                                                           inet_csk(sk)-&gt;icsk_ext_hdr_len -\r\n                                                           tp-&gt;tcp_header_len);/*xmit_size_goal为gso最大分段大小减去tcp和ip头部长度*/\r\n \r\n                             xmit_size_goal = tcp_bound_to_half_wnd(tp, xmit_size_goal);/*最多达到收到的最大rwnd窗口通告的一半*/\r\n \r\n                             /* We try hard to avoid divides here */\r\n                             old_size_goal = tp-&gt;xmit_size_goal_segs * mss_now;\r\n \r\n                             if (likely(old_size_goal &lt;= xmit_size_goal &amp;&amp;\r\n                                              old_size_goal + mss_now &gt; xmit_size_goal)) {\r\n                                           xmit_size_goal = old_size_goal; /*使用老的xmit_size*/\r\n                             } else {\r\n                                           tp-&gt;xmit_size_goal_segs = xmit_size_goal / mss_now;\r\n                                           xmit_size_goal = tp-&gt;xmit_size_goal_segs * mss_now; /*使用新的xmit_size*/\r\n                             }\r\n              }\r\n \r\n              return max(xmit_size_goal, mss_now);\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-30\">30</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_xmit_size_goal</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">u32 </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-2\"><span class=\"crayon-h\">                                                                </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">large_allowed</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-4\"><span class=\"crayon-h\">              </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">tcp_sock *</span><span class=\"crayon-v\">tp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_sk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-5\"><span class=\"crayon-h\">              </span><span class=\"crayon-e\">u32 </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">old_size_goal</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-6\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-7\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/*这里large_allowed表示是否是紧急数据*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-9\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">large_allowed</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_can_gso</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*如果不是紧急数据且支持GSO*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-10\"><span class=\"crayon-h\">                             </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_gso_max_size</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-11\"><span class=\"crayon-h\">                                                           </span><span class=\"crayon-e\">inet_csk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">icsk_af_ops</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">net_header_len</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-12\"><span class=\"crayon-h\">                                                           </span><span class=\"crayon-e\">inet_csk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">icsk_ext_hdr_len</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-13\"><span class=\"crayon-h\">                                                           </span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">tcp_header_len</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">/*xmit_size_goal为gso最大分段大小减去tcp和ip头部长度*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-14\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-15\"><span class=\"crayon-h\">                             </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_bound_to_half_wnd</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">/*最多达到收到的最大rwnd窗口通告的一半*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-16\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-17\"><span class=\"crayon-h\">                             </span><span class=\"crayon-c\">/* We try hard to avoid divides here */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-18\"><span class=\"crayon-h\">                             </span><span class=\"crayon-v\">old_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e \">xmit_size_goal_segs *</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-19\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-20\"><span class=\"crayon-h\">                             </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">likely</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">old_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-21\"><span class=\"crayon-h\">                                              </span><span class=\"crayon-v\">old_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-22\"><span class=\"crayon-h\">                                           </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">old_size_goal</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*使用老的xmit_size*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-23\"><span class=\"crayon-h\">                             </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-24\"><span class=\"crayon-h\">                                           </span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">xmit_size_goal_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-25\"><span class=\"crayon-h\">                                           </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e \">xmit_size_goal_segs *</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*使用新的xmit_size*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-26\"><span class=\"crayon-h\">                             </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-27\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-28\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-29\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-30\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0050 seconds] -->\r\n<p>l  <b>tcp_sendmsg</b></p>\n<p>应用程序send()数据后，会在tcp_sendmsg中尝试在同一个skb，保存size_goal大小的数据，然后再通过tcp_push把这些包通过tcp_write_xmit发出去</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78e4935095387\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nint tcp_sendmsg(struct kiocb *iocb, struct socket *sock, struct msghdr *msg,\r\n                             size_t size)\r\n{\r\n    struct sock *sk = sock-&gt;sk;\r\n    struct iovec *iov;\r\n    struct tcp_sock *tp = tcp_sk(sk);\r\n    struct sk_buff *skb;\r\n    int iovlen, flags;\r\n    int mss_now, size_goal;\r\n    int err, copied;\r\n    long timeo;\r\n \r\n    lock_sock(sk);\r\n    TCP_CHECK_TIMER(sk);\r\n \r\n    flags = msg-&gt;msg_flags;\r\n    timeo = sock_sndtimeo(sk, flags &amp; MSG_DONTWAIT);\r\n \r\n    /* Wait for a connection to finish. */\r\n    if ((1 &lt;&lt; sk-&gt;sk_state) &amp; ~(TCPF_ESTABLISHED | TCPF_CLOSE_WAIT))\r\n        if ((err = sk_stream_wait_connect(sk, &amp;timeo)) != 0)\r\n             goto out_err;\r\n \r\n    /* This should be in poll */\r\n    clear_bit(SOCK_ASYNC_NOSPACE, &amp;sk-&gt;sk_socket-&gt;flags);\r\n    /* size_goal表示GSO支持的大小，为mss的整数倍，不支持GSO时则和mss相等 */\r\n    mss_now = tcp_send_mss(sk, &amp;size_goal, flags);/*返回值mss_now为真实mss*/\r\n \r\n    /* Ok commence sending. */\r\n    iovlen = msg-&gt;msg_iovlen;\r\n    iov = msg-&gt;msg_iov;\r\n    copied = 0;\r\n \r\n    err = -EPIPE;\r\n    if (sk-&gt;sk_err || (sk-&gt;sk_shutdown &amp; SEND_SHUTDOWN))\r\n        goto out_err;\r\n \r\n    while (--iovlen &gt;= 0) {\r\n        size_t seglen = iov-&gt;iov_len;\r\n        unsigned char __user *from = iov-&gt;iov_base;\r\n \r\n        iov++;\r\n \r\n        while (seglen &gt; 0) {\r\n            int copy = 0;\r\n            int max = size_goal; /*每个skb中填充的数据长度初始化为size_goal*/\r\n            /* 从sk-&gt;sk_write_queue中取出队尾的skb，因为这个skb可能还没有被填满 */\r\n            skb = tcp_write_queue_tail(sk);\r\n            if (tcp_send_head(sk)) { /*如果之前还有未发送的数据*/\r\n                if (skb-&gt;ip_summed == CHECKSUM_NONE) /*比如路由变更，之前的不支持TSO,现在的支持了*/\r\n                    max = mss_now; /*上一个不支持GSO的skb，继续不支持*/\r\n                copy = max - skb-&gt;len; /*copy为每次想skb中拷贝的数据长度*/\r\n            }\r\n           /*copy&lt;=0表示不能合并到之前skb做GSO*/\r\n           if (copy &lt;= 0) {\r\nnew_segment:\r\n               /* Allocate new segment. If the interface is SG,\r\n                * allocate skb fitting to single page.\r\n                */\r\n               /* 内存不足，需要等待 */\r\n               if (!sk_stream_memory_free(sk))\r\n                   goto wait_for_sndbuf;\r\n               /* 分配新的skb */\r\n               skb = sk_stream_alloc_skb(sk, select_size(sk), sk-&gt;sk_allocation);\r\n               if (!skb)\r\n                   goto wait_for_memory;\r\n \r\n               /*\r\n                * Check whether we can use HW checksum.\r\n                */\r\n               /*如果硬件支持checksum，则将skb-&gt;ip_summed设置为CHECKSUM_PARTIAL，表示由硬件计算校验和*/\r\n               if (sk-&gt;sk_route_caps &amp; NETIF_F_ALL_CSUM)\r\n                   skb-&gt;ip_summed = CHECKSUM_PARTIAL;\r\n               /*将skb加入sk-&gt;sk_write_queue队尾, 同时去掉skb的TCP_NAGLE_PUSH标记*/\r\n               skb_entail(sk, skb);\r\n               copy = size_goal; /*这里将每次copy的大小设置为size_goal，即GSO支持的大小*/\r\n               max = size_goal;\r\n           }\r\n \r\n           /* Try to append data to the end of skb. */\r\n           if (copy &gt; seglen)\r\n               copy = seglen;\r\n \r\n           /* Where to copy to? */\r\n           if (skb_tailroom(skb) &gt; 0) { /*如果skb的线性区还有空间，则先填充skb的线性区*/\r\n               /* We have some space in skb head. */\r\n               if (copy &gt; skb_tailroom(skb))\r\n                   copy = skb_tailroom(skb);\r\n               if ((err = skb_add_data(skb, from, copy)) != 0) /*copy用户态数据到skb线性区*/\r\n                   goto do_fault;\r\n           } else { /*否则尝试向SG的frags中拷贝*/\r\n               int merge = 0;\r\n               int i = skb_shinfo(skb)-&gt;nr_frags;\r\n               struct page *page = TCP_PAGE(sk);\r\n               int off = TCP_OFF(sk);\r\n \r\n               if (skb_can_coalesce(skb, i, page, off) &amp;&amp; off != PAGE_SIZE) {/*pfrag-&gt;page和frags[i-1]是否使用相同页，并且page_offset相同*/\r\n                   /* We can extend the last page\r\n                   * fragment. */\r\n                   merge = 1; /*说明和之前frags中是同一个page，需要merge*/\r\n               } else if (i == MAX_SKB_FRAGS || (!i &amp;&amp; !(sk-&gt;sk_route_caps &amp; NETIF_F_SG))) {\r\n                   /* Need to add new fragment and cannot\r\n                    * do this because interface is non-SG,\r\n                    * or because all the page slots are\r\n                    * busy. */\r\n                   /*如果设备不支持SG，或者非线性区frags已经达到最大，则创建新的skb分段*/\r\n                   tcp_mark_push(tp, skb); /*标记push flag*/\r\n                       goto new_segment;\r\n               } else if (page) {\r\n                   if (off == PAGE_SIZE) {\r\n                       put_page(page); /*增加page引用计数*/\r\n                       TCP_PAGE(sk) = page = NULL;\r\n                       off = 0;\r\n                   }\r\n              } else\r\n                  off = 0;\r\n                  if (copy &gt; PAGE_SIZE - off)\r\n                  copy = PAGE_SIZE - off;\r\n                  if (!sk_wmem_schedule(sk, copy))\r\n                      goto wait_for_memory;\r\n \r\n                 if (!page) {\r\n                     /* Allocate new cache page. */\r\n                     if (!(page = sk_stream_alloc_page(sk)))\r\n                     goto wait_for_memory;\r\n                 }\r\n \r\n                 err = skb_copy_to_page(sk, from, skb, page, off, copy); /*拷贝数据到page中*/\r\n                 if (err) {\r\n                     /* If this page was new, give it to the\r\n                      * socket so it does not get leaked.\r\n                      */\r\n                     if (!TCP_PAGE(sk)) {\r\n                         TCP_PAGE(sk) = page;\r\n                         TCP_OFF(sk) = 0;\r\n                     }\r\n                     goto do_error;\r\n                }\r\n \r\n                /* Update the skb. */\r\n                if (merge) { /*pfrag和frags[i - 1]是相同的*/\r\n                     skb_shinfo(skb)-&gt;frags[i - 1].size += copy;\r\n                } else {\r\n                    skb_fill_page_desc(skb, i, page, off, copy);\r\n                    if (TCP_PAGE(sk)) {\r\n                        get_page(page);\r\n                    } else if (off + copy &lt; PAGE_SIZE) {\r\n                        get_page(page);\r\n                        TCP_PAGE(sk) = page;\r\n                    }\r\n                }\r\n                TCP_OFF(sk) = off + copy;\r\n            }\r\n            if (!copied)\r\n                TCP_SKB_CB(skb)-&gt;flags &amp;= ~TCPCB_FLAG_PSH;\r\n \r\n            tp-&gt;write_seq += copy;\r\n            TCP_SKB_CB(skb)-&gt;end_seq += copy;\r\n            skb_shinfo(skb)-&gt;gso_segs = 0; /*清零tso分段数，让tcp_write_xmit去计算*/\r\n            from += copy;\r\n            copied += copy;\r\n            if ((seglen -= copy) == 0 &amp;&amp; iovlen == 0)\r\n                goto out;\r\n            /* 还有数据没copy，并且没有达到最大可拷贝的大小(注意这里max之前被赋值为size_goal，即GSO支持的大小)， 尝试往该skb继续添加数据*/\r\n            if (skb-&gt;len &lt; max || (flags &amp; MSG_OOB))\r\n                continue;\r\n            /*下面的逻辑就是：还有数据没copy，但是当前skb已经满了，所以可以发送了(但不是一定要发送)*/\r\n            if (forced_push(tp)) { /*超过最大窗口的一半没有设置push了*/\r\n                tcp_mark_push(tp, skb); /*设置push标记，更新pushed_seq*/\r\n                __tcp_push_pending_frames(sk, mss_now, TCP_NAGLE_PUSH); /*调用tcp_write_xmit马上发送*/\r\n            } else if (skb == tcp_send_head(sk)) /*第一个包，直接发送*/\r\n                tcp_push_one(sk, mss_now);\r\n                continue; /*说明发送队列前面还有skb等待发送，且距离之前push的包还不是非常久*/\r\nwait_for_sndbuf:\r\n                set_bit(SOCK_NOSPACE, &amp;sk-&gt;sk_socket-&gt;flags);\r\nwait_for_memory:\r\n                if (copied)/*先把copied的发出去再等内存*/\r\n                    tcp_push(sk, flags &amp; ~MSG_MORE, mss_now, TCP_NAGLE_PUSH);\r\n               /*阻塞等待内存*/\r\n               if ((err = sk_stream_wait_memory(sk, &amp;timeo)) != 0)\r\n                   goto do_error;\r\n               mss_now = tcp_send_mss(sk, &amp;size_goal, flags);\r\n          }\r\n      }\r\n \r\nout:\r\n      if (copied) /*所有数据都放到发送队列中了，调用tcp_push发送*/\r\n          tcp_push(sk, flags, mss_now, tp-&gt;nonagle);\r\n      TCP_CHECK_TIMER(sk);\r\n      release_sock(sk);\r\n      return copied;\r\n \r\ndo_fault:\r\n      if (!skb-&gt;len) {\r\n          tcp_unlink_write_queue(skb, sk);\r\n          /* It is the one place in all of TCP, except connection\r\n           * reset, where we can be unlinking the send_head.\r\n           */\r\n          tcp_check_send_head(sk, skb);\r\n          sk_wmem_free_skb(sk, skb);\r\n      }\r\n \r\ndo_error:\r\n      if (copied)\r\n          goto out;\r\nout_err:\r\n      err = sk_stream_error(sk, flags, err);\r\n      TCP_CHECK_TIMER(sk);\r\n      release_sock(sk);\r\n      return err;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-71\">71</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-72\">72</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-73\">73</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-74\">74</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-75\">75</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-76\">76</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-77\">77</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-78\">78</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-79\">79</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-80\">80</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-81\">81</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-82\">82</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-83\">83</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-84\">84</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-85\">85</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-86\">86</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-87\">87</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-88\">88</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-89\">89</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-90\">90</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-91\">91</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-92\">92</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-93\">93</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-94\">94</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-95\">95</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-96\">96</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-97\">97</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-98\">98</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-99\">99</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-100\">100</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-101\">101</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-102\">102</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-103\">103</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-104\">104</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-105\">105</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-106\">106</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-107\">107</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-108\">108</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-109\">109</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-110\">110</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-111\">111</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-112\">112</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-113\">113</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-114\">114</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-115\">115</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-116\">116</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-117\">117</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-118\">118</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-119\">119</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-120\">120</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-121\">121</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-122\">122</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-123\">123</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-124\">124</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-125\">125</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-126\">126</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-127\">127</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-128\">128</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-129\">129</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-130\">130</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-131\">131</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-132\">132</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-133\">133</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-134\">134</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-135\">135</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-136\">136</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-137\">137</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-138\">138</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-139\">139</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-140\">140</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-141\">141</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-142\">142</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-143\">143</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-144\">144</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-145\">145</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-146\">146</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-147\">147</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-148\">148</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-149\">149</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-150\">150</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-151\">151</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-152\">152</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-153\">153</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-154\">154</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-155\">155</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-156\">156</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-157\">157</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-158\">158</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-159\">159</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-160\">160</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-161\">161</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-162\">162</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-163\">163</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-164\">164</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-165\">165</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-166\">166</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-167\">167</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-168\">168</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-169\">169</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-170\">170</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-171\">171</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-172\">172</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-173\">173</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-174\">174</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-175\">175</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-176\">176</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-177\">177</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-178\">178</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-179\">179</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-180\">180</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-181\">181</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-182\">182</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-183\">183</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-184\">184</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-185\">185</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-186\">186</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-187\">187</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-188\">188</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-189\">189</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-190\">190</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-191\">191</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-192\">192</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-193\">193</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-194\">194</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-195\">195</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-196\">196</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-197\">197</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-198\">198</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-199\">199</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-200\">200</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-201\">201</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-202\">202</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-203\">203</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-204\">204</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-205\">205</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-206\">206</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-207\">207</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-208\">208</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-209\">209</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-210\">210</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-211\">211</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-1\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_sendmsg</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">kiocb *</span><span class=\"crayon-v\">iocb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">socket *</span><span class=\"crayon-v\">sock</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">msghdr *</span><span class=\"crayon-v\">msg</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-2\"><span class=\"crayon-h\">                             </span><span class=\"crayon-e\">size_t </span><span class=\"crayon-v\">size</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sock</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">iovec *</span><span class=\"crayon-v\">iov</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">tcp_sock *</span><span class=\"crayon-v\">tp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_sk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sk_buff *</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">iovlen</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">timeo</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-12\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">lock_sock</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">TCP_CHECK_TIMER</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-15\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">msg</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">msg_flags</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">timeo</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sock_sndtimeo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MSG_DONTWAIT</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-18\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* Wait for a connection to finish. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_state</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">~</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TCPF_ESTABLISHED</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TCPF_CLOSE_WAIT</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_stream_wait_connect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">timeo</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-22\"><span class=\"crayon-h\">             </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">out_err</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-23\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* This should be in poll */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">clear_bit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">SOCK_ASYNC_NOSPACE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_socket</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* size_goal表示GSO支持的大小，为mss的整数倍，不支持GSO时则和mss相等 */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_send_mss</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">/*返回值mss_now为真实mss*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-28\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-29\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* Ok commence sending. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-30\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">iovlen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">msg</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">msg_iovlen</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-31\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">iov</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">msg</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">msg_iov</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-32\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">copied</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-33\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-34\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">EPIPE</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-35\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_shutdown</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SEND_SHUTDOWN</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-36\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">out_err</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-37\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-38\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">iovlen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-39\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">size_t </span><span class=\"crayon-v\">seglen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">iov</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">iov_len</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-40\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">__user *</span><span class=\"crayon-v\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">iov</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">iov_base</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-41\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-42\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">iov</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-43\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-44\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">while</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">seglen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-45\"><span class=\"crayon-h\">            </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-46\"><span class=\"crayon-h\">            </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">max</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*每个skb中填充的数据长度初始化为size_goal*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-47\"><span class=\"crayon-h\">            </span><span class=\"crayon-c\">/* 从sk-&gt;sk_write_queue中取出队尾的skb，因为这个skb可能还没有被填满 */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-48\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">skb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_write_queue_tail</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-49\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">tcp_send_head</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*如果之前还有未发送的数据*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-50\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ip_summed</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">CHECKSUM_NONE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*比如路由变更，之前的不支持TSO,现在的支持了*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-51\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">max</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*上一个不支持GSO的skb，继续不支持*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-52\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">max</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">len</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*copy为每次想skb中拷贝的数据长度*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-53\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-54\"><span class=\"crayon-h\">           </span><span class=\"crayon-c\">/*copy&lt;=0表示不能合并到之前skb做GSO*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-55\"><span class=\"crayon-h\">           </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-56\"><span class=\"crayon-v\">new_segment</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-57\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/* Allocate new segment. If the interface is SG,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-58\"><span class=\"crayon-c\">                * allocate skb fitting to single page.</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-59\"><span class=\"crayon-c\">                */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-60\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/* 内存不足，需要等待 */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-61\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">sk_stream_memory_free</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-62\"><span class=\"crayon-h\">                   </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">wait_for_sndbuf</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-63\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/* 分配新的skb */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-64\"><span class=\"crayon-h\">               </span><span class=\"crayon-v\">skb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_stream_alloc_skb</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">select_size</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_allocation</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-65\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-66\"><span class=\"crayon-h\">                   </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">wait_for_memory</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-67\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-68\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/*</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-69\"><span class=\"crayon-c\">                * Check whether we can use HW checksum.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-70\"><span class=\"crayon-c\">                */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-71\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/*如果硬件支持checksum，则将skb-&gt;ip_summed设置为CHECKSUM_PARTIAL，表示由硬件计算校验和*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-72\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_ALL_CSUM</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-73\"><span class=\"crayon-h\">                   </span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ip_summed</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">CHECKSUM_PARTIAL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-74\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/*将skb加入sk-&gt;sk_write_queue队尾, 同时去掉skb的TCP_NAGLE_PUSH标记*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-75\"><span class=\"crayon-h\">               </span><span class=\"crayon-e\">skb_entail</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-76\"><span class=\"crayon-h\">               </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*这里将每次copy的大小设置为size_goal，即GSO支持的大小*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-77\"><span class=\"crayon-h\">               </span><span class=\"crayon-v\">max</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-78\"><span class=\"crayon-h\">           </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-79\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-80\"><span class=\"crayon-h\">           </span><span class=\"crayon-c\">/* Try to append data to the end of skb. */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-81\"><span class=\"crayon-h\">           </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">seglen</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-82\"><span class=\"crayon-h\">               </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">seglen</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-83\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-84\"><span class=\"crayon-h\">           </span><span class=\"crayon-c\">/* Where to copy to? */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-85\"><span class=\"crayon-h\">           </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">skb_tailroom</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*如果skb的线性区还有空间，则先填充skb的线性区*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-86\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/* We have some space in skb head. */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-87\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">skb_tailroom</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-88\"><span class=\"crayon-h\">                   </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">skb_tailroom</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-89\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">skb_add_data</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*copy用户态数据到skb线性区*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-90\"><span class=\"crayon-h\">                   </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">do_fault</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-91\"><span class=\"crayon-h\">           </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*否则尝试向SG的frags中拷贝*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-92\"><span class=\"crayon-h\">               </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">merge</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-93\"><span class=\"crayon-h\">               </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">nr_frags</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-94\"><span class=\"crayon-h\">               </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">page *</span><span class=\"crayon-v\">page</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TCP_PAGE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-95\"><span class=\"crayon-h\">               </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TCP_OFF</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-96\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-97\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">skb_can_coalesce</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PAGE_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-c\">/*pfrag-&gt;page和frags[i-1]是否使用相同页，并且page_offset相同*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-98\"><span class=\"crayon-h\">                   </span><span class=\"crayon-c\">/* We can extend the last page</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-99\"><span class=\"crayon-c\">                   * fragment. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-100\"><span class=\"crayon-h\">                   </span><span class=\"crayon-v\">merge</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*说明和之前frags中是同一个page，需要merge*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-101\"><span class=\"crayon-h\">               </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAX_SKB_FRAGS</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_SG</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-102\"><span class=\"crayon-h\">                   </span><span class=\"crayon-c\">/* Need to add new fragment and cannot</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-103\"><span class=\"crayon-c\">                    * do this because interface is non-SG,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-104\"><span class=\"crayon-c\">                    * or because all the page slots are</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-105\"><span class=\"crayon-c\">                    * busy. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-106\"><span class=\"crayon-h\">                   </span><span class=\"crayon-c\">/*如果设备不支持SG，或者非线性区frags已经达到最大，则创建新的skb分段*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-107\"><span class=\"crayon-h\">                   </span><span class=\"crayon-e\">tcp_mark_push</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*标记push flag*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-108\"><span class=\"crayon-h\">                       </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">new_segment</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-109\"><span class=\"crayon-h\">               </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-110\"><span class=\"crayon-h\">                   </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PAGE_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-111\"><span class=\"crayon-h\">                       </span><span class=\"crayon-e\">put_page</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*增加page引用计数*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-112\"><span class=\"crayon-h\">                       </span><span class=\"crayon-e\">TCP_PAGE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">page</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-113\"><span class=\"crayon-h\">                       </span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-114\"><span class=\"crayon-h\">                   </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-115\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-116\"><span class=\"crayon-h\">                  </span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-117\"><span class=\"crayon-h\">                  </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PAGE_SIZE</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-118\"><span class=\"crayon-h\">                  </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PAGE_SIZE</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-119\"><span class=\"crayon-h\">                  </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">sk_wmem_schedule</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-120\"><span class=\"crayon-h\">                      </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">wait_for_memory</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-121\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-122\"><span class=\"crayon-h\">                 </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-123\"><span class=\"crayon-h\">                     </span><span class=\"crayon-c\">/* Allocate new cache page. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-124\"><span class=\"crayon-h\">                     </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_stream_alloc_page</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-125\"><span class=\"crayon-h\">                     </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">wait_for_memory</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-126\"><span class=\"crayon-h\">                 </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-127\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-128\"><span class=\"crayon-h\">                 </span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">skb_copy_to_page</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*拷贝数据到page中*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-129\"><span class=\"crayon-h\">                 </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-130\"><span class=\"crayon-h\">                     </span><span class=\"crayon-c\">/* If this page was new, give it to the</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-131\"><span class=\"crayon-c\">                      * socket so it does not get leaked.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-132\"><span class=\"crayon-c\">                      */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-133\"><span class=\"crayon-h\">                     </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">TCP_PAGE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-134\"><span class=\"crayon-h\">                         </span><span class=\"crayon-e\">TCP_PAGE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-135\"><span class=\"crayon-h\">                         </span><span class=\"crayon-e\">TCP_OFF</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-136\"><span class=\"crayon-h\">                     </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-137\"><span class=\"crayon-h\">                     </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">do_error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-138\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-139\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-140\"><span class=\"crayon-h\">                </span><span class=\"crayon-c\">/* Update the skb. */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-141\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">merge</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*pfrag和frags[i - 1]是相同的*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-142\"><span class=\"crayon-h\">                     </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">frags</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">size</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-143\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-144\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">skb_fill_page_desc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-145\"><span class=\"crayon-h\">                    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">TCP_PAGE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-146\"><span class=\"crayon-h\">                        </span><span class=\"crayon-e\">get_page</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-147\"><span class=\"crayon-h\">                    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PAGE_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-148\"><span class=\"crayon-h\">                        </span><span class=\"crayon-e\">get_page</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-149\"><span class=\"crayon-h\">                        </span><span class=\"crayon-e\">TCP_PAGE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-150\"><span class=\"crayon-h\">                    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-151\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-152\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">TCP_OFF</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-153\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-154\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-155\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">TCP_SKB_CB</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">~</span><span class=\"crayon-v\">TCPCB_FLAG_PSH</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-156\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-157\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">write_seq</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-158\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">TCP_SKB_CB</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">end_seq</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-159\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*清零tso分段数，让tcp_write_xmit去计算*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-160\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-161\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">copied</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-162\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">seglen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">iovlen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-163\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">out</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-164\"><span class=\"crayon-h\">            </span><span class=\"crayon-c\">/* 还有数据没copy，并且没有达到最大可拷贝的大小(注意这里max之前被赋值为size_goal，即GSO支持的大小)， 尝试往该skb继续添加数据*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-165\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">len</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">max</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MSG_OOB</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-166\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">continue</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-167\"><span class=\"crayon-h\">            </span><span class=\"crayon-c\">/*下面的逻辑就是：还有数据没copy，但是当前skb已经满了，所以可以发送了(但不是一定要发送)*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-168\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">forced_push</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*超过最大窗口的一半没有设置push了*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-169\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">tcp_mark_push</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*设置push标记，更新pushed_seq*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-170\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">__tcp_push_pending_frames</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TCP_NAGLE_PUSH</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*调用tcp_write_xmit马上发送*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-171\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_send_head</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*第一个包，直接发送*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-172\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">tcp_push_one</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-173\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">continue</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*说明发送队列前面还有skb等待发送，且距离之前push的包还不是非常久*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-174\"><span class=\"crayon-v\">wait_for_sndbuf</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-175\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">set_bit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">SOCK_NOSPACE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_socket</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-176\"><span class=\"crayon-v\">wait_for_memory</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-177\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">/*先把copied的发出去再等内存*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-178\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">tcp_push</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">~</span><span class=\"crayon-v\">MSG_MORE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TCP_NAGLE_PUSH</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-179\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/*阻塞等待内存*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-180\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_stream_wait_memory</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">timeo</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-181\"><span class=\"crayon-h\">                   </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">do_error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-182\"><span class=\"crayon-h\">               </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_send_mss</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-183\"><span class=\"crayon-h\">          </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-184\"><span class=\"crayon-h\">      </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-185\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-186\"><span class=\"crayon-v\">out</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-187\"><span class=\"crayon-h\">      </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*所有数据都放到发送队列中了，调用tcp_push发送*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-188\"><span class=\"crayon-h\">          </span><span class=\"crayon-e\">tcp_push</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">nonagle</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-189\"><span class=\"crayon-h\">      </span><span class=\"crayon-e\">TCP_CHECK_TIMER</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-190\"><span class=\"crayon-h\">      </span><span class=\"crayon-e\">release_sock</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-191\"><span class=\"crayon-h\">      </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-192\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-193\"><span class=\"crayon-v\">do_fault</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-194\"><span class=\"crayon-h\">      </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">len</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-195\"><span class=\"crayon-h\">          </span><span class=\"crayon-e\">tcp_unlink_write_queue</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-196\"><span class=\"crayon-h\">          </span><span class=\"crayon-c\">/* It is the one place in all of TCP, except connection</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-197\"><span class=\"crayon-c\">           * reset, where we can be unlinking the send_head.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-198\"><span class=\"crayon-c\">           */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-199\"><span class=\"crayon-h\">          </span><span class=\"crayon-e\">tcp_check_send_head</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-200\"><span class=\"crayon-h\">          </span><span class=\"crayon-e\">sk_wmem_free_skb</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-201\"><span class=\"crayon-h\">      </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-202\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-203\"><span class=\"crayon-v\">do_error</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-204\"><span class=\"crayon-h\">      </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-205\"><span class=\"crayon-h\">          </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">out</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-206\"><span class=\"crayon-v\">out_err</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-207\"><span class=\"crayon-h\">      </span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_stream_error</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-208\"><span class=\"crayon-h\">      </span><span class=\"crayon-e\">TCP_CHECK_TIMER</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-209\"><span class=\"crayon-h\">      </span><span class=\"crayon-e\">release_sock</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-210\"><span class=\"crayon-h\">      </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-211\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0316 seconds] -->\r\n<p>最终会调用tcp_push发送skb，而tcp_push又会调用tcp_write_xmit。tcp_sendmsg已经把数据按照GSO最大的size，放到一个个的skb中， 最终调用tcp_write_xmit发送这些GSO包。tcp_write_xmit会检查当前的拥塞窗口，还有nagle测试，tsq检查来决定是否能发送整个或者部分的skb， 如果只能发送一部分，则需要调用tso_fragment做切分。最后通过tcp_transmit_skb发送， 如果发送窗口没有达到限制，skb中存放的数据将达到GSO最大值。</p>\n<p>l  <b>tcp_write_xmit</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78ed301179950\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic int tcp_write_xmit(struct sock *sk, unsigned int mss_now, int nonagle,\r\n                                             int push_one, gfp_t gfp)\r\n{\r\n    struct tcp_sock *tp = tcp_sk(sk);\r\n    struct sk_buff *skb;\r\n    unsigned int tso_segs, sent_pkts;\r\n    int cwnd_quota;\r\n    int result;\r\n \r\n    sent_pkts = 0;\r\n \r\n    if (!push_one) {\r\n        /* Do MTU probing. */\r\n        result = tcp_mtu_probe(sk);\r\n        if (!result) {\r\n            return 0;\r\n        } else if (result &gt; 0) {\r\n            sent_pkts = 1;\r\n        }\r\n    }\r\n    /*遍历发送队列*/\r\n    while ((skb = tcp_send_head(sk))) {\r\n        unsigned int limit;\r\n \r\n        tso_segs = tcp_init_tso_segs(sk, skb, mss_now); /*skb-&gt;len/mss，重新设置tcp_gso_segs，因为在tcp_sendmsg中被清零了*/\r\n        BUG_ON(!tso_segs);\r\n \r\n        cwnd_quota = tcp_cwnd_test(tp, skb);\r\n        if (!cwnd_quota)\r\n            break;\r\n \r\n        if (unlikely(!tcp_snd_wnd_test(tp, skb, mss_now)))\r\n            break;\r\n \r\n        if (tso_segs == 1) { /*tso_segs=1表示无需tso分段*/\r\n            /* 根据nagle算法，计算是否需要推迟发送数据 */\r\n            if (unlikely(!tcp_nagle_test(tp, skb, mss_now, (tcp_skb_is_last(sk, skb) ? /*last skb就直接发送*/\r\n                           nonagle : TCP_NAGLE_PUSH))))\r\n                break;\r\n        } else {/*有多个tso分段*/\r\n            if (!push_one /*push所有skb*/\r\n                 &amp;&amp; tcp_tso_should_defer(sk, skb))/*/如果发送窗口剩余不多，并且预计下一个ack将很快到来(意味着可用窗口会增加)，则推迟发送*/\r\n               break;\r\n        }\r\n        /*下面的逻辑是：不用推迟发送，马上发送的情况*/\r\n        limit = mss_now;\r\n        /*由于tso_segs被设置为skb-&gt;len/mss_now，所以开启gso时一定大于1*/\r\n        if (tso_segs &gt; 1 &amp;&amp; !tcp_urg_mode(tp)) /*tso分段大于1且非urg模式*/\r\n            limit = tcp_mss_split_point(sk, skb, mss_now, cwnd_quota);/*返回当前skb中可以发送的数据大小，通过mss和cwnd*/\r\n        /* 当skb的长度大于限制时，需要调用tso_fragment分片,如果分段失败则暂不发送 */\r\n        if (skb-&gt;len &gt; limit &amp;&amp;\r\n             unlikely(tso_fragment(sk, skb, limit, mss_now))) /*/按limit切割成多个skb*/\r\n            break;\r\n \r\n        TCP_SKB_CB(skb)-&gt;when = tcp_time_stamp;\r\n        /*发送，如果包被qdisc丢了，则退出循环，不继续发送了*/\r\n        if (unlikely(tcp_transmit_skb(sk, skb, 1, gfp)))\r\n            break;\r\n \r\n        /* Advance the send_head. This one is sent out.\r\n         * This call will increment packets_out.\r\n         */\r\n        /*更新sk_send_head和packets_out*/\r\n        tcp_event_new_data_sent(sk, skb);\r\n        tcp_minshall_update(tp, mss_now, skb);\r\n        sent_pkts++;\r\n \r\n        if (push_one)\r\n            break;\r\n    }\r\n \r\n    if (likely(sent_pkts)) {\r\n        tcp_cwnd_validate(sk);\r\n        return 0;\r\n    }\r\n    return !tp-&gt;packets_out &amp;&amp; tcp_send_head(sk);\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-71\">71</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-72\">72</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-73\">73</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-74\">74</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-75\">75</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-76\">76</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-77\">77</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_write_xmit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nonagle</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-2\"><span class=\"crayon-h\">                                             </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">push_one</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">gfp_t </span><span class=\"crayon-v\">gfp</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">tcp_sock *</span><span class=\"crayon-v\">tp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_sk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sk_buff *</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sent_pkts</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cwnd_quota</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-9\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">sent_pkts</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-11\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">push_one</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/* Do MTU probing. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_mtu_probe</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-16\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-18\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">sent_pkts</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/*遍历发送队列*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_send_head</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-23\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">limit</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-24\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_init_tso_segs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*skb-&gt;len/mss，重新设置tcp_gso_segs，因为在tcp_sendmsg中被清零了*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">BUG_ON</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-27\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">cwnd_quota</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_cwnd_test</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-29\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">cwnd_quota</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-30\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-31\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-32\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">unlikely</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">tcp_snd_wnd_test</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-33\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-34\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-35\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*tso_segs=1表示无需tso分段*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-36\"><span class=\"crayon-h\">            </span><span class=\"crayon-c\">/* 根据nagle算法，计算是否需要推迟发送数据 */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-37\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">unlikely</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">tcp_nagle_test</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">tcp_skb_is_last</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*last skb就直接发送*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-38\"><span class=\"crayon-h\">                           </span><span class=\"crayon-v\">nonagle</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TCP_NAGLE_PUSH</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-39\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-40\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-c\">/*有多个tso分段*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-41\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">push_one</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*push所有skb*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-42\"><span class=\"crayon-h\">                 </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_tso_should_defer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">/*/如果发送窗口剩余不多，并且预计下一个ack将很快到来(意味着可用窗口会增加)，则推迟发送*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-43\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-44\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-45\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/*下面的逻辑是：不用推迟发送，马上发送的情况*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-46\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">limit</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-47\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/*由于tso_segs被设置为skb-&gt;len/mss_now，所以开启gso时一定大于1*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-48\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">tcp_urg_mode</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*tso分段大于1且非urg模式*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-49\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">limit</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_mss_split_point</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cwnd_quota</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">/*返回当前skb中可以发送的数据大小，通过mss和cwnd*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-50\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/* 当skb的长度大于限制时，需要调用tso_fragment分片,如果分段失败则暂不发送 */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-51\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">len</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">limit</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-52\"><span class=\"crayon-h\">             </span><span class=\"crayon-e\">unlikely</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">tso_fragment</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">limit</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*/按limit切割成多个skb*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-53\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-54\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-55\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">TCP_SKB_CB</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">when</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tcp_time_stamp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-56\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/*发送，如果包被qdisc丢了，则退出循环，不继续发送了*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-57\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">unlikely</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">tcp_transmit_skb</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gfp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-58\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-59\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-60\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/* Advance the send_head. This one is sent out.</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-61\"><span class=\"crayon-c\">         * This call will increment packets_out.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-62\"><span class=\"crayon-c\">         */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-63\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/*更新sk_send_head和packets_out*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-64\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">tcp_event_new_data_sent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-65\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">tcp_minshall_update</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-66\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">sent_pkts</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-67\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-68\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">push_one</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-69\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-70\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-71\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-72\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">likely</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sent_pkts</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-73\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">tcp_cwnd_validate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-74\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-75\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-76\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">packets_out</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_send_head</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-77\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0108 seconds] -->\r\n<p>其中tcp_init_tso_segs会设置skb的gso信息后文分析。我们看到tcp_write_xmit 会调用tso_fragment进行“tcp分段”。而分段的条件是skb-&gt;len &gt; limit。这里的关键就是limit的值，我们看到在tso_segs &gt; 1时，也就是开启gso的时候，limit的值是由tcp_mss_split_point得到的，也就是min(skb-&gt;len, window)，即发送窗口允许的最大值。在没有开启gso时limit就是当前的mss。</p>\n<p>l  <b>tcp_init_tso_segs</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78f3288382102\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic int tcp_init_tso_segs(struct sock *sk, struct sk_buff *skb, unsigned int mss_now)\r\n{\r\n    int tso_segs = tcp_skb_pcount(skb); /*skb_shinfo(skb)-&gt;gso_seg之前被初始化为0*/\r\n \r\n    if (!tso_segs || (tso_segs &gt; 1 &amp;&amp; tcp_skb_mss(skb) != mss_now)) {\r\n        tcp_set_skb_tso_segs(sk, skb, mss_now);\r\n        tso_segs = tcp_skb_pcount(skb);\r\n    }\r\n    return tso_segs;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78f3288382102-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f3288382102-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f3288382102-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f3288382102-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f3288382102-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f3288382102-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f3288382102-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f3288382102-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f3288382102-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f3288382102-10\">10</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78f3288382102-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_init_tso_segs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sk_buff *</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f3288382102-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f3288382102-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_skb_pcount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*skb_shinfo(skb)-&gt;gso_seg之前被初始化为0*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f3288382102-4\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f3288382102-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_skb_mss</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f3288382102-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">tcp_set_skb_tso_segs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f3288382102-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_skb_pcount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f3288382102-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f3288382102-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f3288382102-10\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0021 seconds] -->\r\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78f6115659724\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic void tcp_set_skb_tso_segs(struct sock *sk, struct sk_buff *skb, unsigned int mss_now)\r\n{\r\n    /* Make sure we own this skb before messing gso_size/gso_segs */\r\n    WARN_ON_ONCE(skb_cloned(skb));\r\n    if (skb-&gt;len &lt;= mss_now || !sk_can_gso(sk) ||\r\n        skb-&gt;ip_summed == CHECKSUM_NONE) {/*不支持gso的情况*/\r\n       /* Avoid the costly divide in the normal\r\n        * non-TSO case.\r\n        */\r\n       skb_shinfo(skb)-&gt;gso_segs = 1;\r\n       skb_shinfo(skb)-&gt;gso_size = 0;\r\n       skb_shinfo(skb)-&gt;gso_type = 0;\r\n    } else {\r\n        skb_shinfo(skb)-&gt;gso_segs = DIV_ROUND_UP(skb-&gt;len, mss_now); /*被设置为skb-&gt;len/mss_now*/\r\n        skb_shinfo(skb)-&gt;gso_size = mss_now; /*注意mss_now为真实的mss，这里保存以供gso分段使用*/\r\n        skb_shinfo(skb)-&gt;gso_type = sk-&gt;sk_gso_type;\r\n    }\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78f6115659724-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f6115659724-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f6115659724-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f6115659724-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f6115659724-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f6115659724-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f6115659724-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f6115659724-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f6115659724-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f6115659724-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f6115659724-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f6115659724-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f6115659724-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f6115659724-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f6115659724-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f6115659724-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f6115659724-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f6115659724-18\">18</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78f6115659724-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_set_skb_tso_segs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sk_buff *</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f6115659724-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f6115659724-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* Make sure we own this skb before messing gso_size/gso_segs */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f6115659724-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">WARN_ON_ONCE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">skb_cloned</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f6115659724-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">len</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">sk_can_gso</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f6115659724-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ip_summed</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">CHECKSUM_NONE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-c\">/*不支持gso的情况*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f6115659724-7\"><span class=\"crayon-h\">       </span><span class=\"crayon-c\">/* Avoid the costly divide in the normal</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f6115659724-8\"><span class=\"crayon-c\">        * non-TSO case.</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f6115659724-9\"><span class=\"crayon-c\">        */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f6115659724-10\"><span class=\"crayon-h\">       </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f6115659724-11\"><span class=\"crayon-h\">       </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_size</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f6115659724-12\"><span class=\"crayon-h\">       </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f6115659724-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f6115659724-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DIV_ROUND_UP</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">len</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*被设置为skb-&gt;len/mss_now*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f6115659724-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_size</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*注意mss_now为真实的mss，这里保存以供gso分段使用*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f6115659724-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_gso_type</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f6115659724-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f6115659724-18\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0034 seconds] -->\r\n<p>tcp_write_xmit最后会调用ip_queue_xmit发送skb，进入ip层。</p>\n<h2>ip分片，tcp分段，GSO，TSO</h2>\n<p>之后的逻辑就是之前另一篇文章中分析的GSO逻辑了。下面我们看下整个协议栈中ip分片，tcp分段，GSO，TSO的关系。我将这个流程由下图表示。</p>\n<p><img class=\"aligncenter\" src=\"http://blog.chinaunix.net/attachment/201705/6/28541347_1494074632KCCh.png\" alt=\"\" width=\"598\" height=\"856\"></p>\n</div>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111668\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111668votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111668\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>');
INSERT INTO `jobbole_article` VALUES ('带着问题学习分布式系统之数据分片', '2017-07-08', 'http://blog.jobbole.com/111716/', '7005be04c2edd13df9a087263d719892', 'http://jbcdn2.b0.upaiyun.com/2017/07/9c3ebd88533763a9cc48fc406d741a1a.png', 'full/4f98c9ecf55b5d6ac63cc8ecc27f2fa194e86ad0.jpg', '0', '3', '1', 'IT技术,分布式系统', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/xybaby/p/7076731.html\">xybaby</a>   </div><p>听过很多道理，却依然过不好这一生。</p>\n<p>看过很多关于学习的技巧、方法，却没应用到自己的学习中。</p>\n<p>随着年纪变大，记忆力越来越差，整块的时间也越来越少，于是，越来越希望能够更高效的学习。学习是一种习惯也是一种能力，这种能力在上学期间养成是最好的，毕竟那个时候绝大部分时间都在学习。但很遗憾，我没有养成适合自己的、好的学习习惯。工作之后，除了在日常工作中用到的知识技术，很难通过自学掌握新的知识（偏向于专业知识，即技术）。而互联网行业的分支、知识点又是如此之多，于是会出现这样的情况，遇到一个新的知识，觉得很厉害很感兴趣，看两天，但很快就忘记了。另外，对于一些比较庞杂的技术，又无从下手，也很难坚持下去。</p>\n<p>根本的问题在于学习不系统，没有把一个个的知识点连接起来，本来这些新的知识就很少在工作中实践，如果又是一个个的信息孤岛，很快就会被遗忘。另一个问题，没有良好的规划，今天看看这里，明天看看哪里，纠结于细枝末节，忘了从整体上把握。</p>\n<p>幸好，差不多半年前开始意识到了这个问题，开始看书，看别人的博客，开始思考如何充分利用好有限的时间。自己也实践了一些想法，比如写博客，坚持写博客。也有很多没做好，比如如何学习掌握一门新技术。关于这一点，其实看了许多文章，也有很多印象深刻，觉得很有道理；也有一些好书，比如《study more，learn less》。纸上得来终觉浅，绝知此事要躬行，别人的办法再好也需要亲身实践才知道是否对自己适用。</p>\n<p>需要学习的技术很多，要自学新知识也不是一件容易的事，选择一个自己比较感兴趣的会是一个比较好的开端，于是，打算学一学分布式系统。</p>\n<p><strong>带着问题，有目的的学习，先了解整体架构，在深入感兴趣的细节</strong>，这是我的计划。</p>\n<div>首先得有问题，如果每日重复相同的工作，也不主动去学习，很难发现新的问题。不怕自己无知，就怕不知道自己无知，只有不断的学习，才会发现更多未知的知识领域！</div>\n<h3>带着问题出发</h3>\n<p>分布式要解决什么问题呢？解决持久化数据太大，单个节点的硬盘无法存储的问题；解决运算量太大，单个节点的内存、CPU无法处理的问题。解决这些问题，有两种思路：scale up，scale out。前者就是提升单个节点的能力，更大的磁盘，更快的CPU，定制的软硬件，然而这意味着更高的价格，而且再怎么scaleup 也是有上限的。后者就是把存储、计算任务分担到普通的机器上，通过动态增加节点来应对数据量的增长，但缺点是多个节点的管理、任务的调度比较麻烦，这也是分布式系统研究和解决的问题。只有当数据量达到单机无法存储、处理的情况下才考虑分布式，不然都是自找麻烦。</p>\n<div>\n<div>状态的维护比计算要难很多，所谓状态就是需要持久化的数据。因此主要考虑分布式存储，况且即使是分布式计算，为了节省带宽需要尽量保证data locality，也是需要分布式存储。</div>\n<div></div>\n<div>现在有一堆数据，可能是结构化或者半结构化，需要将数据分片（segment、fragment、shard），形成一个个的数据子集，存储到一组物理节点上，物理节点之间通过网络通信。那么需要考虑两个问题：</div>\n<div></div>\n<blockquote>\n<div>第一：数据如何划分;</div>\n<div>第二：数据的可靠性、可用性问题</div>\n</blockquote>\n<h3>数据分片</h3>\n<p>数据分片是指将数据子集尽可能均衡的划分到各个物理节点上。那么会有哪些挑战呢？</p>\n<div>\n<p>（1）如果某个物理节点宕机，如何将该物理节点负责的数据尽快的转移到其他物理节点；</p>\n</div>\n<div>\n<p>（2）如果新增了物理节点，怎么从其他节点迁移数据到新节点；</p>\n</div>\n<p>（3）对于可修改的数据（即不是只能追加的数据），比如数据库数据，如果某节点数据量变大，怎么将部分数据迁移到其他负载较小的节点，及达到动态均衡的效果。</p>\n<div>（4）元数据的管理问题：当数据分布在各个节点，那么当用户使用的时候需要知道具体的数据在哪一个节点上。因此，系统需要维护<strong>数据的元数据：即每一个数据所在的位置、状态等信息</strong>。当用户需要具体的数据时，先查询元数据，然后再去具体的节点上查询。当数据在节点之间迁移的时候，也需要更新元数据。元数据的管理节点这里称之为meta server。元数据的管理也带来了新的挑战：</div>\n<div>（4.1）如何抽取数据的特征（特征是分片的依据，也是用户查询数据时的key），或者支持用户自定义数据特征；</div>\n<p>（4.2）如何保证meta server的高性能和高可用，是单点还是复制集</p>\n<div>（5）分片的粒度，即数据子集的大小，也是数据迁移的基本单位。粒度过粗，不利于数据均衡；粒度过细，管理、迁移成本又会比较大。</div>\n<h3>数据冗余</h3>\n<div>\n<p>前面提到，分布式系统中的节点都是普通的节点，因此有一定的概率会出现物理故障，比如断电、网络不可用，这些故障导致数据的暂时不可用；另外一些故障更严重，会导致数据的丢失，比如磁盘损坏。即使单个节点的故障是小概率，当集群中的节点数目很多是，故障就成为了一个大概率事件。因此，保证数据的高可用和可靠性是分布式系统必须解决的问题。</p>\n<p>为了避免单点故障，可行的办法就是数据冗余（复制集），即将同一份数据放在不同的物理节点，甚至是不同的数据中心。如果数据是一次写，多次读那很好办，随便从哪个副本读取都行。但对于很多分布式存储系统，比如数据库，数据是持续变化的，有读有写。那么复制集会带来什么样的挑战呢，需要如何权衡呢，假设有三个副本：</p>\n<p>（1）三个副本的地位，大家都是平等的还是有主（primary、master）有次（secondary、slave），如果是平等的，那么每个节点都可以接收写操作；如果不平等，可以一个节点负责所有的写操作，所有节点都提供读操作，</p>\n<p>（2）在平等的情况下，怎么保证写入操作不冲突，保证各个节点的数据是一致的，怎么保证能读取到最新的数据</p>\n<div>　　（3）不平等的情况下</div>\n<div>　　　　（3.1）写节点怎么将变更的数据同步到其他节点，同步还是异步；</div>\n<div>　　　　（3.2）非写节点能否提供读数据，如果能够允许，会不会读取到过时的数据。</div>\n<div>　　　　（3.3）主节点是怎么产生的，当主节点宕机的时候，怎么选择出新的主节点。是有统一的复制集管理中心（记录谁主谁次，各自的状态），还是复制集自己选举出一个主节点？</div>\n<p>（4）不管复制集内部的节点是平等的，还是有集中式节点的，只要有多个数据副本，就需要考虑数据的一致性可用性问题。按照CAP理论，只能同时满足一致性 可用性 分区容错性之间的二者，不同的分布式系统需要权衡。</p>\n</div>\n</div>\n<hr>\n<p>在前文中，提出了分布式系统（尤其是分布式存储系统）需要解决的两个最主要的问题，即数据分片和数据冗余，下面这个图片（<a href=\"http://book.mixu.net/distsys/intro.html\" target=\"_blank\">来源</a>）形象生动的解释了其概念和区别：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9c3ebd88533763a9cc48fc406d741a1a.png\" alt=\"\"></p>\n<p>其中数据即A、B属于数据分片，原始数据被拆分成两个正交子集分布在两个节点上。而数据集C属于数据冗余，同一份完整的数据在两个节点都有存储。当然，在实际的分布式系统中，数据分片和数据冗余一般都是共存的。</p>\n<p>本文主要讨论数据分片的三个问题：</p>\n<p>（1）如何做数据分片，即如何将数据映射到节点</p>\n<p>（2）数据分片的特征值，即按照数据中的哪一个属性（字段）来分片</p>\n<p>（3）数据分片的元数据的管理，如何保证元数据服务器的高性能、高可用，如果是一组服务器，如何保证强一致性</p>\n<p>所谓分布式系统，就是利用多个独立的计算机来解决单个节点（计算机）无法处理的存储、计算问题，这是非常典型的分而治之的思想。每个节点只负责原问题（即整个系统需要完成的任务）的一个子集，那么原问题如何拆分到多个节点？在分布式存储系统中，任务的拆分即数据分片。</p>\n<p>何为数据分片（segment，fragment， shard， partition），就是按照一定的规则，将数据集划分成相互独立、正交的数据子集，然后将数据子集分布到不同的节点上。注意，这里提到，数据分片需要按照一定的规则，不同的分布式应用有不同的规则，但都遵循同样的原则：按照最主要、最频繁使用的访问方式来分片。</p>\n<h1>三种数据分片方式</h1>\n<div>　　首先介绍三种分片方式：hash方式，一致性hash（consistent hash），按照数据范围（range based）。对于任何方式，都需要思考以下几个问题：</div>\n<div>\n<ol>\n<li>具体如何划分原始数据集？</li>\n<li>当原问题的规模变大的时候，能否通过增加节点来动态适应？</li>\n<li>当某个节点故障的时候，能否将该节点上的任务均衡的分摊到其他节点？</li>\n<li>对于可修改的数据（比如数据库数据），如果某节点数据量变大，能否以及如何将部分数据迁移到其他负载较小的节点，及达到动态均衡的效果？</li>\n<li>元数据的管理（即数据与物理节点的对应关系）规模？元数据更新的频率以及复杂度？</li>\n</ol>\n<p>为了后面分析不同的数据分片方式，假设有三个物理节点，编号为N0， N1， N2；有以下几条记录：</p>\n<p>R0: {id: 95, name: ‘aa’, tag:’older’}<br>\nR1: {id: 302, name: ‘bb’,}<br>\nR2: {id: 759, name: ‘aa’,}<br>\nR3: {id: 607, name: ‘dd’, age: 18}<br>\nR4: {id: 904, name: ‘ff’,}<br>\nR5: {id: 246, name: ‘gg’,}<br>\nR6: {id: 148, name: ‘ff’,}<br>\nR7: {id: 533, name: ‘kk’,}</p>\n</div>\n<h2>hash方式：</h2>\n<p>哈希表（散列表）是最为常见的数据结构，根据记录（或者对象）的关键值将记录映射到表中的一个槽（slot），便于快速访问。绝大多数编程语言都有对hash表的支持，如python中的dict， C++中的map，Java中的Hashtable， Lua中的table等等。在哈希表中，最为简单的散列函数是 mod N（N为表的大小）。即首先将关键值计算出hash值（这里是一个整型），通过对N取余，余数即在表中的位置。</p>\n<p>数据分片的hash方式也是这个思想，即按照数据的某一特征（key）来计算哈希值，并将哈希值与系统中的节点建立映射关系,从而将哈希值不同的数据分布到不同的节点上。</p>\n<p>我们选择id作为数据分片的key，那么各个节点负责的数据如下：</p>\n<div>　　<img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/60b1cd0b902642fcd732d92d826bf1d7.png\" alt=\"\" width=\"735\" height=\"173\"></div>\n<p>由此可以看到，按照hash方式做数据分片，映射关系非常简单；需要管理的元数据也非常之少，只需要记录节点的数目以及hash方式就行了。</p>\n<div>　　但hash方式的缺点也非常明显：当加入或者删除一个节点的时候，大量的数据需要移动。比如在这里增加一个节点N3，因此hash方式变为了mod 4，数据的迁移如下：</div>\n<div>　　<img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/a070c20a578c8728f269a7c5f88a9bc1.png\" alt=\"\"></div>\n<p>在这种方式下，是不满足单调性（Monotonicity）的：如果已经有一些内容通过哈希分派到了相应的缓冲中，又有新的缓冲加入到系统中。哈希的结果应能够保证原有已分配的内容可以被映射到原有的或者新的缓冲中去，而不会被映射到旧的缓冲集合中的其他缓冲区。</p>\n<p>在工程中，为了减少迁移的数据量，节点的数目可以成倍增长，这样概率上来讲至多有50%的数据迁移。</p>\n<div>hash方式还有一个缺点，即很难解决数据不均衡的问题。有两种情况：原始数据的特征值分布不均匀，导致大量的数据集中到一个物理节点上；第二，对于可修改的记录数据，单条记录的数据变大。在这两种情况下，都会导致节点之间的负载不均衡，而且在hash方式下很难解决。</div>\n<h2>一致性hash</h2>\n<div><a href=\"https://en.wikipedia.org/wiki/Consistent_hashing\" target=\"_blank\">一致性hash</a>是将数据按照特征值映射到一个首尾相接的hash环上，同时也将节点（按照IP地址或者机器名hash）映射到这个环上。对于数据，从数据在环上的位置开始，顺时针找到的第一个节点即为数据的存储节点。这里仍然以上述的数据为例，假设id的范围为［0， 1000］，N0， N1， N2在环上的位置分别是100， 400， 800，那么hash环示意图与数据的分布如下：</div>\n<div style=\"text-align: center;\"> 　　<img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/265e3dc723d195313a689e01bc6c542e.png\" alt=\"\">　　<img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/bba07578f38434571328a37d984025c0.png\" alt=\"\"></div>\n<p>可以看到相比于上述的hash方式，一致性hash方式需要维护的元数据额外包含了节点在环上的位置，但这个数据量也是非常小的。</p>\n<p>一致性hash在增加或者删除节点的时候，受到影响的数据是比较有限的，比如这里增加一个节点N3，其在环上的位置为600，因此，原来N2负责的范围段（400， 800］现在由N2（400， 600] N3(600, 800]负责，因此只需要将记录R2(id:759), R3(id: 607) 从N2,迁移到N3:</p>\n<div>　　不难发现一致性hash方式在增删的时候只会影响到hash环上响应的节点，不会发生大规模的数据迁移。</div>\n<p>但是，一致性hash方式在增加节点的时候，只能分摊一个已存在节点的压力；同样，在其中一个节点挂掉的时候，该节点的压力也会被全部转移到下一个节点。我们希望的是“一方有难，八方支援”，因此需要在增删节点的时候，已存在的所有节点都能参与响应，达到新的均衡状态。</p>\n<p>因此，在实际工程中，一般会引入虚拟节点（virtual node）的概念。即不是将物理节点映射在hash换上，而是将虚拟节点映射到hash环上。虚拟节点的数目远大于物理节点，因此一个物理节点需要负责多个虚拟节点的真实存储。操作数据的时候，先通过hash环找到对应的虚拟节点，再通过虚拟节点与物理节点的映射关系找到对应的物理节点。</p>\n<p>引入虚拟节点后的一致性hash需要维护的元数据也会增加：第一，虚拟节点在hash环上的问题，且虚拟节点的数目又比较多；第二，虚拟节点与物理节点的映射关系。但带来的好处是明显的，当一个物理节点失效是，hash环上多个虚拟节点失效，对应的压力也就会发散到多个其余的虚拟节点，事实上也就是多个其余的物理节点。在增加物理节点的时候同样如此。</p>\n<p>工程中，<a href=\"http://cloudgroup.neu.edu.cn/papers/cloud%20data%20storage/dynamo-sosp-2007.pdf\" target=\"_blank\">Dynamo</a>、<a href=\"https://cassandra.apache.org/%20%20%20%20\" target=\"_blank\">Cassandra</a>都使用了一致性hash算法，且在比较高的版本中都使用了虚拟节点的概念。在这些系统中，需要考虑综合考虑数据分布方式和数据副本，当引入数据副本之后，一致性hash方式也需要做相应的调整， 可以参加cassandra的相关文档。</p>\n<h2>range based</h2>\n<p>简单来说，就是按照关键值划分成不同的区间，每个物理节点负责一个或者多个区间。其实这种方式跟一致性hash有点像，可以理解为物理节点在hash环上的位置是动态变化的。</p>\n<p>还是以上面的数据举例，三个节点的数据区间分别是N0(0, 200]， N1(200, 500]， N2(500, 1000]。那么数据分布如下：</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/97744e5665ed8d8444a5642e0e887714.png\" alt=\"\"></p>\n<p>注意，区间的大小不是固定的，每个数据区间的数据量与区间的大小也是没有关系的。比如说，一部分数据非常集中，那么区间大小应该是比较小的，即以数据量的大小为片段标准。在实际工程中，一个节点往往负责多个区间，每个区间成为一个块（chunk、block），每个块有一个阈值，当达到这个阈值之后就会分裂成两个块。这样做的目的在于当有节点加入的时候，可以快速达到均衡的目的。</p>\n<p>不知道读者有没有发现，如果一个节点负责的数据只有一个区间，range based与没有虚拟节点概念的一致性hash很类似；如果一个节点负责多个区间，range based与有虚拟节点概念的一致性hash很类似。</p>\n<p>range based的元数据管理相对复杂一些，需要记录每个节点的数据区间范围，特别单个节点对于多个区间的情况。而且，在数据可修改的情况下，如果块进行分裂，那么元数据中的区间信息也需要同步修改。</p>\n<p>range based这种数据分片方式应用非常广泛，比如MongoDB, PostgreSQL， HDFS</p>\n<h2>小结：</h2>\n<p>在这里对三种分片方式（应该是四种，有没有virtual node的一致性hash算两种）进行简单总结，主要是针对提出的几个问题：</p>\n<table cellspacing=\"0\" cellpadding=\"2\">\n<colgroup></colgroup>\n<tbody>\n<tr>\n<td></td>\n<td>映射难度</td>\n<td>元数据</td>\n<td>节点增删</td>\n<td>数据动态均衡</td>\n</tr>\n<tr>\n<td>hash方式</td>\n<td>简单</td>\n<td>非常简单，几乎不用修改</td>\n<td>需要迁移的数据比较多</td>\n<td>不支持</td>\n</tr>\n<tr>\n<td>consistent hash<br>\nwithout virtual node</td>\n<td>简单</td>\n<td>比较简单，取决于节点规模，几乎不用修改</td>\n<td>增删节点的时候只影响hash环上相邻节点，但不能使所有节点都参与数据迁移过程</td>\n<td>不支持</td>\n</tr>\n<tr>\n<td>consistent hash<br>\nwith virtual node</td>\n<td>中等</td>\n<td>稍微复杂一些，主要取决于虚拟节点规模，很少修改</td>\n<td>需要迁移的数据比较少，且所有节点都能贡献部分数据</td>\n<td>若支持（修改虚拟节点与物理节点映射关系）</td>\n</tr>\n<tr>\n<td>range based</td>\n<td>较为复杂</td>\n<td>取决于每个块的大小，一般来说规模较大；且修改频率较高</td>\n<td>需要迁移的数据比较少，且所有节点都能贡献部分数据</td>\n<td>支持，且比较容易</td>\n</tr>\n</tbody>\n</table>\n<p>上面的数据动态均衡，值得是上述问题的第4点，即如果某节点数据量变大，能否以及如何将部分数据迁移到其他负载较小的节点</p>\n<h1>分片特征值的选择</h1>\n<p>上面的三种方式都提到了对数据的分片是基于关键值、特征值的。这个特征值在不同的系统中有不同的叫法，比如MongoDB中的<a href=\"https://docs.mongodb.com/manual/core/sharding-shard-key/\" target=\"_blank\">sharding key</a>， Oracle中的<a href=\"https://docs.oracle.com/cd/B28359_01/server.111/b32024/partition.htm\" target=\"_blank\">Partition Key</a>，不管怎么样，这个特征值的选择都是非常非常重要的。</p>\n<p>那么。怎么选择这个特征值呢？《<a href=\"http://book.mixu.net/distsys/intro.html\" target=\"_blank\">Distributed systems for fun and profi</a>t》给出了言简意赅的标准：</p>\n<blockquote><p>　　 based on what you think the primary access pattern will be</p></blockquote>\n<p>大概翻译为：基于最常用的访问模式。访问时包括对数据的增删改查的。比如上面的列子，我们选择“id”作为分片的依据，那么就是默认对的数据增删改查都是通过“id”字段来进行的。</p>\n<p>如果在应用中，大量的数据操作都是通过这个特征值进行，那么数据分片就能提供两个额外的好处：</p>\n<p>（1）提升性能和并发，操作被分发到不同的分片，相互独立</p>\n<p>（2）提升系统的可用性，即使部分分片不能用，其他分片不会受到影响</p>\n<p>如果大量操作并没有使用到特征值，那么就很麻烦了。比如在本文的例子中，如果用name去查询，而元数据记录的是如何根据按照id映射数据位置，那就尴尬了，需要到多有分片都去查一下，然后再做一个聚合！</p>\n<p>另外一个问题，如果以单个字段为特征值（如id），那么不管按照什么分布方式，在多条数据拥有相同的特征值（如id）的情况下，这些数据一定都会分布到同一个节点上。在这种情况下有两个问题，一是不能达到节点间数据的均衡，二是如果数据超过了单个节点的存储能力怎么办？关键在于，即使按照分布式系统解决问题的常规办法 — 增加节点 –也是于事无补的。</p>\n<p>在这个时候，单个字段做特征值就不行了，可能得再增加一个字段作为“联合特征值”，类似数据库中的联合索引。比如，数据是用户的操作日志，可以使用id和时间戳一起作为hash函数的输入，然后算出特征值；但在这种情况下，如果还想以id为查询关键字来查询，那就得遍历所有节点了。</p>\n<p>所以说没有最优的设计，只有最符合应用需求的设计。</p>\n<p>下面以MongoDB中的sharding key为例，解释特征值选择的重要性以及对数据操作的影响。如果有数据库操作基础，即使没有使用过MongoDB，阅读下面的内容应该也没有问题。</p>\n<h2>以MongoDB sharding key为例</h2>\n<p>关于MongoDB Sharded cluster，之前也写过一篇文章《<a href=\"http://www.cnblogs.com/xybaby/p/6832296.html\" target=\"_blank\">通过一步步创建sharded cluster来认识mongodb</a>》，做了简单介绍。在我的工作场景中，除了联合查询（join）和事务，MongoDB的使用和Mysql还是比较相似的，特别是基本的CRUD操作、数据库索引。MongoDb中，每一个分片成为一个shard，分片的特征值成为sharding key，每个数据称之为一个document。选择适合的字段作为shardingkey非常重要，why？</p>\n<p>前面也提到，如果使用非sharding key去访问数据，那么元数据服务器（或者元数据缓存服务器，后面会讲解这一部分）是没法知道对应的数据在哪一个shard上，那么该访问就得发送到所有的shard，得到所有shard的结果之后再做聚合，在mongoDB中，由mongos（缓存有元数据信息）做数据聚合。对于数据读取（R： read or retrieve），通过同一个字段获取到多个数据，是没有问题的，只是效率比较低而已。对于数据更新，如果只能更新一个数据，那么在哪一个shard上更新呢，似乎都不对，这个时候，MongoDB是拒绝的。对应到MongoDB（MongoDD3.0）的命令包括但不限于：</p>\n<ul>\n<li>　　findandmodify：这个命令只能更新一个document，因此查询部分必须包含sharding key</li>\n</ul>\n<blockquote><p>　　When using <code>findAndModify</code> in a sharded environment, the <code>query</code> must contain the shard key for all operations against the shard cluster for the <em>sharded</em> collections.</p></blockquote>\n<ul>\n<li>　　update：这个命令有一个参数multi，默认是false，即只能更新一个document，此时查询部分必须包含sharding key</li>\n</ul>\n<blockquote>\n<div>All <code>update()</code> operations for a sharded collection that specify the <code>multi: false</code> option must include theshard key <em>or</em> the <code>_id</code> field in the query specification.</div>\n</blockquote>\n<ul>\n<li> 　  remove：有一个参数JustOne，如果为True，只能删除一个document，也必须使用sharidng key</li>\n</ul>\n<p>另外，熟悉sql的同学都知道，在数据中索引中有unique index（唯一索引），即保证这个字段的值在table中是唯一的。mongoDB中，也可以建立unique index，但是在sharded cluster环境下，只能对sharding key创建unique index，道理也很简单，如果unique index不是sharidng key，那么插入的时候就得去所有shard上查看，而且还得加锁。</p>\n<p>接下来，讨论分片到shard上的数据不均的问题，如果一段时间内shardkey过于集中（比如按时间增长），那么数据只往一个shard写入，导致无法平衡集群压力。</p>\n<div>　　MongoDB中提供了”<a href=\"https://docs.mongodb.com/manual/core/ranged-sharding/\" target=\"_blank\">range partition</a>“和”<a href=\"https://docs.mongodb.com/manual/core/hashed-sharding/\" target=\"_blank\">hash partition</a>“，<strong>这个跟上面提到的分片方式 hash方式， ranged based不是一回事儿</strong>，而是指对sharding key处理。MongoDB一定是ranged base分片方式,<a href=\"https://docs.mongodb.com/manual/core/sharding-shard-key/\" target=\"_blank\">docuemnt</a>中如是说：</div>\n<blockquote>\n<div>MongoDB <a href=\"https://docs.mongodb.com/manual/reference/glossary/#term-data-partition\">partitions</a> data in the collection using ranges of shard key values. Each range defines a non-overlapping range of shard key values and is associated with a <a href=\"https://docs.mongodb.com/manual/reference/glossary/#term-chunk\">chunk</a>.</div>\n</blockquote>\n<p>那么什么是”range partition”和”hash partition”，官网的一张图很好说明了二者的区别：</p>\n<p style=\"text-align: center;\">　　<img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/4f75dba562d78dd3cf88e6a0420a83b6.png\" alt=\"\" width=\"496\" height=\"248\">            <img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/13aa93953848ef771a508070a6e68ee7.png\" alt=\"\" width=\"504\" height=\"252\"></p>\n<p>　　上图左是range partition，右是hash partition。range partition就是使用字段本身作为分片的边界，比如上图的x；而hash partition会将字段重新hash到一个更大、更离散的值域区间。</p>\n<p>hash partition的最大好处在于保证数据在各个节点上均匀分布（这里的均匀指的是在写入的时候就均匀，而不是通过MongoDB的balancing功能）。比如MongoDB中默认的_id是objectid，objectid是一个12个字节的BSON类型，前4个字节是机器的时间戳，那么如果在同一时间大量创建以ObjectId为_id的数据 会分配到同一个shard上，此时若将_id设置为hash index 和 hash sharding key，就不会有这个问题。</p>\n<p>当然，hash  partition相比range partition也有一个很大的缺点，就是范围查询的时候效率低！因此到底选用hash  partition还是range partition还得根据应用场景来具体讨论。</p>\n<p>最后得知道，sharding key一但选定，就无法修改（Immutable）。如果应用必须要修改sharidng key，那么只能将数据导出，新建数据库并创建新的sharding key，最后导入数据。</p>\n<h1>元数据服务器</h1>\n<p>在上面讨论的三种数据分片分式中，或多或少都会记录一些元数据：数据与节点的映射关系、节点状态等等。我们称记录元数据的服务器为元数据服务器（metaserver），不同的系统叫法不一样，比如master、configserver、namenode等。</p>\n<p>元数据服务器就像人类的大脑，一只手不能用了还没忍受，大脑不工作整个人就瘫痪了。因此，元数据服务器的<strong>高性能、高可用</strong>，要达到这两个目标，元数据服务器就得高<strong>可扩展</strong> — 以此应对元数据的增长。</p>\n<p>元数据的高可用要求元数据服务器不能成为故障单点（single point of failure），因此需要元数据服务器有多个备份，并且能够在故障的时候迅速切换。</p>\n<p>有多个备份，那么问题就来了，怎么保证多个备份的数据一致性？</p>\n<p>多个副本的一致性、可用性是CAP理论讨论的范畴，这里简单介绍两种方案。第一种是主从同步，首先选出主服务器，只有主服务器提供对外服务，主服务器将元数据的变革信息以日志的方式持久化到共享存储（例如nfs），然后从服务器从共享存储读取日志并应用，达到与主服务器一致的状态，如果主服务器被检测到故障（比如通过心跳），那么会重新选出新的主服务器。第二种方式，通过分布式一致性协议来达到多个副本件的一致，比如大名鼎鼎的Paxos协议，以及工程中使用较多的Paxos的特化版本 — Raft协议，协议可以实现所有备份均可以提供对外服务，并且保证强一致性。</p>\n<h2>HDFS元数据</h2>\n<p>HDFS中，元数据服务器被称之为namenode，在hdfs1.0之前，namenode还是单点，一旦namenode挂掉，整个系统就无法工作。在hdfs2.0，解决了namenode的单点问题。</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/8221eac439b32bd000638097d281c3bb.png\" alt=\"\"></p>\n<p>上图中NN即NameNode， DN即DataNode（即实际存储数据的节点）。从图中可以看到， 两台 NameNode 形成互备，一台处于 Active 状态，为主 NameNode，另外一台处于 Standby 状态，为备 NameNode，<strong>只有主 NameNode 才能对外提供读写服务</strong>。</p>\n<p>Active NN与standby NN之间的数据同步通过共享存储实现，共享存储系统保证了Namenode的高可用。为了保证元数据的强一致性，在进行准备切换的时候，新的Active NN必须要在确认元数据完全同步之后才能继续对外提供服务。</p>\n<p>另外，Namenode的状态监控以及准备切换都是Zookeeper集群负责，在网络分割（network partition）的情况下，有可能zookeeper认为原来的Active NN挂掉了，选举出新的ActiveNN，但实际上原来的Active NN还在继续提供服务。这就导致了“双主“或者脑裂（brain-split）现象。为了解决这个问题，提出了fencing机制，也就是想办法把旧的 Active NameNode 隔离起来，使它不能正常对外提供服务。具体参见<a href=\"https://www.ibm.com/developerworks/cn/opensource/os-cn-hadoop-name-node/\" target=\"_blank\">这篇文章</a>。</p>\n<h2>MongoDB元数据</h2>\n<p>MongoDB中，元数据服务器被称为config server。在MongoDB3.2中，已经不再建议使用三个镜像(Mirrored)MongoDB实例作为config server，而是推荐使用复制集（replica set）作为config server，此举的目的是增强config server的一致性，而且config sever中mongod的数目也能从3个达到replica set的上线（50个节点），从而提高了可靠性。</p>\n<p>在MongoDB3.0及之前的版本中，元数据的读写按照下面的方式进行：</p>\n<blockquote><p>　　When writing to the three config servers, a <strong>coordinator</strong> dispatches the same write commands to the three config servers and collects the results. Differing results indicate an inconsistent writes to the config servers and may require manual intervention.</p></blockquote>\n<p>MongoDB的官方文档并没有详细解释这一过程，不过在<a href=\"https://dba.stackexchange.com/questions/91194/why-does-mongodb-require-three-config-servers\" target=\"_blank\">stackexchange</a>上，有人指出这个过程是两阶段提交。</p>\n<p>MongoDB3.2及之后的版本，使用了replica set config server，在《<a href=\"http://www.cnblogs.com/xybaby/p/6871764.html\" target=\"_blank\">CAP理论与MongoDB一致性、可用性的一些思考</a>》文章中，详细介绍了replica set的write concern、read concern和read references，这三个选项会影响到复制集的一致性、可靠性与读取性能。在config server中，使用了WriteConcern：Majority；ReadConcern：Majority；ReadReferences：nearest。</p>\n<h2>元数据的缓存：</h2>\n<p>即使元数据服务器可以由一组物理机器组成，也保证了副本集之间的一致性问题。但是如果每次对数据的请求都经过元数据服务器的话，元数据服务器的压力也是非常大的。很多应用场景，元数据的变化并不是很频繁，因此可以在访问节点上做缓存，这样应用可以直接利用缓存数据进行数据读写，减轻元数据服务器压力。</p>\n<p>在这个环境下，缓存的元数据必须与元数据服务器上的元数据一致，缓存的元数据必须是准确的，未过时的。相反的例子是DNS之类的缓存，即使使用了过期的DNS缓存也不会有太大的问题。</p>\n<p>怎么达到缓存的强一致性呢？比较容易想到的办法是当metadata变化的时候立即通知所有的缓存服务器（mongos），但问题是通信有延时，不可靠。</p>\n<p>解决不一致的问题，一个比较常见的思路是版本号，比如网络通信，通信协议可能会发生变化，通信双方为了达成一致，那么可以使用版本号。在缓存一致性的问题上，也可以使用版本号，基本思路是请求的时候带上缓存的版本号，路由到具体节点之后比较实际数据的版本号，如果版本号不一致，那么表示缓存信息过旧，此时需要从元数据服务器重新拉取元数据并缓存。在MongoDB中，mongos缓存上就是使用的这种办法。</p>\n<p>另外一种解决办法，就是大名鼎鼎的lease机制 — “An Efficient Fault-Tolerant Mechanism for Distributed File Cache Consistency”，lease机制在分布式系统中使用非常广泛，不仅仅用于分布式缓存，在很多需要达成某种约定的地方都大显身手，在《分布式系统原理介绍》中，对lease机制有较为详细的描述，下面对lease机制进行简单介绍。</p>\n<h2>Lease机制：</h2>\n<p>既然，Lease机制提出的时候是为了解决分布式存储系统中缓存一致性的问题，那么首先来看看Lease机制是怎么保证缓存的强一致性的。<strong>注意</strong>，为了方便后文描述，在本小节中，我们称元数据服务器为服务器，缓存服务器为客户端。</p>\n<p><strong>要点</strong>：</p>\n<ul>\n<li>　　服务器向所有客户端发送缓存数据的同时，颁发一个lease，lease包含一个有限期（即过期时间）</li>\n<li>　　lease的含义是：在这个有效期内，服务器保证元数据不会发生变化</li>\n<li>　　因此客户端在这个有效期内可以放心大胆的使用缓存的元数据，如果超过了有效期，就不能使用数据了，就得去服务器请求。</li>\n<li>　　如果外部请求修改服务器上的元数据（元数据的修改一定在服务器上进行），那么服务器会阻塞修改请求，直到所有已颁发的lease过期，然后修改元数据，并将新的元数据和新的lease发送到客户端</li>\n<li>　　如果元数据没有发生变化，那么服务器也需要在之前已颁发的lease到期之间，重新给客户端颁发新的lease（只有lease，没有数据）</li>\n</ul>\n<p>在Lease论文的标题中，提到了“Fault-Tolerant”，那么lease是怎么做到容错的呢。关键在于，只要服务器一旦发出数据和lease，不关心客户端是否收到数据，只要等待lease过期，就可以修改元数据；另外，lease的有效期通过过期时间（一个时间戳）来标识，因此即使从服务器到客户端的消息延时到达、或者重复发送都是没有关系的。</p>\n<p>不难发现，容错的前提是服务器与客户端的时间要一致。如果服务器的时间比客户端的时间慢，那么客户端收到lease之后很快就过期了，lease机制就发挥不了作用；如果服务器的时间比客户端的时间快，那么就比较危险，因为客户端会在服务器已经开始更新元数据的时候继续使用缓存，工程中，通常将服务器的过期时间设置得比客户端的略大，来解决这个问题。为了保持时间的一致，最好的办法是使用NTP（Network Time Protocol）来保证时钟同步。</p>\n<p>Lease机制的本质是颁发者授予的在某一有效期内的承诺，承诺的范围是非常广泛的：比如上面提到的cache；比如做权限控制，例如当需要做并发控制时，同一时刻只给某一个节点颁发lease，只有持有lease的节点才可以修改数据；比如身份验证，例如在primary-secondary架构中，给节点颁发lease，只有持有lease的节点才具有primary身份；比如节点的状态监测，例如在primary-secondary架构中监测primary是否正常，这个后文再详细介绍。</p>\n<p>工程中，lease机制也有大量的应用：GFS中使用Lease确定Chuck的Primary副本, Lease由Master节点颁发给primary副本，持有Lease的副本成为primary副本。chubby通过paxos协议实现去中心化的选择primary节点，然后Secondary节点向primary节点发送lease，该lease的含义是：“承诺在lease时间内，不选举其他节点成为primary节点”。chubby中，primary节点也会向每个client节点颁发lease。该lease的含义是用来判断client的死活状态，一个client节点只有只有合法的lease，才能与chubby中的primary进行读写操作。</p>\n<h1>总结</h1>\n<p>本文主要介绍分布式系统中的分片相关问题，包括三种分布方式：hash、一致性hash、range based，以及各自的优缺点。分片都是按照一定的特征值来进行，特征值应该从应用的使用场景来选取，并结合MongoDB展示了特征值（mongodb中的sharding key）对数据操作的影响。分片信息（即元数据）需要专门的服务器存储，元数据服务器是分布式存储系统的核心，因此需要提到其可用性和可靠性，为了减轻元数据服务器的压力，分布式系统中，会在其他节点缓存元数据，缓存的元数据由带来了一致性的挑战，由此引入了Lease机制。</p>\n<h1>references</h1>\n<ul>\n<li>刘杰的《分布式系统原理介绍》</li>\n<li><a href=\"http://book.mixu.net/distsys/\" target=\"_blank\">Distributed systems for fun and profit  </a></li>\n<li><a href=\"https://en.wikipedia.org/wiki/Consistent_hashing\" target=\"_blank\">Wiki：Consistent_hashing</a></li>\n<li><a href=\"https://www.ibm.com/developerworks/cn/opensource/os-cn-hadoop-name-node/\" target=\"_blank\">Hadoop NameNode 高可用 (High Availability) 实现解析</a></li>\n<li><a href=\"http://www.cnblogs.com/xybaby/p/6871764.html\" target=\"_blank\">CAP理论与MongoDB一致性、可用性的一些思考</a></li>\n<li><a href=\"http://web.eecs.umich.edu/~mosharaf/Readings/Leases.pdf\" target=\"_blank\">Leases: An Efficient Fault-Tolerant Mechanism for Distributed File Cache Consistency</a></li>\n</ul>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111716\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111716votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111716\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 3 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>');
INSERT INTO `jobbole_article` VALUES ('实现前后端分离的心得', '2017-07-08', 'http://blog.jobbole.com/111624/', '83036acfe38763334b3abfe88bc409c1', 'http://jbcdn2.b0.upaiyun.com/2017/07/67e8579ee2214313c2b2984471596e35.png', 'full/cb6856e79b5025e46c895464e60a86e2f6c4e811.jpg', '0', '5', '1', 'IT技术,前端,后端', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/chenjg/p/6992062.htm\">陈陈jg</a>   </div><div id=\"cnblogs_post_body\">\n<h1 id=\"实现前后端分离的心得\">实现前后端分离的心得</h1>\n<p>对目前的web来说，前后端分离已经变得越来越流行了，越来越多的企业/网站都开始往这个方向靠拢。那么，为什么要选择前后端分离呢？前后端分离对实际开发有什么好处呢?</p>\n<h2 id=\"为什么选择前后端分离\"><strong>为什么选择前后端分离</strong></h2>\n<ul>\n<li><strong>在以前传统的网站开发中，前端一般扮演的只是切图的工作，只是简单地将UI设计师提供的原型图实现成静态的HTML页面，而具体的页面交互逻辑，比如与后台的数据交互工作等，可能都是由后台的开发人员来实现的，或者是前端是紧紧的耦合后台。比如，以前淘宝的Web基本上都是基于MVC框架webx，架构决定了前端只能依赖后端。所以他们的开发模式依然是，前端写好静态demo，后端翻译成VM模版，这种模式的问题就不说了，被吐槽了很久。</strong></li>\n<li><strong>而且更有可能后台人员直接兼顾前端的工作，一边实现API接口，一边开发页面，两者互相切换着做，而且根据不同的url动态拼接页面，这也导致后台的开发压力大大增加。前后端工作分配不均。不仅仅开发效率慢，而且代码难以维护。而前后端分离的话，则可以很好的解决前后端分工不均的问题，将更多的交互逻辑分配给前端来处理，而后端则可以专注于其本职工作，比如提供API接口，进行权限控制以及进行运算工作。而前端开发人员则可以利用nodejs来搭建自己的本地服务器，直接在本地开发，然后通过一些插件来将api请求转发到后台，这样就可以完全模拟线上的场景，并且与后台解耦。前端可以独立完成与用户交互的整一个过程，两者都可以同时开工，不互相依赖，开发效率更快，而且分工比较均衡。</strong></li>\n</ul>\n<h2 id=\"如何做到前后端分离\"><strong>如何做到前后端分离</strong></h2>\n<p>(以下的内容都是基于我们的电影购票网站来讨论的)<br>\n前端的技术框架是: vue全家桶+nodejs+express(实现的是单页面(SPA)应用)<br>\n首先，先分清楚前后端的工作</p>\n<ul>\n<li>前端的工作：实现整一个前端页面以及交互逻辑，以及利用ajax与nodejs服务器（中间层)交互</li>\n<li>后端的工作：提供API接口，利用redis来管理session,与数据库交互</li>\n</ul>\n<p>我们项目的整一个架构如下:</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/67e8579ee2214313c2b2984471596e35.png\" alt=\"这里写图片描述\"></p>\n<p><strong>接下来进入正题，如何实现前后端分离</strong></p>\n<ol>\n<li>一般来说，要实现前后端分离，前端就需要开启一个本地的服务器来运行自己的前端代码，以此来模拟真实的线上环境，并且，也是为了更好的开发。因为你在实际开发中，你不可能要求每一个前端都去搭建一个java(php)环境，并且在java环境下开发，这对于前端来说，学习成本太高了。但如果本地没有开启服务器的话，不仅无法模拟线上的环境，而且还面临到了跨域的问题，因为你如果写静态的html页面，直接在文件目录下打开的话，你是无法发出ajax请求的(浏览器跨域的限制),因此，你需要在本地运行一个服务器，可是又不想搭建陌生而庞大的java环境，怎么办法呢？nodejs正好解决了这个问题。在我们项目中，我们利用nodejs的express框架来开启一个本地的服务器，然后利用nodejs的一个http-proxy-middleware插件将客户端发往nodejs的请求转发给真正的服务器，让nodejs作为一个中间层。这样，前端就可以无忧无虑的开发了</li>\n<li>由于前后端分离后，前端和后台同时开发时，就可能遇到前端已经开发好一个页面了，可是却等待后台API接口的情况。比如说A是负责前端，B是负责后台，A可能用了一周做好了基本的结构，并且需要API接口联调后，才能继续开发，而此时B却还没有实现好所需要的接口，这种情况，怎么办呢？在我们这个项目里，我们是通过了mock来提供一些假数据，我们先规定好了API接口，设计出了一套API文档，然后我们就可以通过API文档，利用mock(<a>http://mockjs.com)来返回一些假数据，这样就可以模拟发送API到接受响应的整一个过程，因此前端也不需要依赖于后端开发了，可以独立开发，等到后台的API全部设计完之后，就可以比较快速的联调</a>。</li>\n</ol>\n<h2 id=\"为什么要引入nodejs作为中间层\"><strong>为什么要引入nodejs作为中间层</strong></h2>\n<p>前面的我发的项目结构图中，已经表明，在这个项目里，我们将nodejs作为中间层，那么，为什么我们要特地引入nodejs呢？直接用java做不就行了吗？</p>\n<ul>\n<li>我觉得引入nodejs主要是为了分层开发，职责划分，nodejs作为前端服务器，由前端开发人员负责，前端开发人员不需要知道java后台是如何实现的，也不需要知道API接口是如何实现的，我们只需要关心我们前端的开发工作，并且管理好nodejs前端服务器，而后台开发人员也不需要考虑如何前端是如何部署的，他只需要做好自己擅长的部分，提供好API接口就可以；</li>\n<li>nodejs本身有着独特的异步、非阻塞I/O的特点，这也就意味着他特别适合I/O密集型操作，在处理并发量比较大的请求上能力比较强，因此，利用它来充当前端服务器，向客户端提供静态文件以及响应客户端的请求，我觉得这是一个很不错的选择。</li>\n</ul>\n<h2 id=\"前端服务器如何部署\"><strong>前端服务器如何部署</strong></h2>\n<p><strong>nodejs前端服务器的职责</strong></p>\n<ol>\n<li>作为静态文件服务器，当用户访问网站的时候，将index.html以及其引入的js、css、fonts以及图片返回给用户</li>\n<li>负责将客户端发来的ajax请求转发给后台服务器</li>\n</ol>\n<p><strong>其实前端服务器的部署工作是算比较简单的，具体有以下两个点:</strong></p>\n<ol>\n<li>将开发完的前端代码，利用webpack打包成静态压缩文件</li>\n<li>在服务器上，利用pm2负载均衡器来执行以下的代码来开启服务器:</li>\n</ol>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/e6da864d4af726f47beb4100fbf5bbff.png\"></p>\n<p>评论区有人提到有一个不错的文章，我看了下觉得写得确实很详细，大家也可能看一下:<a href=\"https://segmentfault.com/a/1190000009329474?_ea=2038402\">https://segmentfault.com/a/1190000009329474?_ea=2038402</a> (感觉这就是业务与专业的区别哈哈)<br>\n(PS:其实也有一个做法，就是用nginx来做反向代理，负责转发请求，根据客户端访问的url把这个请求转发到不同的服务，比如访问/api/*的请求，就转发到后台服务，访问其它的请求，就转发到nodejs服务)<br>\n以上，就是我对于前后端分离的一些看法，以及一些实践，如果大家有什么好的想法，欢迎交流。</p>\n<p>本次项目代码的地址为:<a href=\"https://github.com/chenjigeng/filmshopping\">https://github.com/chenjigeng/filmshopping</a></p>\n</div>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111624\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111624votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111624\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 5 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>');
INSERT INTO `jobbole_article` VALUES ('能当主力，能入虚拟机，还能随时打包带走，Linux 就是这么强大', '2017-07-08', 'http://blog.jobbole.com/111672/', '851c8144fffb89af1d9613091b149fa9', 'http://jbcdn2.b0.upaiyun.com/2014/04/e260ae4f5d153b25be87819b25ff0577.jpg', 'full/6085acc0af4696f5d49164561c6bc4f9b590fc26.jpg', '0', '1', '1', 'IT技术,Linux', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/\">zasdfgbnm</a>   </div><p>这里介绍一下自己管理自己的Linux桌面的一点经验吧，我觉得还是有不少可取之处的。先来说一下大多数人管理Linux桌面的方法有哪些不方便的地方吧：</p>\n<ul>\n<li>买新电脑了，又得在新电脑上安装Linux，安装各种软件，各种库，各种开发环境，配置各种服务，真麻烦。</li>\n<li>最近一直在用电脑A，干了好多事情安装了好多软件，也配置了不少开发环境跟各种服务，然而处于某种原因，我又要开始使用好久没用过的电脑B了，难道我要把在A上的做的各种配置在B上再重新做一遍？</li>\n<li>在Windows下做着PPT呢，发现需要调出自己之前的程序，然后根据若干组输入跑几个结果画张图好插到PPT里，然而这个程序是在Linux下写的，编译等的过程也严重依赖自己用的Linux环境，重启进Linux拿到结果再回Windows太不方便，想在Windows下配置好环境把自己的程序跑通更不容易。</li>\n<li>要对系统安装某个软件，或者进行一些比较危险的更新操作（要知道Archlinux滚动更新滚挂了太正常了），担心把系统搞挂了，系统备份又实在太麻烦，要真挂了，系统恢复起来更麻烦。</li>\n<li>我一直用Archlinux做主力，然而最近做的某件事情要用某个软件，这个软件官方只给了Ubuntu上的安装方式，Archlinux里面没有相应的包，在Archlinux上手动安装也太不方便。装个Ubuntu，然后暂时用几天Ubuntu吧，也是够折腾的。更何况有时候只是想用一小下而已，怎样才能最小化自己在折腾上浪费的时间呢？</li>\n<li>有的软件官方软件仓库里面没有，而<code>make install</code>的话则会在系统中安装上不被包管理器所管理的文件，将来卸载也不方便，我还是更希望所有的文件都在一个包管理器中管理的。</li>\n<li>听说新版本内核引入了某个牛逼的东西？我就想快速测试一下玩玩，我电脑还有计算在跑着呢，我可不想重启，那就只能用虚拟机尝试了。而且，一定要快速，我可不想为此特地装一个虚拟机。</li>\n</ul>\n<p>上述的这些不方便之处是可以通过自己管理系统时的一些技巧来克服的，本文目的就是来介绍一下这些技巧。通过这些技巧，我们实现的功能是：一台机器上，可以同时安装Windows跟若干Linux系统，Windows下可以通过虚拟机来运行位于本地磁盘的这些Linux系统，而这些Linux系统下也可以通过容器或者虚拟机的方式互相运行。并且这些系统可以非常方便地备份跟删除，也可以随时创建以及运行快照。并且这些Linux系统可以随时打包带走，只需要经过很少的修改，就能直接在U盘或者其他机器上运行。如果要换电脑，或者新装一台电脑，也不需要重新安装系统，只需要把已有的系统同步到新电脑就行。这也正是这篇文章标题的意思。</p>\n<p>为了行文的方便，我们假定读者有一台全新的机器，硬盘还没分区，也还没装任何系统。如果已经什么都装好了，而只是想迁移到我这种管理方式的话，我相信读者能够判断这个安装教程中哪些步骤是需要做的哪些步骤是不需要做的。 另外需要注意的是这不是一个手把手的一步一步的教程，中间有一些显然的步骤我就略去不写了，所以希望读者不要照着文章里的的命令不加思考地一条一条粘贴运行，而是要搞明白这些命令的目的是什么，然后根据你自己的情况来做相应的修改。</p>\n<h3 id=\"分区与子卷\">分区与子卷</h3>\n<p>具体怎么分区我就不说了，随便找个livecd启动进去，然后找到你自己最喜欢的分区程序，按照你的喜好把区分了就好。注意别忘了EFI分区。我这里需要说的是，分区的时候，不论有多少个发行版要安装，总共只给Linux划分两个分区：一个是swap，另一个则是一个大的btrfs分区。那个btrfs分区里面装着所有的文件，包括用户的个人数据，以及所有发行版的rootfs。这两个分区在格式化的时候，一定要给他们取Label，这么做的好处接下来我们很快就会看到。我的习惯是，swap分区的Label我就叫他“swap”，而那个btrfs分区我则叫他“linux”。创建好分区以后，如果格式化工作是在图形的分区管理程序下完成的，那么指定Label是个非常简单的工作，右键属性里面就有。如果是使用命令行工具格式化分区的，则可以使用<code>-L label</code>选项来指定label，比如：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac13847141676\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nmkswap -L swap /dev/sdb4\r\nmkfs.btrfs -L linux /dev/nvme0n1p4</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac13847141676-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac13847141676-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac13847141676-1\"><span class=\"crayon-v\">mkswap</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">L</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">swap</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">sdb4</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac13847141676-2\"><span class=\"crayon-v\">mkfs</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">btrfs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">L</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">linux</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">nvme0n1p4</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p>那个大的btrfs分区上的不同内容是通过btrfs的子卷来管理的，具体来讲就是为自己想安装的每个不同的Linux系统来创建一个单独的子卷。 比如说我电脑上同时安装了Archlinux、Ubuntu、Kali、Debian四个系统，那么的btrfs分区里面就有四个子卷：archlinux、ubuntu、kali、debian。 子卷的创建可以通过<code>btrfs subvolume create &lt;name&gt;</code>命令完成，比如说要创建我这五个子卷，需要做的事情就是：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac26711852960\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nmount /dev/disk/by-label/linux /mnt\r\ncd /mnt\r\nbtrfs subvolume create archlinux\r\nbtrfs subvolume create ubuntu\r\nbtrfs subvolume create kali\r\nbtrfs subvolume create debian</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac26711852960-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac26711852960-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac26711852960-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac26711852960-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac26711852960-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac26711852960-6\">6</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac26711852960-1\"><span class=\"crayon-v\">mount</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">disk</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">by</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">label</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">linux</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">mnt</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac26711852960-2\"><span class=\"crayon-v\">cd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">mnt</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac26711852960-3\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">create </span><span class=\"crayon-e\">archlinux</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac26711852960-4\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">create </span><span class=\"crayon-e\">ubuntu</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac26711852960-5\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">create </span><span class=\"crayon-e\">kali</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac26711852960-6\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">create </span><span class=\"crayon-v\">debian</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p>如果你只想装一个发行版，比如archlinux，那么只需要archlinux子卷就够了。另外，如果你想把用户数据单独放在一个子卷里，也是完全可以的，不过这里不推荐多个Linux系统共享同一个家目录，因为不同系统上安装的软件不同，同样的软件版本也不相同，即使版本相同，不同发行版也可能应用了不同的patch，这就导致在一个系统上用户家目录里面产生的配置文件，在另一个系统里无法兼容，产生奇怪的行为。</p>\n<h3 id=\"系统安装\">系统安装</h3>\n<p>创建好分区与子卷，下一步就是安装操作系统了。这里分两种情况来讲：第一种情况是你想要全新安装一个Linux操作系统；第二种情况则是你已经有了某个可用的操作系统了，而只是想把这个操作系统迁移到文章所说的管理方式上。</p>\n<h4 id=\"全新安装\">全新安装</h4>\n<p>如果想要全新安装一个操作系统，安装方式上，作者只推荐纯手工安装，而不是用官方给的安装光盘不断点着“下一步”来进行安装。这么做是为了防止官方安装程序做一些我们不想让他做的事情，比如说自动安装grub。对于Archlinux跟Gentoo来讲，唯一的安装方法就是纯手工安装，所以只要按照官方的教程来就好了。对于deb系的系统，可以使用debootstrap程序。对于其他的发行版，可能会找不到手工安装的教程，这时候可以新建一个虚拟机，在虚拟机中使用官方的安装程序不断点击“下一步”来完成安装，然后按照下一节即将介绍的现有系统迁移教程把系统从虚拟机中迁移到现实机器上；除此之外，读者还可以找到发行版官方提供的安装程序的源代码阅读一下，看明白这些安装程序都在干啥，就知道怎么手工安装了，安装程序的代码还是相对简单的，有时间的读者不妨尝试一下。下面来具体说一下安装过程，这里只介绍Archlinux跟deb系。如果有多个Linux系统需要安装，建议先安装并完全配置好其中一个，让这个系统处于可用并且方便使用的状态，然后再在这个可用的系统中安装其他系统。这里我们假设读者已经完成了分区，创建了对应的子卷，并且把那个btrfs分区挂载在了<code>/mnt</code>上。</p>\n<h5 id=\"Archlinux的手动安装\">Archlinux的手动安装</h5>\n<p>Archlinux的手动安装主要还是看<a href=\"https://wiki.archlinux.org/index.php/Installation_guide\" target=\"_blank\" rel=\"external\">官方教程</a>。分区的时候注意按照上文介绍的方法。非常关键的<code>pacstrap</code>那一步注意使用如下命令安装到子卷里，而不是整个btrfs分区中:</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac30326238301\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npacstrap -d /mnt/archlinux base</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac30326238301-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac30326238301-1\"><span class=\"crayon-v\">pacstrap</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">d</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mnt</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">archlinux </span><span class=\"crayon-v\">base</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>至于fstab，就不要使用教程中的方法来生成了，我们的管理方式比较非常规，还是自己写fstab比较好。bootloader也要按照本文下文说的方式来安装跟配置。至于其他的设置键盘、设置网络、设置时区等操作，照着教程来就行。</p>\n<h5 id=\"deb系的手动安装\">deb系的手动安装</h5>\n<p>deb系的系统网上找到的教程都是使用发行版自带的安装程序的教程，并没有像Archlinux那么详细的手动安装教程。因为我们想要手动安装，所以我们就不参照网上的deb系的安装教程了。但是我们还是有教程可以参照的，那就是Archlinux的wiki里面<a href=\"https://wiki.archlinux.org/index.php/Systemd-nspawn#Create_a_Debian_or_Ubuntu_environment\" target=\"_blank\" rel=\"external\">关于systemd-nspawn的教程</a>，这个教程里面有一节介绍如何使用debootstrap安装Debian或者Ubuntu。具体安装过程请参照上述教程，其中关键命令如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac39678785599\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ndebootstrap --arch amd64 zesty /mnt/ubuntu http://archive.ubuntu.com/ubuntu/</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac39678785599-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac39678785599-1\"><span class=\"crayon-v\">debootstrap</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-e\">arch </span><span class=\"crayon-e\">amd64 </span><span class=\"crayon-v\">zesty</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mnt</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">ubuntu </span><span class=\"crayon-v\">http</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//archive.ubuntu.com/ubuntu/</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>值得一提的是，我们安装deb系的发行版并不一定要使用deb系的livecd，任何能够安装debootstrap程序的livecd都是可以的。比如说我们完全可以使用Archlinux的livecd来启动，然后安装debootstrap并通过debootstrap来安装Ubuntu。</p>\n<p>注意的是，debootstrap并不会像官方安装程序那样安装一个完整齐全开袋即食的操作系统，而只是安装最基本的软件包，读者需要根据自己的情况单独安装桌面环境等的软件包。同时fstab跟bootloader也要根据本文的方法自己配置。</p>\n<h4 id=\"现有系统迁移\">现有系统迁移</h4>\n<p>Linux系统的迁移其实非常简单，无非就是把rootfs的文件全都拷贝到目的地即可。不过这个过程虽然看似简单，但是还是有一些需要注意的东西的。比如说对于符号链接，如果处理不当，则会不小心把符号链接搞成实体文件，这就不好了。再比如说，文件的权限等元数据的问题，如果处理不当，可能会导致拷贝过程中元数据的丢失。这两种问题，都有可能会导致系统不能正常运行。还有一个需要注意的地方就是，正常运行的操作系统里，会有/proc、/dev等目录，这些目录都是单独的虚拟文件系统，是不需要拷贝的，也是无法拷贝的。</p>\n<p>我们现在假设用户想要把位于A的Ubuntu系统迁移到目标子卷<code>/mnt/ubuntu</code>去。其中，A可能位于虚拟机中，可能位于另一台电脑上，也可能位于本地磁盘。对系统进行迁移，大方向上来讲，需要做的有两步：</p>\n<ol>\n<li>挂载相应分区，设置ssh，保证我们能够访问到A。</li>\n<li>使用<code>rsync</code>或者<code>btrfs send</code>命令来把数据从A发送到目标子卷中去。</li>\n</ol>\n<p>第一步具体怎么做就不说了，分三种情况简单几句话概括一下怎么做：</p>\n<ul>\n<li>如果只是一个分区的话，mount就可以了</li>\n<li>如果是另一台机器，把那台机器配置好ssh，保证root用户可以用ssh访问</li>\n<li>如果是虚拟机，有两种选择，一种是想办法挂载虚拟机的磁盘镜像，然后像情况1那样处理；另一种则是配置好网络跟ssh，像情况2那样处理。具体采取哪种措施请读者根据自己的情况来自行决定。</li>\n</ul>\n<p>第二步我们来分别介绍<code>rsync</code>跟<code>btrfs send</code>两种方法。</p>\n<p><code>rsync</code>的方法<a href=\"https://wiki.archlinux.org/index.php/full_system_backup_with_rsync\" target=\"_blank\" rel=\"external\">这里有教程</a>可以参照。我们现在假设A的ip地址为<code>192.168.88.3</code>。则只需执行如下命令即可：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac3e580307217\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nrsync -aAXv --exclude={\"/dev/*\",\"/proc/*\",\"/sys/*\",\"/tmp/*\",\"/run/*\",\"/mnt/*\",\"/media/*\",\"/lost+found\"} root@192.168.88.3:/ /mnt/ubuntu</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac3e580307217-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac3e580307217-1\"><span class=\"crayon-v\">rsync</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">aAXv</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">exclude</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">{</span><span class=\"crayon-s\">\"/dev/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/proc/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/sys/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/tmp/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/run/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/mnt/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/media/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/lost+found\"</span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">@</span><span class=\"crayon-cn\">192.168.88.3</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mnt</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p>这里提醒读者注意自己系统上是否还有其他不想要同步的文件，记得一并排除掉。</p>\n<p><code>btrfs send</code>只在A的rootfs也是btrfs的情况下才能使用。<a href=\"https://btrfs.wiki.kernel.org/index.php/Incremental_Backup\" target=\"_blank\" rel=\"external\">这个方法的教程参见这里</a>。首先需要做的是在A机器上给rootfs创建一个只读快照（注意下面命令是在A机器上执行的）：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac44822496740\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nbtrfs subvolume snapshot -r / /ubuntu</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac44822496740-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac44822496740-1\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-v\">snapshot</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">r</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>注意上面命令中快照的名字要和目标子卷的名字相同，这样可以省去将来改名的麻烦。然后就可以使用<code>btrfs send</code>命令来把快照/ubuntu中的内容发送到目的地了，在这之前我们需要暂时删除我们分区的时候创建的ubuntu子卷，这个子卷会在接收过程中自动重新创建：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac48249957168\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nbtrfs subvolume delete /mnt/ubuntu\r\nssh root@192.168.88.3 btrfs send /ubuntu | btrfs receive /mnt</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac48249957168-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac48249957168-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac48249957168-1\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-v\">delete</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mnt</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">ubuntu</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac48249957168-2\"><span class=\"crayon-e\">ssh </span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">@</span><span class=\"crayon-cn\">192.168.88.3</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">btrfs </span><span class=\"crayon-v\">send</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">btrfs </span><span class=\"crayon-v\">receive</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mnt</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p>最后在A机器上把刚刚创建的快照删除就可以了</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac4b888900753\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nbtrfs subvolume delete /ubuntu</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac4b888900753-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac4b888900753-1\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-v\">delete</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p></p>\n<h3 id=\"bootloader与fstab\">bootloader与fstab</h3>\n<p>系统装好了，我们的fstab还没设置，启动管理器也还没安装配置。下面来讲讲怎么配置这两样东西。我们之前说过一定要给分区取一个Label，玄机在这里。如何在虚拟机中直接运行本地磁盘上安装的Linux，以及如何能把一个系统直接进行打包带走而不需要更改太多配置，关键也在这里。</p>\n<h4 id=\"fstab\">fstab</h4>\n<p>先来说说fstab，fstab总共有五列，分别为fs、mountpoint、type、opts跟dump/pass。这五列分别为什么意思、以及fstab该怎么填，网上一查便知，在此不再赘述。这里只说我们需要做的跟常规不一样的地方。</p>\n<p>第一个要注意的事情是，大家在填写fstab的时候，通常喜欢在fs那一列填写类似<code>/dev/sda4</code>或者<code>UUID=d5acc217-d524-4a2d-a937-bad945a047b2</code>，而在这里这样是不行的，这里我们填写的是形如<code>/dev/disk/by-label/linux</code>这样的东西。也就是说，我们的fstab里面是通过分区的Label来找分区的。这么做的原因是，我们希望我们的rootfs不光能在这台机器上启动，还希望它能在虚拟机的环境中，或者当我们把rootfs打包带走同步到别的机器上的时候，也能正常启动。在这台机器上rootfs所在的分区叫做<code>/dev/sda4</code>，在别的机器上或者虚拟机里就不一定还叫<code>/dev/sda4</code>了。但是我们只要遵守自己的命名规则，所有机器上的这些分区我们都取相同的Label，那么我们的fstab就是放之四海而皆准的，不需要为不同的环境而更改。</p>\n<p>第二个需要注意的问题是，不要填写rootfs的条目。这种做法跟通常发行版或者其他用户的默认做法是非常不相同的。为了理解这一点，先来说说Linux系统的启动过程。通常情况下，Linux启动的时候，首先由bootloader把内核装载到内存，并向内核传递参数告诉内核rootfs的位置。接下来内核就会根据传递的参数，以只读方式挂载rootfs，并执行rootfs中的init程序。init程序会调用相应的初始化程序执行各种初始化操作。其中一项初始化操作就是根据fstab的配置，来重新以读写方式挂载rootfs，并且挂载fstab里面配置的其他各个分区到指定位置。明白了Linux启动的过程，我们就知道，fstab里面的rootfs那一行其实不是必须的。删掉了rootfs那一行，我们只需要通过修改bootloader传递给内核的参数，就可以告诉内核直接以读写而不是只读的方式挂载rootfs。</p>\n<p>那么，我们在写fstab的时候不写rootfs那一项有啥好处呢？好处就是，我们不仅希望我们的系统能在裸机上用，还希望我们的系统能在虚拟机上用。在下文设置qemu虚拟机的时候，我们会以virtfs的方式把我们的子卷传递给虚拟机，这个时候rootfs就已经不再是<code>/dev/disk/by-label/linux</code>了，如果我们把rootfs的挂载方式硬编码到fstab里面，那么会导致init程序的失败，进而无法启动。</p>\n<p>另外有一点值得一提的小技巧是，很多时候我们还有别的一些个分区想要自动挂载。问题在于，这些分区在虚拟机环境中，并不一定是存在的，这就会导致启动的时候由于无法挂载而启动失败。其实系统的设计者早就考虑到这个问题了。如果你不希望fstab中的某些条目自动挂载，在选项里面增加<code>noauto</code>即可。如果你希望一些条目自动挂载，但是这些条目不是那么重要，即使挂载失败也不希望这些条目导致启动失败，可以在选项中增加<code>nofail</code>。这两个选项真的是给我们的系统管理工作提供了非常大的方便。比如说我们可能会在fstab中增加<code>/dev/disk/by-label/swap</code>的条目，以便开机自动将这个分区设置为交换分区供系统使用。然而后面我们会看到，我们设置虚拟机的时候，这个分区在虚拟机环境下，并不一定是可用的。这种情况下，我们希望系统在找不到这个分区的时候直接忽略错误不用swap便是，而不是报错拒绝启动。</p>\n<p>说了这么多，直接贴一个fstab的例子好了：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac51670545288\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntmpfs                  		/tmp	tmpfs	defaults		0 0\r\n/dev/disk/by-label/swap		none	swap	defaults,nofail		0 0</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac51670545288-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac51670545288-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac51670545288-1\"><span class=\"crayon-v\">tmpfs</span><span class=\"crayon-h\">                  		</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">tmp	</span><span class=\"crayon-e\">tmpfs	</span><span class=\"crayon-i\">defaults</span><span class=\"crayon-h\">		</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac51670545288-2\"><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">disk</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">by</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">label</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">swap		</span><span class=\"crayon-e\">none	</span><span class=\"crayon-e\">swap	</span><span class=\"crayon-v\">defaults</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">nofail</span><span class=\"crayon-h\">		</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p></p>\n<h4 id=\"bootloader\">bootloader</h4>\n<p>再来说说启动管理器，这里作者推荐的启动管理器是refind，<a href=\"http://www.rodsbooks.com/refind/installing.html\" target=\"_blank\" rel=\"external\">安装教程官网有</a>，在此不赘述。这里只讲一下启动项怎么写。先贴示例代码：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac58121623502\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nmenuentry archlinux {\r\n	icon EFI/refind/icons/os_arch.png\r\n	volume linux\r\n	loader archlinux/boot/vmlinuz-linux\r\n	options \"root=/dev/disk/by-label/linux rootflags=subvol=archlinux rw\"\r\n	initrd archlinux/boot/initramfs-linux.img\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac58121623502-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac58121623502-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac58121623502-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac58121623502-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac58121623502-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac58121623502-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac58121623502-7\">7</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac58121623502-1\"><span class=\"crayon-e\">menuentry</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">archlinux</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac58121623502-2\"><span class=\"crayon-h\">	</span><span class=\"crayon-e\">icon </span><span class=\"crayon-v\">EFI</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">refind</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">icons</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">os_arch</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">png</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac58121623502-3\"><span class=\"crayon-e\">	</span><span class=\"crayon-e\">volume </span><span class=\"crayon-e\">linux</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac58121623502-4\"><span class=\"crayon-e\">	</span><span class=\"crayon-e\">loader </span><span class=\"crayon-v\">archlinux</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">boot</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">vmlinuz</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">linux</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac58121623502-5\"><span class=\"crayon-e\">	</span><span class=\"crayon-i\">options</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"root=/dev/disk/by-label/linux rootflags=subvol=archlinux rw\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac58121623502-6\"><span class=\"crayon-h\">	</span><span class=\"crayon-e\">initrd </span><span class=\"crayon-v\">archlinux</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">boot</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">initramfs</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">linux</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">img</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac58121623502-7\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0011 seconds] -->\r\n<p>其中第三行的volume用来指定内核存放的分区，此分区可以通过多种方式来指定，比如通过分区的GUID，但是对我们来说最重要的是可以通过文件系统的Label来指定。我们的rootfs分区Label是”linux”，所以这一行写作<code>volume linux</code>。</p>\n<p>接下来就是指定内核位置、内核参数跟initramfs的位置了。其中loader用来指定内核位置，options用来指定内核参数，initrd则用来指定initramfs的位置。示例中的是Archlinux系统，内核是archlinux子卷中的<code>boot/vmlinuz-linux</code>文件，所以写作<code>loader archlinux/boot/vmlinuz-linux</code>。类似，initrd那一行则写作<code>initrd archlinux/boot/initramfs-linux.img</code>。至于内核参数，<code>root=/dev/disk/by-label/linux</code>告诉内核我们的rootfs所在的分区，<code>rootflags=subvol=archlinux</code>告诉内核挂载名为archlinux的子卷，<code>rw</code>则告诉内核以读写方式挂载。对于Ubuntu系统，这三行应该写作：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac5c022792631\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nloader ubuntu/vmlinuz\r\noptions \"root=/dev/disk/by-label/linux rootflags=subvol=ubuntu rw\"\r\ninitrd ubuntu/initrd.img</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac5c022792631-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac5c022792631-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac5c022792631-3\">3</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac5c022792631-1\"><span class=\"crayon-e\">loader </span><span class=\"crayon-v\">ubuntu</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">vmlinuz</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac5c022792631-2\"><span class=\"crayon-i\">options</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"root=/dev/disk/by-label/linux rootflags=subvol=ubuntu rw\"</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac5c022792631-3\"><span class=\"crayon-e\">initrd </span><span class=\"crayon-v\">ubuntu</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">initrd</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">img</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>细心的读者可能已经发现，我们的refind的配置文件中在指定分区的时候用的全是他们的Label，这就保证了这个配置文件的普适性，换台电脑，只要你用同样的管理方式，同样的命名习惯，配置文件里面的东西动都不用动，直接拷贝过去就行。</p>\n<h3 id=\"系统的备份与恢复以及快照的应用\">系统的备份与恢复以及快照的应用</h3>\n<p>由于使用了btrfs的动态卷，所以备份恢复工作做起来非常简单。备份系统只需要创建快照即可：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac60624561786\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ncd /mnt\r\nbtrfs subvolume snapshot archlinux backup</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac60624561786-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac60624561786-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac60624561786-1\"><span class=\"crayon-v\">cd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">mnt</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac60624561786-2\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">snapshot </span><span class=\"crayon-e\">archlinux </span><span class=\"crayon-v\">backup</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>至于恢复，其实我们根本不需要恢复，直接把快照作为rootfs用就行。我们只需要去refind的配置文件里面，把相应的启动项改改即可。比如说对于Archlinux而言，只需要改成：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac63058921660\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nmenuentry archlinux {\r\n	icon EFI/refind/icons/os_arch.png\r\n	volume linux\r\n	loader backup/boot/vmlinuz-linux\r\n	options \"root=/dev/disk/by-label/linux rootflags=subvol=backup rw\"\r\n	initrd backup/boot/initramfs-linux.img\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac63058921660-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac63058921660-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac63058921660-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac63058921660-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac63058921660-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac63058921660-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac63058921660-7\">7</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac63058921660-1\"><span class=\"crayon-e\">menuentry</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">archlinux</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac63058921660-2\"><span class=\"crayon-h\">	</span><span class=\"crayon-e\">icon </span><span class=\"crayon-v\">EFI</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">refind</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">icons</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">os_arch</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">png</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac63058921660-3\"><span class=\"crayon-e\">	</span><span class=\"crayon-e\">volume </span><span class=\"crayon-e\">linux</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac63058921660-4\"><span class=\"crayon-e\">	</span><span class=\"crayon-e\">loader </span><span class=\"crayon-v\">backup</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">boot</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">vmlinuz</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">linux</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac63058921660-5\"><span class=\"crayon-e\">	</span><span class=\"crayon-i\">options</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"root=/dev/disk/by-label/linux rootflags=subvol=backup rw\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac63058921660-6\"><span class=\"crayon-h\">	</span><span class=\"crayon-e\">initrd </span><span class=\"crayon-v\">backup</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">boot</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">initramfs</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">linux</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">img</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac63058921660-7\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0012 seconds] -->\r\n<p>如果有强迫症，觉得rootfs名字不叫archlinux很不爽，那其实改名也很简单:</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac66671347660\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ncd /mnt\r\nbtrfs subvolume delete archlinux\r\nbtrfs subvolume snapshot backup archlinux</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac66671347660-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac66671347660-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac66671347660-3\">3</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac66671347660-1\"><span class=\"crayon-v\">cd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">mnt</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac66671347660-2\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">delete </span><span class=\"crayon-e\">archlinux</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac66671347660-3\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">snapshot </span><span class=\"crayon-e\">backup </span><span class=\"crayon-v\">archlinux</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p>其实，btrfs的快照功能不仅可以用来备份与恢复系统，还有很多非常灵活的运用的。比如说我想在系统里面安装一个巨大而又混乱的软件，这个软件我只想用几天干一件事情，干完这件事情我就不想用了。问题是，这个软件在官方的软件仓库并没有，要安装，我只能使用软件提供的安装程序来安装，然而软件并没有提供卸载程序，或者卸载程序卸载的很不彻底，会在系统残留垃圾。我想用这软件，然而又不想脏了我的系统，这该怎么办？很简单：创建一个快照，新增加一条以快照为rootfs的启动项，要用软件了就启动到快照中去，用完这个软件以后把快照删除即可。再比如说，我想要搞个虚拟机跟实体机一起来测试某个东西（比如说测试某些网络协议、测试某些集群管理软件等），这个时候我根本没必要重新用安装光盘去装一个虚拟机，只需要创建一个快照，然后把快照作为虚拟机的rootfs启动即可，具体方法下文会介绍，在此不多说。当然，快照的应用还远远不止我说的这些，更多好玩的应用还待读者自己探索。</p>\n<h3 id=\"Windows下访问Linux\">Windows下访问Linux</h3>\n<p>从文章的刚开头我们就说，有时候我们是有在Windows下运行本地安装的Linux的需求的。这个需求可以通过VirtualBox来满足，只需要在VirtualBox中使用本地磁盘来作虚拟磁盘即可。说起来简单，但是实现起来还是需要折腾一下子的。</p>\n<p>首先我们需要新建一个虚拟机，具体过程不多说，一路“下一步”就行了，唯一需要注意的是，在创建虚拟磁盘的那一步，选择“不添加虚拟硬盘”：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/virt_hdd.png\" rel=\"group\"><img class=\"aligncenter\" title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/virt_hdd.png\" alt=\"virt_hdd.png\"></a></p>\n<p>这里我的虚拟机取名为“Linux”。创建完虚拟机了以后，就需要把本地磁盘设置为虚拟磁盘了。VirtualBox只能通过命令来做这件事情，<a href=\"http://www.serverwatch.com/server-tutorials/using-a-physical-hard-drive-with-a-virtualbox-vm.html\" target=\"_blank\" rel=\"external\">教程可以在这里找到</a>。首先要做的是寻找我们安装Linux的磁盘的编号，这个可以在系统自带的磁盘管理程序中找到，在我的机器上这个磁盘编号为2：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/dskmgr.png\" rel=\"group\"><img class=\"aligncenter\" title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/dskmgr.png\" alt=\"dskmgr.png\"></a><br>\n知道了磁盘的编号，就可以创建虚拟盘了。这里我们使用的命令如下，注意使用管理员身份运行：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac6c326003714\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nVBoxManage internalcommands createrawvmdk -filename \"C:\\Users\\gaoxiang\\VirtualBox VMs\\Linux\\localdisk.vmdk\" -rawdisk \\\\.\\PhysicalDrive2</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac6c326003714-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac6c326003714-1\"><span class=\"crayon-e\">VBoxManage </span><span class=\"crayon-e\">internalcommands </span><span class=\"crayon-v\">createrawvmdk</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">filename</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"C:\\Users\\gaoxiang\\VirtualBox VMs\\Linux\\localdisk.vmdk\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">rawdisk</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">\\</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">PhysicalDrive2</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>有了虚拟磁盘了，就可以将虚拟磁盘添加到虚拟机中去了：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/newdisk.png\" rel=\"group\"><img class=\"aligncenter\" title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/newdisk.png\" alt=\"newdisk.png\"></a></p>\n<p>虚拟磁盘设置好了，最后一步就是设置EFI了。由于我们之前在分区的时候给文件系统都赋予了Label，并且在refind设置的时候也是用的Label来指定分区，所以同一套refind的配置在虚拟机上也能用。因此我们不需要单独给虚拟机安装bootloader，而是直接用我们之前安装在物理磁盘上的EFI分区中的refind就行。VitualBox默认是不开启EFI的，我们需要在虚拟机的系统设置里面手动勾选EFI：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/efi.png\" rel=\"group\"><img class=\"aligncenter\" title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/efi.png\" alt=\"efi.png\"></a><br>\n为了要让VirtualBox自动启动refind，还要对EFI的分区做一些简单的设置，<a href=\"https://wiki.archlinux.org/index.php/VirtualBox#Installation_in_EFI_mode\" target=\"_blank\" rel=\"external\">设置的教程参考这里</a>。设置的时候一定要注意，这些设置一定要是通用的，即同一份文件既能在物理机上正常工作也能在虚拟机上正常工作，不要改完了设置以后虚拟机上能跑了物理机却挂了，这就不好玩了。VirtualBox的EFI在启动的时候会优先选择<code>/EFI/BOOT/BOOTX64.EFI</code>，如果找不到的话，才会启动EFI分区根目录下的<code>startup.nsh</code>中指定的bootloader。知道了这一点，为了实现自动启动refind，首先需要检查一下<code>/EFI/BOOT/BOOTX64.EFI</code>这个文件是否存在，若存在，备份并删除之：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac73304592758\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ncd EFI/BOOT\r\nmv bootx64.efi bootx64-backup.efi</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac73304592758-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac73304592758-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac73304592758-1\"><span class=\"crayon-e\">cd </span><span class=\"crayon-v\">EFI</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">BOOT</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac73304592758-2\"><span class=\"crayon-e\">mv </span><span class=\"crayon-v\">bootx64</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">efi </span><span class=\"crayon-v\">bootx64</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">backup</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">efi</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>然后就是在EFI分区根目录下新建一个<code>startup.nsh</code>了，这个文件只需要一行，内容如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac79815753763\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n\\EFI\\refind\\refind_x64.efi</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac79815753763-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac79815753763-1\"><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">EFI</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">refind</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">refind_x64</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">efi</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>一切设置完毕，运行虚拟机，就能看到我们熟悉的refind界面了：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/refind.png\" rel=\"group\"><img class=\"aligncenter\" title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/refind.png\" alt=\"refind.png\"></a><br>\n打开其中的Ubuntu系统，测试一切正常就大功告成了：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/ubuntu.png\" rel=\"group\"><img class=\"aligncenter\" title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/ubuntu.png\" alt=\"ubuntu.png\"></a></p>\n<p>当然，要在虚拟机中使用，还有一些细节性的工作要处理，比如安装VirtualBox的guest需要的相应的内核模块等等，这些在此不谈，读者使用过程中如果发现少啥了，自己装上便是。</p>\n<h3 id=\"Linux下不同发行版的互相访问\">Linux下不同发行版的互相访问</h3>\n<p>我们已经成功地在Windows下运行Linux了，下一步就是想办法在一个Linux系统下访问其他Linux了。由于这些系统都是Linux，而且都在同一个文件系统里面，所以如果只是想要访问一下里面的文件的话，挂载了用就行了。但是很多时候我们还是有需要来运行其他系统里面安装的程序，或者对那个系统进行管理的。应对这种需求有两种解决方案：容器跟虚拟机。</p>\n<p>可能很多读者并不了解这两者的区别，这里简单介绍一下。粗略来讲，虚拟机是通过软件的方式虚拟出一套硬件环境来，并在这套硬件环境中启动内核，然后内核会进行一个完整的开机过程，包括进行相应的初始化，加载init程序等。相比之下，容器则要轻量很多。容器并不会虚拟出自己的硬件环境，也不会额外加载一个内核。容器所做的，就是在现有内核上，运用namespace来创建出一套独立的进程PID、挂载点、网络接口、用户ID等等，由于不同namespace中的这些个ID之类的标识符都是独立的，所以不同namespace中的进程是互相之间看不到对方的，虚拟出来的环境乍看上去就跟在单独运行的一个系统一样，同样有PID为1的init进程，有自己一套独立的rootfs，等等。虚拟机的优点是更不容易被突破，安全性更好，可以使用自己的内核，但是效率也更低。容器的优点是轻便效率高，但是安全性就要稍差一些，也没法使用定制内核。</p>\n<h4 id=\"容器\">容器</h4>\n<p>Linux下大家最熟悉的容器就是chroot了，但是作者并不喜欢chroot，主要原因有两点：</p>\n<ul>\n<li>/proc、 /dev等东西不会自动挂载，每次手动挂载挂的心好累</li>\n<li>没有一个相对完整的开机过程，好多我希望自动启动的服务并不会运行起来</li>\n</ul>\n<p>基于上面的原因，作者在这里推荐的容器是systemd-nspawn。关于systemd-nspawn的介绍跟使用教程，<a href=\"https://wiki.archlinux.org/index.php/Systemd-nspawn\" target=\"_blank\" rel=\"external\">推荐看这里</a>。systemd-nspawn的使用非常简单，假设你的linux分区已经mount到了/mnt上去了，那么你只需要下面步骤就能启动一个systemd-nspawn容器（以Debian为例）：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac7f494070786\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ncd /mnt/debian\r\nsystemd-nspawn -b</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac7f494070786-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac7f494070786-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac7f494070786-1\"><span class=\"crayon-v\">cd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mnt</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">debian</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac7f494070786-2\"><span class=\"crayon-v\">systemd</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">nspawn</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">b</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>然后就能看到刷刷刷的开机界面了，真的是非常的方便快捷。这里还有一点小技巧是，如果嫌每次开容器都要把linux分区挂载到/mnt上太麻烦，可以在<code>/var/lib/machines</code>里面为每个系统新建一个目录，然后在fstab里面设置一下自动把相应的子卷挂载进去：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac85420373047\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n/dev/disk/by-label/linux        /var/lib/machines/kali          btrfs           defaults,nofail,noatime,discard,subvol=kali            0 0\r\n/dev/disk/by-label/linux        /var/lib/machines/debian        btrfs           defaults,nofail,noatime,discard,subvol=debian          0 0\r\n/dev/disk/by-label/linux        /var/lib/machines/ubuntu        btrfs           defaults,nofail,noatime,discard,subvol=ubuntu          0 0</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac85420373047-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac85420373047-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac85420373047-3\">3</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac85420373047-1\"><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">disk</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">by</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">label</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">linux</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">machines</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">kali          </span><span class=\"crayon-e\">btrfs           </span><span class=\"crayon-v\">defaults</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">nofail</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">noatime</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">discard</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">subvol</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">kali</span><span class=\"crayon-h\">            </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac85420373047-2\"><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">disk</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">by</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">label</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">linux</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">machines</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">debian        </span><span class=\"crayon-e\">btrfs           </span><span class=\"crayon-v\">defaults</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">nofail</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">noatime</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">discard</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">subvol</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">debian</span><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac85420373047-3\"><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">disk</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">by</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">label</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">linux</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">machines</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">ubuntu        </span><span class=\"crayon-e\">btrfs           </span><span class=\"crayon-v\">defaults</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">nofail</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">noatime</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">discard</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">subvol</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">ubuntu</span><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0025 seconds] -->\r\n<p>这么做的好处是，根目录位于<code>/var/lib/machines</code>的系统，在启动systemd-nspawn的时候可以直接使用<code>-M</code>选项来指定系统，而不需要进入相应目录。比如如果想启动Ubuntu系统：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac88229900558\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsystemd-nspawn -b -M ubuntu</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac88229900558-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac88229900558-1\"><span class=\"crayon-v\">systemd</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">nspawn</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">b</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">M</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ubuntu</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p></p>\n<h4 id=\"虚拟机\">虚拟机</h4>\n<p>如果只是想运行一下其他系统里面的程序，那么容器完全就够用了，但是有的时候我们还是需要玩玩不同的内核的，这就必须得用虚拟机了。通常情况下，大家用虚拟机，都是新建一个磁盘镜像，然后插入安装光盘，然后把光盘安装到镜像上。这么做的坏处，一个是访问镜像中的文件不方便，另一个是，我们在本地已经有安装过若干系统了，不去充分利用一下这些而去再重新往镜像里面安装那实在是舍近求远。那我们就来找一个把子卷当成虚拟机rootfs的方法。困难在于，虚拟机是个很独立的东西，是无法直接访问宿主机的文件系统的。然而幸运的是，Linux的内核虚拟化方案KVM提供了一个把本地文件系统传递给虚拟机的解决方案，用到的东西叫做VirtFS，<a href=\"http://wiki.qemu.org/Documentation/9psetup\" target=\"_blank\" rel=\"external\">相关的文档见这里</a>。</p>\n<p>好消息是，VirtFS是可以作为rootfs的。但是要能正常挂载VirtFS，内核必须要有相应的驱动才行。这里有两种方法可以做到这一点。如果你是自己编译内核的话，那么建议直接将相应的驱动编译进内核而不是模块。根据官网的指示，涉及到的内核配置如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac8e062874159\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nCONFIG_NET_9P=y\r\nCONFIG_NET_9P_VIRTIO=y\r\nCONFIG_9P_FS=y\r\nCONFIG_9P_FS_POSIX_ACL=y</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac8e062874159-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac8e062874159-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac8e062874159-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac8e062874159-4\">4</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac8e062874159-1\"><span class=\"crayon-v\">CONFIG_NET_9P</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">y</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac8e062874159-2\"><span class=\"crayon-v\">CONFIG_NET_9P_VIRTIO</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">y</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac8e062874159-3\"><span class=\"crayon-v\">CONFIG_9P_FS</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">y</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac8e062874159-4\"><span class=\"crayon-v\">CONFIG_9P_FS_POSIX_ACL</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">y</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>如果使用的是发行版提供的内核的话，那么可以修改initramfs的相关设置保证9p、9pnet、9pnet_virtio三个modules能被安装到initramfs里面去。这里以Ubuntu做guest为例，具体做法是修改Ubuntu系统中的<code>/etc/initramfs-tools/modules</code>文件，增加下面三行：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac92669302376\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n9p\r\n9pnet\r\n9pnet_virtio</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac92669302376-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac92669302376-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac92669302376-3\">3</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac92669302376-1\"><span class=\"crayon-cn\">9p</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac92669302376-2\"><span class=\"crayon-cn\">9pnet</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac92669302376-3\"><span class=\"crayon-cn\">9pnet_virtio</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0003 seconds] -->\r\n<p>然后重新生成initramfs即可：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac95579255149\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nupdate-initramfs -u</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac95579255149-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac95579255149-1\"><span class=\"crayon-v\">update</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">initramfs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">u</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>内核驱动设置好了，就可以启动qemu虚拟机了，这里假定Ubuntu的rootfs已经被mount到了<code>/var/lib/machines/ubuntu</code>：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac98594737321\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nqemu-system-x86_64 -enable-kvm -m 16G -kernel /var/lib/machines/ubuntu/vmlinuz -initrd /var/lib/machines/ubuntu/initrd.img -virtfs local,id=root9p,path=/var/lib/machines/ubuntu,security_model=passthrough,mount_tag=root9p -nographic -append \'root=root9p rw rootfstype=9p rootflags=trans=virtio console=ttyS0 init=/lib/systemd/systemd\'</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac98594737321-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac98594737321-1\"><span class=\"crayon-v\">qemu</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">system</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">x86_64</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">enable</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">kvm</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">m</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">16G</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">kernel</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">machines</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">vmlinuz</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">initrd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">machines</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">initrd</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">img</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">virtfs </span><span class=\"crayon-v\">local</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">id</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">root9p</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">path</span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">machines</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">security_model</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">passthrough</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">mount_tag</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">root9p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">nographic</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">append</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\'root=root9p rw rootfstype=9p rootflags=trans=virtio console=ttyS0 init=/lib/systemd/systemd\'</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0022 seconds] -->\r\n<p>最后放一张成功的截图：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/qemu-ubuntu.png\" rel=\"group\"><img title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/qemu-ubuntu.png\" alt=\"qemu-ubuntu.png\"></a></p>\n<p>全剧终</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111672\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111672votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111672\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>');
INSERT INTO `jobbole_article` VALUES ('软件开发和测试的 30 个最佳实践', '2017-07-08', 'http://blog.jobbole.com/111586/', 'a35c31c7eaba3371c3f60292f71bcac1', 'http://jbcdn2.b0.upaiyun.com/2017/06/ff44b5eb59d4099f998494217811a2b9.jpg', 'full/af2aa7503b9a5a4b73437fab997885a3d7f1ae8e.jpg', '0', '6', '3', '开发,最佳实践', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/maifansnet\">maifans</a> 翻译，<a href=\"http://www.jobbole.com/members/huanglimin\">黄利民</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://opensource.com/article/17/5/30-best-practices-software-development-and-testing\">Michael Foord</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><div>\n<blockquote><p>这些软件开发和测试的最佳实践，可以帮你节省时间和避免问题。</p></blockquote>\n</div>\n<p>加入一个企业文化和编程实践已经定型的新公司，可能会是一种令人沮丧的经历。当我加入 Ansible 团队后，我决定整理我多年以来所学并为之奋斗的软件工程实践和准则。这是一个不明确的也不够详尽的准则列表，使用它们时需要智慧和灵活性。</p>\n<p>我对测试充满热情，因为我相信良好的测试实践既能确保满足最低质量标准（可悲的是许多软件产品做不到），并能指导和塑造开发本身。本文提到的这些准则，很多是与测试实践和理念相关的。其中一些准则针对 Python 的，但大多数不是。（对于 Python 开发者，<a href=\"https://www.python.org/dev/peps/pep-0008/\">PEP 8</a> 应该是编程风格和指南的首先。）</p>\n<p><img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/mw690/7cc829d3gy1fh276i91ycj20xc0m8tcd.jpg\" width=\"620\" height=\"413\"></p>\n<h2>开发和测试的最佳实践</h2>\n<p><strong>1. YAGNI 原则：“<a href=\"https://martinfowler.com/bliki/Yagni.html\" target=\"_blank\">You Aint Gonna Need It</a>”。不要写你认为将来可能需要但现在不需要的代码。</strong>这是为<b>假想的未来用例</b>编码，这些代码将不可避免地变成死代码，或需要重写，因为未来结果<b>总是</b>与想象的稍有不同。</p>\n<p>如果你写代码用于将来的用例，我将在代码评审中对其质疑。（你可能而且必须设计 API，并<b>确保</b>未来的用例可用，但这是不同的问题。）</p>\n<p>这条原则也适用于被注释掉的代码；如果一个被注释掉代码块即将进入一个发布版本，那么它就不应该存在。如果代码可能要还原，请为代码删除创建一个问题单并引用提交对象的哈希字符串。YAGNI 原则是敏捷编程的核心要素，这个话题最好的参考书是 Kent Beck 写的《解析极限编程》（《Extreme Programming Explained》）。</p>\n<p><b></b><strong>2 . 测试不需要测试。</strong>用于测试需要的基础设施、框架和库需要测试。除非你<b>真的需要</b>不要测试浏览器或外部库。测试你写的代码，而不是别人的代码。</p>\n<p><b></b><strong>3.当第三次编写相同的代码时，也是将其提取成通用的辅助函数（并为其编写测试）的正确时机。</strong>测试中的辅助函数不需要测试；但当你将它们剔除出去然后再重用它们时，它们需要测试。到你第三次编写类似代码的时候，你通常会清楚地认识到你正在解决的通用问题的模型是什么。</p>\n<p><b></b>4. 现在来谈谈 API 设计（面向外部的对象API）：<b>把简单的事情做简单了，复杂的事情自然成为可能</b>。首先设计简单的用例，如果有可能最好是零配置或参数化。为更复杂和灵活的用例（如需要）增加<b>选项</b>或额外的 API 方法。</p>\n<p><strong>5. 快速失败。</strong>检查输入，如果遇到无意义输入或非法状态则尽早失败，最好是通过异常或错误响应使问题对调用者变得清晰。允许你的代码处理“有创意”的用例（例如，除非真的需要，否则在做输入验证的时候不要做类型检查）。</p>\n<p><strong>6.单元测试测的是行为单元，而不是实现单元。</strong>我们的目标是在改动实现的情况下不改动行为，也不必更新测试，尽管这个目标不总是能实现。因此在可能的情况下将测试对象视为黑盒，通过公共 API 测试，而不调用私有方法或玩弄状态位。</p>\n<p>在一些复杂的情况可能做不到，如在特定的复杂状态下测试行为，以找到一个偶发的错误。这一点对于写测试非常有帮助，因为它迫使你在写测试代码之前思考你代码的行为以及你将如何测试它。测试首先鼓励更小，更模块化的代码单元，这通常意味着好代码。关于“测试优先”方法有一本很好的入门参考书，就是 Kent Beck 写的《测试驱动开发》(《Test Driven Development by Example》)</p>\n<p><strong>7. 对于单元测试（包括测试基础设施测试），所有代码路径都应该被测到。</strong>100% 覆盖是一个好的开始。你不能覆盖所有可能状态的排列/组合（组合性爆炸），因此这个问题需要考虑。只有当有很好理由的情况下才允许有代码路径未经测试。没有时间<b>不是</b>一个好理由，最终会花费更多的时间。可能的好理由包括：真正的不可测（以任何有意义的方式），现实中不可能发生，或被其它测试覆盖。没有测试的代码是一种债。测量覆盖率和拒绝减少覆盖率 PR(拉取请求) 是确保你在正确的方向演进的一种方式。</p>\n<p><strong>8. 代码是敌人：它可能出错，并且需要维护。</strong>少写代码，删除代码，不要写你不需要的代码。</p>\n<p><strong>9. 随着时间的推移，代码注释不可避免地成为谎言。</strong>在现实中，很少有人在事情变化的时候更新注释。通过良好的命名法和已知的编程风格，努力使你的代码可读和自文档化。</p>\n<p>对于那些晦涩的代码，<b>一定</b>要写注释，例如偶发错误或意外情况的变通方案，或者必要的优化。解释代码的<b>意图</b>和及其原因，而不是解释代码在做什么。（顺便说一句，有些观点认为注释变谎言是有争议的。我仍然认为这是正确的，《程序设计实践》(《The Practice of Programming》)的作者 Kernighan 和 Pike 同意我的观点。）</p>\n<p><strong>10. 防守思维。</strong>总是考虑什么会出错，无效的输入会引发什么，什么可能会失败，这将有助于你在许多错误发生之前发现他们。</p>\n<p><strong>11.无状态和无副作用的单元测试，其逻辑应简单</strong>。将逻辑分解成单独的函数，而不是将逻辑混合到有状态和充满副作用代码中。将有状态代码和有副作用代码，分为较小的更容易模拟的函数和无副作用地单元测试。（测试的开销越小意味着更快的测试）副作用<b>确实</b>需要测试，但是测试一次然后处处模拟它们通常是一个好的模式。</p>\n<p><strong>12. 全局变量不好。</strong>函数优于类型。对象可能比复杂的数据结构更好。</p>\n<p><strong>13.使用 Python 内置类型及其方法将比自己编写的类型运行快（除非你用C语言编写）</strong>。如果性能是一个考虑因素，请尝试弄懂如何使用标准的内置类型，而不是自定义对象。</p>\n<p>14. 依赖注入是一个实用的编程模式，明确你的依赖是什么和它们来自哪里。（对象，方法等以参数的形式接收它们的依赖，而不是实例化新对象本身。）这确实让 API 签名更复杂，所以这里需要权衡。如果一个方法最后为所有的依赖设置了10个参数，那这是一个不错的信号，不管为什么你的代码做得太多。关于依赖注入的权威文章是 Martin Fowler 的《控制反转容器&amp;依赖注入模式》(《Inversion of Control Containers and the Dependency Injection Pattern》)。</p>\n<p><strong>15. 需要模拟测试的代码越多，你的代码就越糟糕。</strong>为了测试一个特定的行为，需要实例化和牵扯的代码越多，代码越糟糕。我们的目标是小型可测试的单元，以及更高级别的集成和功能测试，以测试各单元是否配合正确。</p>\n<p><strong>16. 面向外部的 API 是“预先设计”——同时要考虑未来的用例——真正重要的地方。</strong>改变 API 对我们和用户来说是一种痛苦，造成向后不兼容是可怕的（尽管有时无法避免的）。设计面向外部的 API 要细心，仍然要坚持“把简单的事情做简单”的原则。</p>\n<p><strong>17.如果函数或方法超过 30 行代码，考虑分解它。</strong>一个良好的模块最大约 500 行。测试文件往往比这个要大。</p>\n<p><strong>18 .不要在对象构造函数中工作，这里很难测试而且经常发生意外。</strong>不要在__init__ .py中添加代码（导入命名空间除外）。__init__ .py不是程序员通常<b>期望</b>找代码的地方，所以它是个“惊喜”。</p>\n<p><strong>19. DRY（不要重复自己）在测试中没有在生产代码中要紧。</strong>单个测试文件的可读性比可维护性更重要（跳出模块复用的限制）。这是因为测试是单独被执行和阅读的，而且它们自己不是大系统的一部分。虽然在很多重复的时候创建可重用的组件更方便，但相较于产品代码，测试代码较少考虑。</p>\n<p><strong>20.每当你看到有需要有机会就重构。</strong>编程是关于抽象的，你的抽象映射越接近问题域，代码就越容易理解和维护。随着系统的有机增长，需要改变结构以扩大它们的用例。系统越来越多的抽象和结构，如果不改变它们就成为技术性的债务。它会是更加痛苦的工作（更慢，越来越多的错误）。在特性开发估计中请考虑清除技术债务（重构）的成本。你遗留债务的时间越长，积累的利息就越高。关于重构和和测试的一本很棒的书是 Michael Feathers 的《修改代码的艺术》(《Working Effectively with Legacy Code》)。</p>\n<p><strong>21. 代码正确为第一位，速度快第二位。</strong>在处理性能问题时，在修复错误之前先要做性能剖析。通常瓶颈不是你认为的那样。如果写晦涩的代码的唯一价值就是更快而且你已经做过性能剖析并证明了，那么它实际就是值得的。编写测试定期检测你要做性能剖析的代码，这样可以很容易让你知道你什么时候测试过。测试可以留在测试套件中，以防止性能退化。（通常情况下，添加定时代码总会改变代码的性能特性，使性能工作成为令人沮丧的任务之一。）</p>\n<p><strong>22. 当更小、范围有限的单元测试失败的时候，可以给出更多有价值的信息，告诉你具体是什么错误。</strong>如果一个测试牵涉了半个系统来测试行为，那么它需要更多的调查以确定什么是错误的。一般来说，运行超过 0.1 秒的测试不是单元测试。没有所谓的慢单元测试。用限定范围的单元测试测试行为，你的测试行为扮演了事实上的代码规范。理想情况下如果有人想了解你的代码，他们应该能够把测试套件转换为行为的“文档”。Gary Bernhardt 的《快测，慢测》(《Fast Test, Slow Test》)是关于单元测试实践的一篇很棒的演讲。</p>\n<p><strong>23. ”非我所创“不像人们说的那么坏。</strong>如果代码是我们写的，那么我们知道它是什么，我们知道如何维护它，在我们可以在适当的时候自由地扩展和修改它。这遵循了 YAGNI 原则：我们用那些适合我们需要用例的特定代码，而不用我们不需要的可以做复杂事情的通用代码。另一方面，代码是敌人，拥有必要的代码比拥有更多的代码更好。引入新的依赖关系时要权衡。</p>\n<p><strong>24. 共享代码所有权是我们目标；沉默的知识不是好知识。</strong>这意味着最低限度要讨论或记录设计决策和重要的实施决策。代码评审（Code Review）是开始讨论设计决策的最坏时刻，因为在代码编写后，很难彻底更改。（当然在评审时指出并修改设计错误比没有好。）</p>\n<p><strong>25. 生成器很棒！</strong>它们通常比迭代或重复执行的状态对象更短更容易理解。David Beazley的《系统程序员的生成器诀窍》(《Generator Tricks for Systems Programmers》)是关于生成器一个很好的介绍。</p>\n<p><strong>26.让我们成为工程师！让我们考虑设计、构建健壮并实现良好的系统，而不是做膨胀的有机怪物。</strong>然而编程是一种平衡。我们并不总是建造火箭。过度设计（洋葱架构）同设计不完善的代码一样，处理起来非常痛苦。Robert Martin 的作品几乎都值得一读，《架构之洁：一个工匠的软件结构和设计指南》(《Clean Architecture: A Craftsman’s Guide to Software Structure and Design》)是这个话题一个很好的资源。《设计模式》(《Design Patterns》)是每一位工程师都应该阅读的经典编程书。</p>\n<p><strong>27. 间歇失败的测试会侵蚀测试套件的价值，以至于最终每个人都忽略测试运行结果，因为总有一些失败的事情。</strong>修复或删除间歇性失败测试是痛苦的，但这些努力是值得的。</p>\n<p><strong>28. 一般来说，特别是在测试中，在需要等待一个特定的变化时候不要采用休眠随机时间的方式。</strong>Voodoo（Python 库） 的 sleeps 很难理解而且使你的测试套件变慢。</p>\n<p><strong>29. 至少让你的测试失败一次。</strong>故意加入一个错误，并确保它失败，或在测试的行为不完整的情况下运行测试。否则你不知道你真的在测试什么。瞎写的测试实际上不能测试任何东西或它很可能永远不会失败。</p>\n<p><strong>30. 最后一点：只关注特性改进是开发软件的一种可怕方式。</strong>如果开发者的工作不能确保最好的结果，那么不要让他们为自己的工作感到自豪。不处理技术债务会使开发变慢并最终导致产品更糟，问题更多。</p>\n<p>感谢 Ansible 团队，尤其是 Wayne Witzel，为改善这个列表中的准则而提出的意见和建议。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111586\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111586votetotal\">3</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111586\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 6 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n	\r\n	<h3 class=\"widget-title\">\r\n	关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/maifansnet\">maifans</a>\r\n	</h3>\r\n	<div class=\"alignleft\">\r\n		<a target=\"_blank\" href=\"http://www.jobbole.com/members/maifansnet\">\r\n			<img src=\"http://jbcdn2.b0.upaiyun.com/2015/04/8fbdaaa5ea6d3b49c8c1c825aafeb5d9.png\">\r\n		</a>\r\n	</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            软件工程师，关注人工智能，关注医疗器械。        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/maifansnet\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/maifansnet/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/maifansnet/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 13</a>        </span>\r\n    </div>\r\n	<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n	</div>');
INSERT INTO `jobbole_article` VALUES ('性能优化知多少', '2017-07-08', 'http://blog.jobbole.com/111734/', 'a59acd84141cd48da7828b24421ff6cb', 'http://jbcdn2.b0.upaiyun.com/2017/07/7e8f770aaadb755d790b921b68fb2214.png', 'full/5b48951660a3dd574009dd9dfb69981fce68b26a.jpg', '0', '3', '2', 'IT技术,性能', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/sheng-jie/p/7109385.html\">『圣杰』</a>   </div><p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/7e8f770aaadb755d790b921b68fb2214.png\"></p>\n<div id=\"cnblogs_post_body\">\n<h1 id=\"引言\">1. 引言</h1>\n<p>最近一段时间，系统新版本要发布，在beta客户测试期间，暴露了很多问题，除了一些业务和异常问题外，其他都集中在性能上。有幸接触到这些性能调优的机会，当然要学习总结了。</p>\n<p>性能优化是一个老生常谈的问题了，典型的性能问题如页面响应慢、接口超时，服务器负载高、并发数低，数据库频繁死锁等。而造成性能问题又有很多种，比如磁盘I/O、内存、网络、算法、大数据量等等。我们可以大致把性能问题分为四个层次：代码层次、数据库层次、算法层次、架构层次。<br>\n所以下面我会结合实际性能优化案例，和大家分享下性能调优的工具、方法和技巧。</p>\n<h1 id=\"先说心态\">2. 先说心态</h1>\n<p>说到性能问题，你可能首先就想到的是麻烦或者头大，因为一般性能问题都比较紧急，轻则影响客户体验，重则宕机导致财务损失，而且性能问题比较隐蔽，不易发现。因此一时间无从下手，而这时我们就很容易从心底开始去排斥它，不愿接这烫手的山芋。</p>\n<p>而恰巧，性能调优是体现程序员水平的一个重要指标。</p>\n<blockquote><p>因为处理bug、崩溃、调优、入侵等突发事件比编程本身更能体现平庸程序员与理想程序员的差距。当面对一个未知的问题时，如何定位复杂条件下的核心问题、如何抽丝剥茧地分析问题的潜在原因、如何排除干扰还原一个最小的可验证场景、如何抓住关键数据验证自己的猜测与实验，都是体现程序员思考力的最好场景。是的，在衡量理想程序员的标准上，思考力比经验更加重要。</p></blockquote>\n<p>所以，若你不甘平庸，请拥抱性能调优的每一个机会。当你拥有一个正确的心态，你所面对的性能问题就已经解决了一半。</p>\n<h1 id=\"再说技巧\">3. 再说技巧</h1>\n<p>拿到一个性能问题，不要忙着先上工具，先了解问题出现的背景，问题的严重程度。然后大致根据自己的经验积累作出预估。比如客户来了个性能问题说系统宕机了，已经造成资金损失了。这种涉及到钱的问题，大家都比较敏感，根据自己的level，决定是否要接这个锅。这不是逃避，而是自知之明。</p>\n<p>了解问题背景之后，下一步就来尝试问题重现。如果在测试环境能够重现，那这种问题就很好跟踪分析。如果问题不能稳定重现或仅能在生产环境重现，那问题就相对比较棘手，这时要立刻收集现场证据，包括但不限于抓dump、收集应用程序以及系统日志、关注CPU内存情况、数据库备份等等，之后不妨再尝试重现，比如恢复客户数据库到测试环境重现。</p>\n<p>不管问题能否重现，下一步，我们就要大致对问题进行分类，是代码层次的业务逻辑问题还是数据库层次的操作耗时问题，又或是系统架构的吞吐量问题。那如何确定呢？而我倾向于先从数据库动手。我的习惯做法是，使用数据库监控工具，先跟踪下Sql耗时情况。如果监控到耗时较长的SQL语句，那基本上就是数据库层次的问题，否则就是代码层次。若为代码层次，再研究完代码后，再细化为算法或架构层次问题。</p>\n<p>确定问题种类后，是时候上工具来精准定位问题点了：</p>\n<ul>\n<li>Sql耗时问题，推荐使用免费的<a href=\"https://www.sentryone.com/plan-explorer\">Plan Explorer</a>分析执行计划。</li>\n<li>代码问题定位，优先推荐使用VS自带的Performance Analysis，其次是RedGate的性能分析套件<a href=\"http://www.red-gate.com/products/dotnet-development/dotnet-developer-bundle/\">.NET Developer Bundle</a>；然后还有Jet Brains的<a href=\"http://www.jetbrains.com/profiler/?fromMenu\">dotTrace — .NET performance profiler</a>，<a href=\"http://www.jetbrains.com/dotmemory/?fromMenu\">dotMemory– .NET memory profiler</a>；再然后就是反人类的Windbg；等等。</li>\n</ul>\n<p>精准定位问题点后，就是着手优化了。相信到这一步，就是优化策略的选择了，这里就不展开了。</p>\n<p>优化后，最后当然要进行测试了，毕竟优化了多少，我们也要做到心里有谱才行。</p>\n<p>以上啰啰嗦嗦有点多，下面我们直接上案例。</p>\n<h1 id=\"案例分享\">4. 案例分享</h1>\n<p>下面就分享下我针对代码层面、数据库层面和算法层面的优化案例。</p>\n<h1 id=\"sql优化案例\">4.1. SQL优化案例</h1>\n<blockquote><p>案例1：客户反馈某结算报表统计十天内的数据耗时10mins左右。</p></blockquote>\n<p>由于前几天刚学会用RedGate的分析工具，拿到这个问题，本地尝试重现后，就直接想使用工具分析。然而，这工具在使用webdev模式起站点时，总是报错，而当时时一根筋，老是想解决这个工具的报错问题。结果，白白搞了半天也没搞定。最后不得已放弃工具，转而选择使用sql server profiler去监控sql语句耗时。一跟踪不要紧，问题就直接暴露了，整个全屏的重复sql语句，如下图。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/06c352459b736d66075fe293d43e97f3.png\" alt=\"Sql Profiler监控结果\"></p>\n<p>这下问题就很明显了，八成是代码在循环拼接sql执行语句。根据抓取到sql关键字往代码中去搜索，果然如此。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59605f1077606800738307\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#region更新三张表数据结合的中间临时表数据，有上游单据的直接调拨单分多次下推时，只计算一次的调拨数量和价税合计\r\nstring sSql = string.Format(@\r\n\"SELECT FENTRYID FROM {0} GROUP BY FENTRYID HAVING COUNT(FENTRYID) &gt; 1\", sJoinDataTempTable);\r\nusing(IDataReader reader = DBUtils.ExecuteReader(this.Context, sSql)) {\r\n    while (reader.Read()) {\r\n        sbSql.AppendFormat(@\"\r\nUPDATE {0} SET FDIRECTQTY = 0,FALLAMOUNT = 0 \r\nWHERE FSEQ NOT IN (\r\nSELECT TOP 1 FSEQ FROM {0} WHERE FENTRYID = {1}) AND FENTRYID = ({1});\"\r\n, sJoinDataTempTable, Convert.ToInt32(reader[\"FENTRYID\"]));\r\n        listSqlObj.Add(new SqlObject(sbSql.ToString(), new List &lt; SqlParam &gt; ()));\r\n        sbSql.Clear();\r\n    }\r\n}\r\n#endregion</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59605f1077606800738307-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077606800738307-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077606800738307-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077606800738307-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077606800738307-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077606800738307-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077606800738307-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077606800738307-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077606800738307-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077606800738307-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077606800738307-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077606800738307-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077606800738307-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077606800738307-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077606800738307-15\">15</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59605f1077606800738307-1\"><span class=\"crayon-p\">#region更新三张表数据结合的中间临时表数据，有上游单据的直接调拨单分多次下推时，只计算一次的调拨数量和价税合计</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077606800738307-2\"><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sSql</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Format</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">@</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077606800738307-3\"><span class=\"crayon-s\">\"SELECT FENTRYID FROM {0} GROUP BY FENTRYID HAVING COUNT(FENTRYID) &gt; 1\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sJoinDataTempTable</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077606800738307-4\"><span class=\"crayon-e\">using</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">IDataReader </span><span class=\"crayon-v\">reader</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">DBUtils</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ExecuteReader</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Context</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sSql</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077606800738307-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">reader</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Read</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077606800738307-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">sbSql</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AppendFormat</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">@</span><span class=\"crayon-s\">\"</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077606800738307-7\"><span class=\"crayon-s\">UPDATE {0} SET FDIRECTQTY = 0,FALLAMOUNT = 0 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077606800738307-8\"><span class=\"crayon-s\">WHERE FSEQ NOT IN (</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077606800738307-9\"><span class=\"crayon-s\">SELECT TOP 1 FSEQ FROM {0} WHERE FENTRYID = {1}) AND FENTRYID = ({1});\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077606800738307-10\"><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sJoinDataTempTable</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Convert</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToInt32</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">reader</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">\"FENTRYID\"</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077606800738307-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">listSqlObj</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Add</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SqlObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sbSql</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">List</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SqlParam</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077606800738307-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">sbSql</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Clear</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077606800738307-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077606800738307-14\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077606800738307-15\"><span class=\"crayon-p\">#endregion</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0028 seconds] -->\r\n<p>看到这段代码，咱先不评判这段代码的优劣，因为毕竟代码注释清晰，省了我们理清业务的功夫。这段sql主要是想做去重处理，很显然选用了错误的方案。改后代码如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59605f1077619312887774\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstring sqlMerge = string.Format(@\"\r\nmerge into {0} t1\r\nusing(\r\nselect min(Fseq) fseq,Fentryid from {0} t2 group by fentryid\r\n) t3 on (t1.fentryid = t3.fentryid and t1.fseq &lt;&gt; t3.fseq)\r\nwhen matched then\r\nupdate set t1.FDIRECTQTY = 0, t1.FALLAMOUNT = 0\r\n\", sJoinDataTempTable);\r\n\r\nlistSqlObj.Add(new SqlObject(sqlMerge, new List &lt; SqlParam &gt; ()));\r\nsbSql.Clear();</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59605f1077619312887774-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077619312887774-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077619312887774-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077619312887774-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077619312887774-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077619312887774-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077619312887774-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077619312887774-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077619312887774-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077619312887774-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077619312887774-11\">11</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59605f1077619312887774-1\"><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sqlMerge</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Format</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">@</span><span class=\"crayon-s\">\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077619312887774-2\"><span class=\"crayon-s\">merge into {0} t1</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077619312887774-3\"><span class=\"crayon-s\">using(</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077619312887774-4\"><span class=\"crayon-s\">select min(Fseq) fseq,Fentryid from {0} t2 group by fentryid</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077619312887774-5\"><span class=\"crayon-s\">) t3 on (t1.fentryid = t3.fentryid and t1.fseq &lt;&gt; t3.fseq)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077619312887774-6\"><span class=\"crayon-s\">when matched then</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077619312887774-7\"><span class=\"crayon-s\">update set t1.FDIRECTQTY = 0, t1.FALLAMOUNT = 0</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077619312887774-8\"><span class=\"crayon-s\">\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sJoinDataTempTable</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077619312887774-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077619312887774-10\"><span class=\"crayon-v\">listSqlObj</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Add</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SqlObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sqlMerge</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">List</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SqlParam</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077619312887774-11\"><span class=\"crayon-v\">sbSql</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Clear</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0013 seconds] -->\r\n<p>改后测试相同数据量，耗时由10mins降到10s左右。</p>\n<h1 id=\"代码优化案例\">4.2. 代码优化案例</h1>\n<blockquote><p>案例2：客户反馈销售订单100条分录行，保存进行可发量校验时，耗时7mins左右。</p></blockquote>\n<p>拿到这个问题后，本地重现后，监控sql耗时没有异常，那就着重分析代码了。因为可发量校验的业务逻辑极其复杂，又加上又直接再一个类文件实现该功能，3500+行的代码，加上零星注释，真是让人避之不及。逃避不是办法，还是上工具分析一把。<br>\n这次我选用的时VS自带的<strong><a href=\"https://msdn.microsoft.com/en-us/library/ms182372.aspx\">Performance Profiler</a></strong>，开发环境下极其强大的性能调优工具。针对我们当前案例，我们仅需要跟踪指定服务对应的dll即可，使用步骤如下：</p>\n<ol>\n<li>Analyze–&gt;Profiler–&gt;New Performance Session</li>\n<li>打开Performance Explorer</li>\n<li>找到新添加的Performance Session，右键Targets，然后选择Add Target Binary，添加要跟踪的dll文件即可</li>\n<li>将应用跑起来</li>\n<li>选中Performance Session，右键Attach对应进程即可跟踪分析性能了</li>\n<li>在跟踪过程中，可随时暂停跟踪和停止跟踪</li>\n</ol>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/864dcb9eca7c345f430a8da89eac5fd1.png\" alt=\"图示步骤\"></p>\n<p>跟踪结束后本案例跟踪到的采样结果如下图：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9647efb1b254108019ea972563dc630f.png\" alt=\"VS Performance Profiler分析报告\"></p>\n<p>同时Performance Profiler也给出了问题的建议，如下图：<br>\n<img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/88c42b11fa5d0dd0e4471c3d0bccaf10.png\" alt=\"VS Performance Profiler分析提示\"></p>\n<p>其中第1、4条大致说明程序I/O消耗大，第一代的GC上存在未及时释放的垃圾占比过高。而根据上图的采样结果，我们可以直接看出是由于再代码中频繁操作DataTable引起的性能瓶颈。走读代码发现的确如此，所有的数量统计都是在代码中循环遍历DataTable进行处理的。而最终的优化策略，就相当于一次大的重构，将所有代码中通过遍历DataTable的计算逻辑全部挪到SQL中去做。由于代码过多，就不再放出。</p>\n<blockquote><p>案例3：客户反馈批量引入1000张订单，耗时40mins左右，且容易中断。</p></blockquote>\n<p>同样，我们还是先尝试本地重写。经测试批量引入101张单据，就耗时5mins左右。下一步打开Sql监控工具也未发现耗时语句。但考虑到是批量导入操作，虽然单个耗时不多，但乘以100这个基数，就明显了。下面我们就使用RedGate的<a href=\"http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/\">Ants Performance Profiler</a>跟踪一下。</p>\n<p>该工具比较直观，可以同时监控代码和SQL执行情况。第一步，New Profiler Session，第二步进行设置，如下图。根据自己的应用程序类别，选择相应的跟踪方式。</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/12d765271a5c2637c6242b6a4df95256.png\" alt=\"跟踪设置\"></p>\n<p>针对这个问题，我们跟踪到的调用堆栈和SQL耗时结果如下图：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9610679af9557a4ae695b8b1c675c787.png\" alt=\"调用堆栈监控结果\"></p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/754712efddfa3eb40a7eb32b192db06c.png\" alt=\"SQL监控结果\"></p>\n<p>首先从调用堆栈中的Hit Count，我们可以首先看出它是一个批量过程，因为入口函数仅调用一次；第二个我们可以代码中是循环处理每一个单据，因为Hit Count与我们批量引入的单据数量相符；第三个，突然来了个10201，如果有一定的数字敏感性的话，这次性能问题的原因就被你找到了。这里就不卖关子了，101 x 101 = 10201。<br>\n是不是明白了什么，存在循环嵌套循环的情况。我们走读代码确定一下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59605f1077620239276223\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n//Save.cs\r\npublic override void EndOperationTransaction(EndOperationTransactionArgs e) {\r\n    //省略其他代码\r\n    foreach(DynamicObject dyItem in e.DataEntitys) {\r\n        //反写收款单\r\n        WriteBackReceiveBill wb = new WriteBackReceiveBill();\r\n        wb.WriteBackForSave(e, this.Context);\r\n    }\r\n}\r\n\r\n//WriteBackReceiveBill .cs\r\npublic void WriteBackForSave(EndOperationTransactionArgs e, Context contx) {\r\n    //省略其他代码：\r\n    foreach(DynamicObject item in e.DataEntitys) {\r\n        //do something \r\n    }\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59605f1077620239276223-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077620239276223-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077620239276223-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077620239276223-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077620239276223-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077620239276223-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077620239276223-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077620239276223-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077620239276223-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077620239276223-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077620239276223-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077620239276223-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077620239276223-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077620239276223-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077620239276223-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59605f1077620239276223-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-59605f1077620239276223-17\">17</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59605f1077620239276223-1\"><span class=\"crayon-c\">//Save.cs</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077620239276223-2\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">override </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">EndOperationTransaction</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">EndOperationTransactionArgs</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077620239276223-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">//省略其他代码</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077620239276223-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">foreach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">DynamicObject </span><span class=\"crayon-e\">dyItem </span><span class=\"crayon-st\">in</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">DataEntitys</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077620239276223-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">//反写收款单</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077620239276223-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">WriteBackReceiveBill </span><span class=\"crayon-v\">wb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WriteBackReceiveBill</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077620239276223-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">wb</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteBackForSave</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Context</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077620239276223-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077620239276223-9\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077620239276223-10\"> </div><div class=\"crayon-line\" id=\"crayon-59605f1077620239276223-11\"><span class=\"crayon-c\">//WriteBackReceiveBill .cs</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077620239276223-12\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WriteBackForSave</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">EndOperationTransactionArgs</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Context </span><span class=\"crayon-v\">contx</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077620239276223-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">//省略其他代码：</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077620239276223-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">foreach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">DynamicObject </span><span class=\"crayon-e\">item </span><span class=\"crayon-st\">in</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">DataEntitys</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077620239276223-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">//do something </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59605f1077620239276223-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59605f1077620239276223-17\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0023 seconds] -->\r\n<p>好嘛，外层套了一个空循环却什么也没做。修改就很简单了，删除无效外层循环即可。</p>\n<h1 id=\"算法优化案例\">4.3. 算法优化案例</h1>\n<blockquote><p>案例4：某全流程跟踪报表超时。</p></blockquote>\n<p>这个报表是用来跟踪所有单据从下单到出库的业务流程数据流转情况。而所有的流程数据都是按照树形结果存储在数据库表中的，类似这样：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/1a5f6eb8189dc0b3c9fa092e00488f2e.png\" alt=\"流程树表\"></p>\n<p>图中的流程为：<br>\n销售合同–&gt;销售订单–&gt;发货通知单–&gt;销售出库单</p>\n<p>为了构造流程图，之前的处理方法是把流程数据取回来，通过代码构造流程图。这也就是性能差的原因。</p>\n<p>而针对这种情况，就是考验我们平时经验积累了。对于树形结构的表，我们也是可以通过SQL来进行直接查询的，这就要用到了SQL Server的CTE语法来进行递归查询。关于递归查询，可参考我这篇文章：<a href=\"http://www.jianshu.com/p/ab9d268aa54c\">SQL递归查询知多少</a>。这里就不展开了。</p>\n<h1 id=\"总结\">5.总结</h1>\n<p>性能调优是一个循序渐进的过程，不可能一蹴而就，重在平时的点滴积累。关于工具的选择和使用，本文并未展开，也希望读者也不要纠结与此。当你真正想解决一个问题的时候，相信工具的使用是难不住你的。</p>\n<p>最后就大致总结下我的调优思路：</p>\n<ol>\n<li>调整心态，积极应对</li>\n<li>了解性能背景， 收集证据， 尝试重现</li>\n<li>问题分类，先监控SQL耗时，大致确定是SQL或是代码层次原因</li>\n<li>使用性能分析工具，确定问题点</li>\n<li>调优测试</li>\n</ol>\n</div>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111734\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111734votetotal\">2</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111734\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 3 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>');
INSERT INTO `jobbole_article` VALUES ('程序员偷偷自动化，每周才工作几小时却拿全薪，这样道德么？', '2017-07-08', 'http://blog.jobbole.com/111742/', 'da181fa9746cff2a3a3ca3f1b082c055', 'http://ww2.sinaimg.cn/mw690/63918611gw1f5idukigfrj20fw07yt9o.jpg', 'full/55b1132af682daa4944e35728414d9d865d4670f.jpg', '4', '2', '5', '职场,,程序员,自动化', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/liuchang\">刘唱</a> 翻译，<a href=\"http://www.jobbole.com/members/huanglimin\">黄利民</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"http://www.sciencealert.com/programmers-are-secretly-automating-their-jobs-and-only-working-a-few-hours-a-week\">Julie Bort</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>就在上周，程序员们在 StackExchange 上有<a href=\"https://workplace.stackexchange.com/questions/93696/is-it-unethical-for-me-to-not-tell-my-employer-i-ve-automated-my-job/94099#94099\" target=\"_blank\">激烈的讨论</a>，如果偷偷把自己的工作自动化，是不是不道德？</p>\n<p><img class=\"alignnone\" src=\"http://ww2.sinaimg.cn/mw690/63918611gw1f5idukigfrj20fw07yt9o.jpg\" width=\"572\" height=\"286\"></p>\n<p>这次讨论的源于 Etherable 于 6 月 27 日在 StackExchange 上发的一个帖子，全文翻译如下：</p>\n<blockquote><p>我目前在给一家公司的遗留系统工作。这个系统真的是很老了，尽管我的角色是程序员，但我大部分工作却是美化数据。总结一下，我有一堆需求，实际上是每月电子表格中的大量数据，我必须把系统配置好，保证运行。这工作基本就是编写一大堆的 SQL 脚本。</p>\n<p>不过这并不是一份很简单的活，因为最初开发这个系统的人写反了。实际上，创建电子表单的分析师要花很多时间来验证我的工作。原因是我这活太繁杂，易出错。</p>\n<p>正如你猜到的，这活非常枯燥。然而，这份全职工作薪水可观，并且允许远程，我还可以陪儿子。</p>\n<p>这份工作我做到大概 18 个月的时候，我基本摸清了所有套路，然后我编写了一个自动化程序，并且我过去 6 个月的活，都是交给它了。所以，过去要 1 人做 1 个月的事，现在可能 10 分钟就可以了。</p>\n<p>现在的问题是，我是否应该告诉公司？如果我告诉他们了，他们或许采纳自动化程序，然后不要我了。这并不像是一个有着大量 IT 工作的公司，他们是有一个遗留系统，一直来保存所有的客户数据，他们只是需要有人来维护这个系统。</p>\n<p>同时，我也觉得自己做的不对。我的意思是，现在只要我拿到了（公司下发的）规范（spec），然后大约每周运行一次自动化程序。再上报我做完了一部分工作，让他们测试验证。我甚至插入了一些 Bugs，以便让结果看起来更像是人做出来的。</p>\n<p>虽然有时候规范需要修改，加上邮件来回沟通的时间，我每周的实际工作时间约 1-2 小时，但我拿的却是全薪。</p>\n<p>虽然我真的很享受多出来的自由时间，但如果这样不打招呼，继续这样偷偷地做下去，是不是不道德？ 这不比我在欺骗公司。公司从来没有表示他们对我的表现不满意，事实上，他们从雇用我中得到了他们想要的。</p></blockquote>\n<p>这位程序员（Etherable）说，他写了一些脚本，悄悄把原本一周的工作用不到两个小时就做完了，他开始感到有些愧疚了。</p>\n<p>公司雇他做的工作都完成了，但是由于是远程工作，也没告诉他老板脚本的事，因此他基本上整天都在陪儿子。他担心公司发现这些脚本然后解雇他，并非是出于道德原因，而是公司有了脚本以后就不再需要他了。</p>\n<p>他写道：</p>\n<blockquote><p>“不告诉我老板自动化工作的事，不道德吗？……</p>\n<p>你能想象，这大概是世界上最无聊的工作了。但是这也是一份薪水颇丰的全职工作，而且我可以远程工作，在家里陪我的儿子。</p>\n<p>所以我已经做了 18 个月了，在这期间，我差不多发现了所有的套路，在过去的六个月里写了一个程序来帮我完成全部工作。以前别人需要用一个月的时间来清理电子表格，用这个程序大概十分钟就能完成。</p>\n<p>现在的问题是，我要不要告诉他们？如果我说了，他们大概会拿走我的程序然后解雇我。”</p></blockquote>\n<p>还有一件事是：这位程序员也坦白，他会通过故意加一些错误来掩盖自动化的痕迹，“让它看起来像是人工完成的。”</p>\n<p>这个问题也发在了<a href=\"https://news.ycombinator.com/item?id=14656945\"> Hacker News</a> 上，引起了激烈的讨论。</p>\n<p>有趣的是，在参与评论的这几十个程序员中，人们分成了两大阵营：<strong>该行为道德和不道德</strong>。</p>\n<h3>你这不道德</h3>\n<p>Stack Overflow 上的人普遍倾向于这种情况不道德。一个叫 <a href=\"https://workplace.stackexchange.com/questions/93696/is-it-unethical-for-me-to-not-tell-my-employer-i-ve-automated-my-job#comment279618_93700\">Magisch</a> 的用户甚至说这位程序员在“诈骗你的老板”。</p>\n<p><a href=\"https://workplace.stackexchange.com/a/93704\">Joe Strazzere</a> 很好地总结了这一派的观点：</p>\n<ul>\n<li><strong>你用每周 1-2 个小时在家里工作（陪儿子），但是却拿着 40 个小时的工资</strong></li>\n<li><strong>你 6 个月前写的这个程序，但是到现在都没告知你的老板</strong></li>\n<li><strong>几乎每周你都在对你的工作成果撒谎</strong></li>\n<li><strong>你故意在程序里插入错误来挽救你的骗局</strong></li>\n<li><strong>你还要让创建表格的分析师花费相当多的时间来检查你的工作</strong></li>\n<li><strong>你承认“感觉自己做了错事”</strong></li>\n</ul>\n<blockquote><p>即使答案在我看来已经很明显了，但是你个人的道德标准让你得出了这样并没什么问题的结论。尽管我怀疑你知道真相……”</p></blockquote>\n<p>另一个<a href=\"https://workplace.stackexchange.com/a/94099\">程序员 SSight3</a> 承认他曾经也自动化做过类似的工作，但是他说自己不属于不道德的原因是，他告诉了他的老板：</p>\n<blockquote><p>“我的情况是，我本来是要做半年的无脑输入数据的工作，但是我自动化了这个过程并且把方法公开给了我的老板。我现在被分配到一个更适合我的天赋和能力的部门。”</p></blockquote>\n<p>他说这个自动化的工作最终使他免于部门的后期裁员。</p>\n<p>大多数站在认为此行为不道德的阵营的人坚信，即使他不能承认已经用这个脚本多久，以及他的工作时间有多短，他仍有义务告诉他的老板关于脚本的事。</p>\n<h3>错误的动机</h3>\n<p>但是 Hacker News 的朋友们提出了另一种观点。</p>\n<p>很多人认为，<strong>只要公司拿到了他们花钱想要的结果，那这个人用多少时间去完成都无所谓</strong>。尽管这个阵营的人也同意，故意制造一些 bug 确实是错的。</p>\n<p><a href=\"https://news.ycombinator.com/user?id=barrkel\">其中一个人写道</a>：“我不认为这里有什么道德问题，只有交易关系——支付工资，创造价值。如果公司用另一种方法能花更少的钱达到目的，它就会采用这种方法并解雇员工。这种事可以避免吗？这位员工正在为公司创造价值，他正在守护自己（和公司）讨价还价的底线，毕竟公司一直都在剥削员工。”</p>\n<p>另一位程序员表示他在做网页的时候也有<a href=\"https://news.ycombinator.com/item?id=14657663\">相似的境遇</a>，而且受到了负面的影响：</p>\n<blockquote><p>“他们想按小时付费给我，但是我协商要按页数付费。当然了，我是自动化完成工作的。但出乎我意料的是，即使他们花同样的钱得到了同样的结果，我们也明确地达成协议不按时间付费，而是按产量付费，他们还是很讨厌我写程序自动化工作。”</p></blockquote>\n<p>有人<a href=\"https://news.ycombinator.com/item?id=14657672\">指出</a>，在整个 IT 行业，自动化不是特例，而是规则。拿系统管理这个工作来说，这项工作是确保 IT 系统不出故障。“我知道很多系统管理员自动化完成大多数工作，他们自己只是做一些监控和维护，他们很棒，没人因为这件事儿指责他们，事实上，这是很好的实践。”</p>\n<p>另一个人<a href=\"https://news.ycombinator.com/item?id=14659048\">表示同意</a>。“作为一个系统管理员，我工作的 90% 都是自动化完成的。如果出了问题，我会一周七天 24 小时随叫随到，但是工作中的其他时间，我可以做做杂事，看看电影，玩玩游戏。我所知道的每个系统管理员，几乎都是这样的。”</p>\n<p>一个人说他<a href=\"https://news.ycombinator.com/item?id=14658785\">整个职业生涯</a>中都是自动化工作的，从没隐瞒过：</p>\n<blockquote><p>“五年前，我在一家大公司做着一份入门级的夜班。那六个月里，我几乎用脚本完成了所有工作，大部分时间都在看 Netflix，我也没花什么心思去隐瞒我没事做这件事。</p>\n<p>为此公司奖励我一次升职，然后我做了同样的事（自动化工作）并且又升职了两次。我现在的产出是从前的两倍多，我的职责是告诉别人如何自动化工作。”</p></blockquote>\n<p>一位程序员完美<a href=\"https://news.ycombinator.com/item?id=14662152\">总结</a>了 Hacker News 上的观点：</p>\n<blockquote><p>“他（发帖求助的程序员 Etherable）唯一的错误就是，没能充分利用他的才能和潜在的生产力。对此最好的解决办法，就是找一份更好的工作。”</p></blockquote>\n<p>技术人员对自动化工作并不陌生。2015 年，曾经有过这样一个程序员，他离开公司后才被发现自动化到了这样的程度：甚至连用咖啡机煮一杯拿铁都要自动化。详情请看《<strong><a href=\"http://blog.jobbole.com/95222/\" target=\"_blank\">超过 90 秒的任务不自动化，你好意思说自己是黑客？</a></strong>》</p>\n<p>有趣的是，编程对于需要长时间且难以忍受的工作来说是小有名气的。许多技术人员都这样工作。</p>\n<p>但显然也出现了这样的亚文化：一些人在做相反的事情，创造一些没有他们就进行不下去的工作。</p>\n\r\n        \r\n            <blockquote class=\"rewards\">\n        <p><strong>打赏支持我翻译更多好文章，谢谢！</strong></p>\n        <a href=\"#rewardbox\" id=\"rewards-button\" class=\"fancybox\"><span class=\"btn-bluet-blue href-style\"><i class=\"fa fa-jpy\"></i> 打赏译者</span></a>\n    </blockquote>\n\n    <div id=\"rewardbox\">\n        <h4>打赏支持我翻译更多好文章，谢谢！</h4>\n                <p>\n                        <img src=\"http://jbcdn2.b0.upaiyun.com/2016/07/acb658caeaa7401d5d7d20f28a1eab52.png\">\n            \n                    </p>\n    </div>\n\n    \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111742\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111742votetotal\">5</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111742\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 2 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 4 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n	\r\n	<h3 class=\"widget-title\">\r\n	关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/liuchang\">刘唱</a>\r\n	</h3>\r\n	<div class=\"alignleft\">\r\n		<a target=\"_blank\" href=\"http://www.jobbole.com/members/liuchang\">\r\n			<img src=\"http://jbcdn2.b0.upaiyun.com/2016/06/5f17a18404975a50e3a341f2f8e27d59.jpg\">\r\n		</a>\r\n	</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            数据挖掘研究生        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/liuchang\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/liuchang/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/liuchang/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 37</a> · <a title=\"我的网站\" target=\"_blank\" href=\"http://blog.csdn.net/github_36299736\"><i class=\"fa fa-link\"></i></a> <a title=\"微博主页\" target=\"_blank\" href=\"http://weibo.com/2577872237\"><i class=\"fa fa-weibo\"></i></a> <a title=\"个人微信：learningDM\" target=\"_blank\" href=\"#\"><i class=\"fa fa-weixin\"></i></a>         </span>\r\n    </div>\r\n	<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n	</div>');
INSERT INTO `jobbole_article` VALUES ('浅析 Linux 的共享内存与 tmpfs 文件系统', '2017-07-08', 'http://blog.jobbole.com/111665/', 'e04a2d4d18843ec489eef7404d5f0e1c', 'http://jbcdn2.b0.upaiyun.com/2016/11/59d49abe8909a122bc2c9aa43b71e3bb.png', 'full/d3d1a5ad957de059084690efae6fdfaa3527e1c3.jpg', '0', '0', '1', 'IT技术,Linux', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://blog.chinaunix.net/uid-28541347-id-5763124.html\">lvyilong316</a>   </div><h2><b>前言</b><b></b></h2>\n<p>共享内存主要用于进程间通信，Linux有两种共享内存(Shared Memory)机制：</p>\n<p>(1) ** System V shared memory(shmget/shmat/shmdt) **</p>\n<p>Original shared memory mechanism, still widely used Sharing between unrelated processes.</p>\n<p>(2) ** POSIX shared memory(shm_open/shm_unlink) **</p>\n<p>Sharing between unrelated processes, without overhead of filesystem I/O Intended to be simpler and better than older APIs.</p>\n<p>另外，在Linux中不得不提一下内存映射（也可用于进程间通信）：</p>\n<p>** Shared mappings – mmap(2) **</p>\n<p>l Shared anonymous mappings：Sharing between related processes only (related via fork())</p>\n<p>l Shared file mappings：Sharing between unrelated processes, backed by file in filesystem</p>\n<p>System V共享内存历史悠久，使用也很广范，很多类Unix系统都支持。一般来说，我们在写程序时也通常使用第一种。这里不再讨论如何使用它们，关于POSIX共享内存的详细介绍可以参考<a href=\"http://man7.org/linux/man-pages/man7/shm_overview.7.html\">这里1</a>,<a href=\"http://man7.org/training/download/posix_shm_slides.pdf\">这里2</a>。</p>\n<p>** 讲到那么多，那么问题来了，共享内存与tmpfs有什么关系？ **</p>\n<p align=\"justify\">The POSIX shared memory object implementation on Linux 2.4 makes use of a dedicated filesystem, which is normally mounted under /dev/shm.</p>\n<p>    从这里可以看到，POSIX共享内存是基于tmpfs来实现的。实际上，更进一步，不仅PSM(POSIX shared memory)，而且SSM(System V shared memory)在内核也是基于tmpfs实现的。</p>\n<h2><b>tmpfs介绍</b><b></b></h2>\n<p>下面是内核文档中关于tmpfs的介绍：</p>\n<p align=\"justify\">tmpfs has the following uses:</p>\n<p align=\"justify\">1) There is always a kernel internal mount which you will not see at all. This is used for shared anonymous mappings and SYSV shared memory.</p>\n<p align=\"justify\">This mount does not depend on CONFIG_TMPFS. If CONFIG_TMPFS is not set, the user visible part of tmpfs is not build. But the internal mechanisms are always present.</p>\n<p align=\"justify\">2) glibc 2.2 and above expects tmpfs to be mounted at /dev/shm for POSIX shared memory (shm_open, shm_unlink). Adding the following line to /etc/fstab should take care of this:</p>\n<p align=\"justify\">tmpfs /dev/shm tmpfs defaults 0 0</p>\n<p align=\"justify\">Remember to create the directory that you intend to mount tmpfs on if necessary.</p>\n<p align=\"justify\">This mount is not needed for SYSV shared memory. The internal mount is used for that. (In the 2.3 kernel versions it was necessary to mount the predecessor of tmpfs (shm fs) to use SYSV shared memory)</p>\n<p>从这里可以看到tmpfs主要有两个作用：</p>\n<p><b>    </b><b>（1）用于SYSV共享内存，还有匿名内存映射；这部分由内核管理，用户不可见；</b><b></b></p>\n<p><b>    </b><b>（2）用于POSIX共享内存，由用户负责mount，而且一般mount到/dev/shm；依赖于CONFIG_TMPFS;</b><b></b></p>\n<p>到这里，我们可以了解，SSM与PSM之间的区别，也明白了/dev/shm的作用。</p>\n<p>下面我们来做一些测试：</p>\n<h2><b>测试</b><b></b></h2>\n<p>我们将/dev/shm的tmpfs设置为64M：</p>\n<p><i># mount -size=64M -o remount /dev/shm# df -lh</i></p>\n<p>Filesystem                  Size  Used Avail Use% Mounted on</p>\n<p>tmpfs                          64M     0   64M   0% /dev/shm</p>\n<p>SYSV共享内存的最大大小为32M：</p>\n<p><i># cat /proc/sys/kernel/shmmax</i></p>\n<p>33554432</p>\n<h3><b>(1)创建65M的system V共享内存失败：</b><b></b></h3>\n<p><i># ipcmk -M 68157440                   </i></p>\n<p>ipcmk: create share memory failed: Invalid argument</p>\n<p>这是正常的。</p>\n<h3><b>(2)将shmmax调整为65M</b><b></b></h3>\n<p><i># echo 68157440 &gt; /proc/sys/kernel/shmmax# cat /proc/sys/kernel/shmmax             </i></p>\n<p>68157440<i># ipcmk -M 68157440                       </i></p>\n<p>Shared memory id: 0<i># ipcs -m</i></p>\n<p>—— Shared Memory Segments ——–</p>\n<p>key        shmid      owner      perms      bytes      nattch     status</p>\n<p>0xef46b249 0          root       644        68157440   0</p>\n<p>可以看到system v共享内存的大小并不受/dev/shm的影响。</p>\n<h3><b>(3)创建POSIX共享内存</b></h3>\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59600667b00e3807568408\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n/*gcc -o shmopen shmopen.c -lrt*/#include &lt;unistd.h&gt;\r\n#include &lt;fcntl.h&gt;\r\n#include &lt;sys/stat.h&gt;\r\n#include &lt;sys/types.h&gt;\r\n#include &lt;sys/mman.h&gt;\r\n#include &lt;stdio.h&gt;\r\n#include &lt;stdlib.h&gt;\r\n#define MAP_SIZE 68157440\r\nint main(int argc, char *argv[])\r\n{\r\n    int fd;\r\n    void* result;\r\n    fd = shm_open(\"/shm1\", O_RDWR|O_CREAT, 0644);\r\n    if(fd &lt; 0){\r\n        printf(\"shm_open failed\\n\");\r\n        exit(1);\r\n    }\r\n    return 0;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59600667b00e3807568408-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00e3807568408-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00e3807568408-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00e3807568408-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00e3807568408-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00e3807568408-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00e3807568408-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00e3807568408-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00e3807568408-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00e3807568408-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00e3807568408-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00e3807568408-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00e3807568408-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00e3807568408-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00e3807568408-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00e3807568408-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00e3807568408-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00e3807568408-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00e3807568408-19\">19</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59600667b00e3807568408-1\"><span class=\"crayon-c\">/*gcc -o shmopen shmopen.c -lrt*/</span><span class=\"crayon-p\">#include &lt;unistd.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00e3807568408-2\"><span class=\"crayon-p\">#include &lt;fcntl.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00e3807568408-3\"><span class=\"crayon-p\">#include &lt;sys/stat.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00e3807568408-4\"><span class=\"crayon-p\">#include &lt;sys/types.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00e3807568408-5\"><span class=\"crayon-p\">#include &lt;sys/mman.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00e3807568408-6\"><span class=\"crayon-p\">#include &lt;stdio.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00e3807568408-7\"><span class=\"crayon-p\">#include &lt;stdlib.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00e3807568408-8\"><span class=\"crayon-p\">#define MAP_SIZE 68157440</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00e3807568408-9\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">argc</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00e3807568408-10\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00e3807568408-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fd</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00e3807568408-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00e3807568408-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">fd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shm_open</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"/shm1\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">O_RDWR</span><span class=\"crayon-o\">|</span><span class=\"crayon-v\">O_CREAT</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0644</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00e3807568408-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">fd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00e3807568408-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"shm_open failed\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00e3807568408-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">exit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00e3807568408-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00e3807568408-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00e3807568408-19\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0020 seconds] -->\r\n<p><i># ./shmopen# ls -lh /dev/shm/shm1</i></p>\n<p>-rw-r–r– 1 root root 65M Mar  3 06:19 /dev/shm/shm1</p>\n<p>仅管/dev/shm只有64M,但创建65M的POSIX SM也可以成功。</p>\n<h3><b>(4)向POSIX SM写数据</b></h3>\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59600667b00f2903133511\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n/*gcc -o shmwrite shmwrite.c -lrt*/#include &lt;unistd.h&gt;\r\n#include &lt;fcntl.h&gt;\r\n#include &lt;sys/stat.h&gt;\r\n#include &lt;sys/types.h&gt;\r\n#include &lt;sys/mman.h&gt;\r\n#include &lt;stdio.h&gt;\r\n#include &lt;stdlib.h&gt;\r\n#define MAP_SIZE 68157440\r\nint main(int argc, char *argv[])\r\n{\r\n    int fd;\r\n    void* result;\r\n    fd = shm_open(\"/shm1\", O_RDWR|O_CREAT, 0644);\r\n    if(fd &lt; 0){\r\n         printf(\"shm_open failed\\n\");\r\n         exit(1);\r\n    }\r\n    if (ftruncate(fd, MAP_SIZE) &lt; 0){\r\n        printf(\"ftruncate failed\\n\");\r\n        exit(1);\r\n    }\r\n    result = mmap(NULL, MAP_SIZE, PROT_READ|PROT_WRITE, MAP_SHARED, fd, 0);\r\n    if(result == MAP_FAILED){\r\n        printf(\"mapped failed\\n\");\r\n        exit(1);\r\n    }\r\n    /* ... operate result pointer */\r\n    printf(\"memset\\n\");\r\n    memset(result, 0, MAP_SIZE);\r\n    //shm_unlink(\"/shm1\");\r\n    return 0;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59600667b00f2903133511-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00f2903133511-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00f2903133511-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00f2903133511-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00f2903133511-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00f2903133511-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00f2903133511-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00f2903133511-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00f2903133511-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00f2903133511-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00f2903133511-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00f2903133511-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00f2903133511-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00f2903133511-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00f2903133511-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00f2903133511-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00f2903133511-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00f2903133511-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00f2903133511-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00f2903133511-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00f2903133511-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00f2903133511-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00f2903133511-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00f2903133511-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00f2903133511-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00f2903133511-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00f2903133511-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00f2903133511-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00f2903133511-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00f2903133511-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00f2903133511-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00f2903133511-32\">32</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59600667b00f2903133511-1\"><span class=\"crayon-c\">/*gcc -o shmwrite shmwrite.c -lrt*/</span><span class=\"crayon-p\">#include &lt;unistd.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00f2903133511-2\"><span class=\"crayon-p\">#include &lt;fcntl.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00f2903133511-3\"><span class=\"crayon-p\">#include &lt;sys/stat.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00f2903133511-4\"><span class=\"crayon-p\">#include &lt;sys/types.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00f2903133511-5\"><span class=\"crayon-p\">#include &lt;sys/mman.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00f2903133511-6\"><span class=\"crayon-p\">#include &lt;stdio.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00f2903133511-7\"><span class=\"crayon-p\">#include &lt;stdlib.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00f2903133511-8\"><span class=\"crayon-p\">#define MAP_SIZE 68157440</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00f2903133511-9\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">argc</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00f2903133511-10\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00f2903133511-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fd</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00f2903133511-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00f2903133511-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">fd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shm_open</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"/shm1\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">O_RDWR</span><span class=\"crayon-o\">|</span><span class=\"crayon-v\">O_CREAT</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0644</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00f2903133511-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">fd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00f2903133511-15\"><span class=\"crayon-h\">         </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"shm_open failed\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00f2903133511-16\"><span class=\"crayon-h\">         </span><span class=\"crayon-e\">exit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00f2903133511-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00f2903133511-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">ftruncate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">fd</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAP_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00f2903133511-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"ftruncate failed\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00f2903133511-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">exit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00f2903133511-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00f2903133511-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">mmap</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAP_SIZE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PROT_READ</span><span class=\"crayon-o\">|</span><span class=\"crayon-v\">PROT_WRITE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAP_SHARED</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fd</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00f2903133511-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAP_FAILED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00f2903133511-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"mapped failed\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00f2903133511-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">exit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00f2903133511-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00f2903133511-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* ... operate result pointer */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00f2903133511-28\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"memset\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00f2903133511-29\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">memset</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAP_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00f2903133511-30\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">//shm_unlink(\"/shm1\");</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00f2903133511-31\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00f2903133511-32\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0038 seconds] -->\r\n<p><i># ./shmwrite</i></p>\n<p>memset</p>\n<p>Bus error</p>\n<p>可以看到，写65M的数据会报Bus error错误。</p>\n<p>但是，却可以在/dev/shm创建新的文件：</p>\n<p><i># ls -lh /dev/shm/ -lh</i></p>\n<p>总用量 64M</p>\n<p>-rw-r–r– 1 root root 65M 3月   3 15:23 shm1</p>\n<p>-rw-r–r– 1 root root 65M 3月   3 15:24 shm2</p>\n<p>这很正常，ls显示的是inode-&gt;size。</p>\n<p><i># stat /dev/shm/shm2</i></p>\n<p>File: “/dev/shm/shm2”</p>\n<p>Size: 68157440        Blocks: 0          IO Block: 4096   普通文件</p>\n<p>Device: 10h/16d Inode: 217177      Links: 1</p>\n<p>Access: (0644/-rw-r–r–)  Uid: (    0/    root)   Gid: (    0/    root)</p>\n<p>Access: 2015-03-03 15:24:28.025985167 +0800</p>\n<p>Modify: 2015-03-03 15:24:28.025985167 +0800</p>\n<p>Change: 2015-03-03 15:24:28.025985167 +0800</p>\n<h3><b>(5)向SYS V共享内存写数据</b><b></b></h3>\n<p>将System V共享内存的最大值调整为65M(/dev/shm仍然为64M)。</p>\n<p><i># cat /proc/sys/kernel/shmmax</i></p>\n<p>68157440</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59600667b00fb113466225\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n/*gcc -o shmv shmv.c*/#include &lt;sys/ipc.h&gt;\r\n#include &lt;sys/shm.h&gt;\r\n#include &lt;sys/types.h&gt;\r\n#include &lt;unistd.h&gt;\r\n#define MAP_SIZE 68157440\r\nint main(int argc, char** argv){\r\n    int shm_id,i;\r\n    key_t key;\r\n    char temp;\r\n    char *p_map;\r\n    char* name = \"/dev/shm/shm3\";\r\n    key = ftok(name,0);\r\n    if(key==-1)\r\n        perror(\"ftok error\");\r\n    shm_id=shmget(key,MAP_SIZE,IPC_CREAT);\r\n    if(shm_id==-1)\r\n    {\r\n        perror(\"shmget error\");\r\n        return;\r\n    }\r\n    p_map=(char*)shmat(shm_id,NULL,0);\r\n    memset(p_map, 0, MAP_SIZE);\r\n    if(shmdt(p_map)==-1)\r\n        perror(\" detach error \");\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59600667b00fb113466225-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00fb113466225-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00fb113466225-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00fb113466225-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00fb113466225-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00fb113466225-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00fb113466225-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00fb113466225-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00fb113466225-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00fb113466225-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00fb113466225-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00fb113466225-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00fb113466225-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00fb113466225-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00fb113466225-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00fb113466225-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00fb113466225-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00fb113466225-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00fb113466225-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00fb113466225-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00fb113466225-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00fb113466225-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00fb113466225-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b00fb113466225-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-59600667b00fb113466225-25\">25</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59600667b00fb113466225-1\"><span class=\"crayon-c\">/*gcc -o shmv shmv.c*/</span><span class=\"crayon-p\">#include &lt;sys/ipc.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00fb113466225-2\"><span class=\"crayon-p\">#include &lt;sys/shm.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00fb113466225-3\"><span class=\"crayon-p\">#include &lt;sys/types.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00fb113466225-4\"><span class=\"crayon-p\">#include &lt;unistd.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00fb113466225-5\"><span class=\"crayon-p\">#define MAP_SIZE 68157440</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00fb113466225-6\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">argc</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00fb113466225-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">shm_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00fb113466225-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">key_t </span><span class=\"crayon-v\">key</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00fb113466225-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00fb113466225-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">p_map</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00fb113466225-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">char</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">name</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"/dev/shm/shm3\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00fb113466225-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">key</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ftok</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00fb113466225-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">key</span><span class=\"crayon-o\">==</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00fb113466225-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">perror</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"ftok error\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00fb113466225-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">shm_id</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">shmget</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">key</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">MAP_SIZE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">IPC_CREAT</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00fb113466225-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">shm_id</span><span class=\"crayon-o\">==</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00fb113466225-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00fb113466225-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">perror</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"shmget error\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00fb113466225-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00fb113466225-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00fb113466225-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p_map</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">char</span><span class=\"crayon-o\">*</span><span class=\"crayon-sy\">)</span><span class=\"crayon-e\">shmat</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">shm_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00fb113466225-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">memset</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p_map</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAP_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00fb113466225-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">shmdt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p_map</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">==</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b00fb113466225-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">perror</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\" detach error \"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b00fb113466225-25\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0033 seconds] -->\r\n<p><i>#./shmv</i></p>\n<p>却可以正常执行。</p>\n<h3><b>(7)结论</b><b></b></h3>\n<p>虽然System V与POSIX共享内存都是通过tmpfs实现，但是受的限制却不相同。也就是说/proc/sys/kernel/shmmax只会影响SYS V共享内存，/dev/shm只会影响Posix共享内存。<b>实际上，System V与Posix共享内存本来就是使用的两个不同的tmpfs实例(instance)</b>。</p>\n<h2><b>内核分析</b><b></b></h2>\n<p>内核在初始化时，会自动mount一个tmpfs文件系统，挂载为shm_mnt：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59600667b0101836562852\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n//mm/shmem.cstatic struct file_system_type \r\nshmem_fs_type = {\r\n    .owner = THIS_MODULE,\r\n   .name = \"tmpfs\",\r\n    .get_sb = shmem_get_sb,\r\n    .kill_sb = kill_litter_super,\r\n};\r\n\r\nint __init shmem_init(void) {\r\n    ...\r\n    error = register_filesystem(&amp;shmem_fs_type);\r\n    if (error) \r\n    {\r\n        printk(KERN_ERR \"Could not register tmpfs\\n\");\r\n        goto out2;\r\n    }\r\n    ///挂载tmpfs(用于SYS V) \r\n    shm_mnt = vfs_kern_mount(&amp;shmem_fs_type, MS_NOUSER,shmem_fs_type.name, NULL);</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59600667b0101836562852-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0101836562852-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0101836562852-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0101836562852-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0101836562852-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0101836562852-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0101836562852-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0101836562852-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0101836562852-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0101836562852-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0101836562852-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0101836562852-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0101836562852-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0101836562852-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0101836562852-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0101836562852-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0101836562852-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0101836562852-18\">18</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59600667b0101836562852-1\"><span class=\"crayon-c\">//mm/shmem.cstatic struct file_system_type </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0101836562852-2\"><span class=\"crayon-v\">shmem_fs_type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0101836562852-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">owner</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">THIS_MODULE</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0101836562852-4\"><span class=\"crayon-h\">   </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">name</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"tmpfs\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0101836562852-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">get_sb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">shmem_get_sb</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0101836562852-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">kill_sb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">kill_litter_super</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0101836562852-7\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0101836562852-8\"> </div><div class=\"crayon-line\" id=\"crayon-59600667b0101836562852-9\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__init </span><span class=\"crayon-e\">shmem_init</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">void</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0101836562852-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0101836562852-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">register_filesystem</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">shmem_fs_type</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0101836562852-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-59600667b0101836562852-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0101836562852-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">KERN</span><span class=\"crayon-sy\">_</span>ERR<span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Could not register tmpfs\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0101836562852-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">out2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0101836562852-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0101836562852-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">///挂载tmpfs(用于SYS V) </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0101836562852-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">shm_mnt</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">vfs_kern_mount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">shmem_fs_type</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MS_NOUSER</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">shmem_fs_type</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0024 seconds] -->\r\n<p>/dev/shm的mount与普通文件mount的流程类似，不再讨论。但是，<b>值得注意的是，/dev/shm默认的大小为当前物理内存的1/2</b>：</p>\n<p>shmem_get_sb –&gt; shmem_fill_super</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59600667b0105399665662\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n//mem/shmem.c\r\nint shmem_fill_super(struct super_block *sb, void *data, int silent)\r\n{\r\n    ...\r\n#ifdef CONFIG_TMPFS \r\n/*\r\n* Per default we only allow half of the physical ram per\r\n* tmpfs instance, limiting inodes to one per page of lowmem;\r\n* but the internal instance is left unlimited.\r\n*/\r\n    if (!(sb-&gt;s_flags &amp; MS_NOUSER)) {///内核会设置MS_NOUSER \r\n        sbinfo-&gt;max_blocks = shmem_default_max_blocks();\r\n        sbinfo-&gt;max_inodes = shmem_default_max_inodes();\r\n        if (shmem_parse_options(data, sbinfo, false)) {\r\n            err = -EINVAL;\r\n            goto failed;\r\n        }\r\n    }\r\n    sb-&gt;s_export_op = &amp;shmem_export_ops;\r\n#else\r\n...\r\n\r\n#ifdef CONFIG_TMPFS\r\nstatic unsigned long shmem_default_max_blocks(void) {\r\n    return totalram_pages / 2;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59600667b0105399665662-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0105399665662-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0105399665662-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0105399665662-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0105399665662-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0105399665662-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0105399665662-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0105399665662-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0105399665662-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0105399665662-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0105399665662-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0105399665662-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0105399665662-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0105399665662-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0105399665662-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0105399665662-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0105399665662-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0105399665662-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0105399665662-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0105399665662-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0105399665662-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0105399665662-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0105399665662-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0105399665662-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0105399665662-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0105399665662-26\">26</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59600667b0105399665662-1\"><span class=\"crayon-c\">//mem/shmem.c</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0105399665662-2\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_fill_super</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">super_block *</span><span class=\"crayon-v\">sb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">silent</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0105399665662-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0105399665662-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0105399665662-5\"><span class=\"crayon-p\">#ifdef CONFIG_TMPFS </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0105399665662-6\"><span class=\"crayon-c\">/*</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0105399665662-7\"><span class=\"crayon-c\">* Per default we only allow half of the physical ram per</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0105399665662-8\"><span class=\"crayon-c\">* tmpfs instance, limiting inodes to one per page of lowmem;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0105399665662-9\"><span class=\"crayon-c\">* but the internal instance is left unlimited.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0105399665662-10\"><span class=\"crayon-c\">*/</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0105399665662-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">s_flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MS_NOUSER</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-c\">///内核会设置MS_NOUSER </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0105399665662-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">max_blocks</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_default_max_blocks</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0105399665662-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">max_inodes</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_default_max_inodes</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0105399665662-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">shmem_parse_options</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0105399665662-15\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">EINVAL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0105399665662-16\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">failed</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0105399665662-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0105399665662-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0105399665662-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">sb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">s_export_op</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">shmem_export_ops</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0105399665662-20\"><span class=\"crayon-p\">#else</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0105399665662-21\"><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0105399665662-22\"> </div><div class=\"crayon-line\" id=\"crayon-59600667b0105399665662-23\"><span class=\"crayon-p\">#ifdef CONFIG_TMPFS</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0105399665662-24\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_default_max_blocks</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">void</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0105399665662-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">totalram_pages</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0105399665662-26\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0030 seconds] -->\r\n<p>可以看到：由于内核在mount tmpfs时，指定了MS_NOUSER，所以该tmpfs没有大小限制，因此，SYS V共享内存能够使用的内存空间只受/proc/sys/kernel/shmmax限制；而用户通过挂载的/dev/shm，默认为物理内存的1/2。</p>\n<p>注意CONFIG_TMPFS.</p>\n<p>另外，在/dev/shm创建文件走VFS接口，而SYS V与匿名映射却是通过shmem_file_setup实现：</p>\n<h2><b>SIGBUS</b><b></b></h2>\n<p>当应用访问共享内存对应的地址空间，如果对应的物理PAGE还没有分配，就会调用fault方法，分配失败，就会返回OOM或者BIGBUS错误：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59600667b0108915831101\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic const struct vm_operations_struct shmem_vm_ops = {\r\n    .fault = shmem_fault,\r\n#ifdef CONFIG_NUMA \r\n    .set_policy = shmem_set_policy,\r\n    .get_policy = shmem_get_policy,\r\n#endif\r\n};\r\n\r\nstatic int shmem_fault(struct vm_area_struct *vma, struct vm_fault *vmf)\r\n{\r\n    struct inode *inode = vma-&gt;vm_file-&gt;f_path.dentry-&gt;d_inode;\r\n    int error;\r\n    int ret = VM_FAULT_LOCKED;\r\n    error = shmem_getpage(inode, vmf-&gt;pgoff, &amp;vmf-&gt;page, SGP_CACHE, &amp;ret);\r\n    if (error)\r\n        return ((error == -ENOMEM) ? VM_FAULT_OOM : VM_FAULT_SIGBUS);\r\n    return ret;\r\n}\r\n\r\nshmem_getpage –&gt; shmem_getpage_gfp：\r\n/*\r\n * shmem_getpage_gfp - find page in cache, or get from swap, or allocate\r\n *\r\n * If we allocate a new one we do not mark it dirty. That\'s up to the\r\n * vm. If we swap it in we mark it dirty since we also free the swap\r\n * entry since a page cannot live in both the swap and page cache\r\n */\r\nstatic int shmem_getpage_gfp(struct inode *inode, pgoff_t index,\r\nstruct page **pagep, enum sgp_type sgp, gfp_t gfp, int *fault_type) \r\n{\r\n    ...\r\n    if (sbinfo-&gt;max_blocks) { ///dev/shm会有该值 \r\n        if (percpu_counter_compare(&amp;sbinfo-&gt;used_blocks,sbinfo-&gt;max_blocks) &gt;= 0) {\r\n            error = -ENOSPC;\r\n            goto unacct;\r\n        }\r\n    percpu_counter_inc(&amp;sbinfo-&gt;used_blocks);\r\n    }\r\n    //分配一个物理PAGE\r\n    page = shmem_alloc_page(gfp, info, index);\r\n    if (!page) {\r\n        error = -ENOMEM;\r\n        goto decused;\r\n    }\r\n    SetPageSwapBacked(page);\r\n    __set_page_locked(page);\r\n    error = mem_cgroup_cache_charge(page, current-&gt;mm,gfp &amp; GFP_RECLAIM_MASK); ///mem_cgroup检查\r\nif (!error)\r\n    error = shmem_add_to_page_cache(page, mapping, index, gfp, NULL);</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600667b0108915831101-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-59600667b0108915831101-49\">49</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">vm_operations_struct </span><span class=\"crayon-v\">shmem_vm_ops</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-2\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">fault</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">shmem_fault</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-3\"><span class=\"crayon-p\">#ifdef CONFIG_NUMA </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">set_policy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">shmem_set_policy</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">get_policy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">shmem_get_policy</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-6\"><span class=\"crayon-p\">#endif</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-7\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-8\"> </div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-9\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_fault</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">vm_area_struct *</span><span class=\"crayon-v\">vma</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">vm_fault *</span><span class=\"crayon-v\">vmf</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-10\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">inode *</span><span class=\"crayon-v\">inode</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vma</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">vm_file</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">f_path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">dentry</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">d_inode</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ret</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">VM_FAULT_LOCKED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_getpage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">inode</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vmf</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">pgoff</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">vmf</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SGP_CACHE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">ret</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">ENOMEM</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">VM_FAULT_OOM</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">VM_FAULT_SIGBUS</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ret</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-18\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-19\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-20\"><span class=\"crayon-v\">shmem</span><span class=\"crayon-sy\">_</span>getpage<span class=\"crayon-h\"> </span>–<span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">shmem_getpage</span><span class=\"crayon-sy\">_</span>gfp：</div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-21\"><span class=\"crayon-c\">/*</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-22\"><span class=\"crayon-c\"> * shmem_getpage_gfp - find page in cache, or get from swap, or allocate</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-23\"><span class=\"crayon-c\"> *</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-24\"><span class=\"crayon-c\"> * If we allocate a new one we do not mark it dirty. That\'s up to the</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-25\"><span class=\"crayon-c\"> * vm. If we swap it in we mark it dirty since we also free the swap</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-26\"><span class=\"crayon-c\"> * entry since a page cannot live in both the swap and page cache</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-27\"><span class=\"crayon-c\"> */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-28\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_getpage_gfp</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">inode *</span><span class=\"crayon-v\">inode</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">pgoff_t </span><span class=\"crayon-v\">index</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-29\"><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">page *</span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">pagep</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">enum</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sgp_type </span><span class=\"crayon-v\">sgp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">gfp_t </span><span class=\"crayon-v\">gfp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">fault_type</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-30\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-31\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-32\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">max_blocks</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">///dev/shm会有该值 </span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-33\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">percpu_counter_compare</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">used_blocks</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">max_blocks</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-34\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">ENOSPC</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-35\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">unacct</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-36\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-37\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">percpu_counter_inc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">used_blocks</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-38\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-39\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">//分配一个物理PAGE</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-40\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">page</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_alloc_page</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">gfp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">info</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">index</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-41\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-42\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">ENOMEM</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-43\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">decused</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-44\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-45\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">SetPageSwapBacked</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-46\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">__set_page_locked</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-47\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">mem_cgroup_cache_charge</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">current</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">mm</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">gfp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">GFP_RECLAIM_MASK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">///mem_cgroup检查</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600667b0108915831101-48\"><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-59600667b0108915831101-49\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_add_to_page_cache</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mapping</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">index</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gfp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0075 seconds] -->\r\n<p></p>\n<h2><b>共享内存与CGROUP</b><b></b></h2>\n<p>目前，共享内存的空间计算在第一个访问共享内存的group，参考：</p>\n<p>l http://lwn.net/Articles/516541/</p>\n<p>l https://www.kernel.org/doc/Documentation/cgroups/memory.txt</p>\n<h2><b>POSIX共享内存与Docker</b><b></b></h2>\n<p>目前Docker将/dev/shm限制为64M，却没有提供参数，这种做法比较糟糕。如果应用使用大内存的POSIX共享内存，必然会导致问题。 参考:</p>\n<p>l https://github.com/docker/docker/issues/2606</p>\n<p>l https://github.com/docker/docker/pull/4981</p>\n<h2><b>总结</b><b></b></h2>\n<p>(1)POSIX共享内存与SYS V共享内存在内核都是通过tmpfs实现，但对应两个不同的tmpfs实例，相互独立。</p>\n<p>(2)通过/proc/sys/kernel/shmmax可以限制SYS V共享内存(单个)的最大值，通过/dev/shm可以限制POSIX共享内存的最大值(所有之和)。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111665\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111665votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111665\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>');
